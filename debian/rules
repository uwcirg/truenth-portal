#!/usr/bin/make -f
# Makefile used by dpkg-buildpackage

# dh-virtualenv options
# https://dh-virtualenv.readthedocs.io/en/1.0/usage.html
DH_VIRTUALENV_ARGS = --preinstall='pip>=8' --preinstall='setuptools>=12' --extra-pip-arg='--progress-bar=off'

VENV_DIR = '$(PWD)/debian/portal/opt/venvs'

distclean:
	rm -Rf build debian/portal/ env

override_dh_virtualenv:
	# lines preceding `dh_virtualenv` occur before venv creation and pip install

	# Build front-end translations (JSON) from gettext files (PO)
	bin/build-frontend-translations.sh

	# Remove self-referential requirement
	# Otherwise a .egg-link file is created instead of actually installing portal module in site-packages/
	sed -i '/-e ./d' requirements.txt


	dh_virtualenv $(DH_VIRTUALENV_ARGS)

override_dh_builddeb:
	# lines preceding `dh_builddeb` occur after venv creation && `pip install`
	# but before debian package creation

	# Manually fix paths erroneously pointing to build environment
	find \
		'$(VENV_DIR)/portal/lib/' \
		-name easy-install.pth \
		-exec \
			sed \
				--in-place \
				--expression 's|$(VENV_DIR)/|/opt/venvs/|g' \
				{} \; \
		-print

	# compile all back-end PO files to MO files
	FLASK_APP='$(VENV_DIR)/portal/bin/manage.py' \
	SECRET_KEY='' \
	PATH='$(VENV_DIR)/portal/bin' \
		python -m flask compile-po-files


	dh_builddeb

%:
	dh $@ --with python-virtualenv
