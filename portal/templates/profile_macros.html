{% from "initial_queries_macros.html" import patientQGroup, consent_fields %}

{% macro profileImage(person) -%}
    {% if person and person.image_url %}
        <div class="profile-img hidden-xs">
            <img src="{{ person and person.image_url }}" />
        </div>
    {% endif %}
{%- endmacro %}

{% macro profileBirthDate(person) -%}
    <input type="hidden" name="birthDate" id="birthday" value="{{ person and person.birthdate if person.birthdate }}" />
    <div class="form-group profile-section" id="bdGroup">
        <label class="profile-birthdate-label">{{ _("Birth Date") }}</label>
        <div class="flex">
            <div class="flex-item" id="bdDateContainer" data-loader-container="true">
                <input class="form-control bd-element" id="date" name="birthdayDate" placeholder="DD" type="text" pattern="(\d)?\d" maxlength="2" data-error="{{_('Birth date must be valid and in the required format.')}}" data-error-field="errorbirthday" autocomplete="off" data-trigger-event="change" required />
            </div>
            <div class="flex-item" id="bdMonthContainer" data-loader-container="true">
                <select class="form-control bd-element" name="birthdayMonth" id="month" data-error="{{_('Birth date must be valid and in the required format.')}}" data-error-field="errorbirthday" data-trigger-event="change" required>
                    <option value="">{{ _("Month") }}...</option>
                    <option value="01">{{ _("January") }}</option>
                    <option value="02">{{ _("February") }}</option>
                    <option value="03">{{ _("March") }}</option>
                    <option value="04">{{ _("April") }}</option>
                    <option value="05">{{ _("May") }}</option>
                    <option value="06">{{ _("June") }}</option>
                    <option value="07">{{ _("July") }}</option>
                    <option value="08">{{ _("August") }}</option>
                    <option value="09">{{ _("September") }}</option>
                    <option value="10">{{ _("October") }}</option>
                    <option value="11">{{ _("November") }}</option>
                    <option value="12">{{ _("December") }}</option>
                </select>
            </div>
            <div class="flex-item" id="bdYearContainer" data-loader-container="true">
                <input class="form-control bd-element" id="year" name="birthdayYear" placeholder="YYYY" pattern = "(19|20)\d{2}" type="text" maxlength="4" data-error="{{_('Birth date must be valid and in the required format.')}}" data-error-field="errorbirthday" data-trigger-event="change" autocomplete="off" required />
            </div>
        </div>
        <div class="help-block with-errors"></div>
        <span id="errorbirthday" class="help-block error-message"></span>
     </div>
     <script>
        $(function () {// Fill in 3 birthday fields based on existing value - requires date format YYYY-MM-DD
            var currentBd = $("#birthday").val();
            if (currentBd) {
                var bdArray = currentBd.split("-");
                $("#year").val(bdArray[0]);
                $("#month").val(bdArray[1]);
                $("#date").val(bdArray[2]);
            };
            $("#month").on("change", function() {
                $(this).trigger("focusout");
            });
            ["year", "month", "date"].forEach(function(fn) {
                var field = $("#" + fn);
                var triggerEvent = field.attr("type") == "text" ? "blur" : "change";
                field.on(triggerEvent, function() {
                    var y = $("#year"), m = $("#month"), d = $("#date");
                    if (hasValue(y.val()) && hasValue(m.val()) && hasValue(d.val())) {
                        if (y.get(0).validity.valid && m.get(0).validity.valid && d.get(0).validity.valid) {
                            var isValid = tnthDates.validateDateInputFields(m.val(), d.val(), y.val(), "errorbirthday");
                            if (isValid) {
                                $("#birthday").val(y.val() + "-" + m.val() + "-" + d.val());
                                $("#errorbirthday").html("");
                            } else {
                                $("#birthday").val("");
                                return false;
                            };
                        };
                    } else return false;
                });
            });
           __convertToNumericField($("#date, #year"));
        });
     </script>
{%- endmacro %}

{% macro profileLocale(person) -%}
    <div id="localeGroup" class="form-group float-input-label profile-section timezone-container flex-item" data-loader-container="true">
        <label for="locale">{{ _("Language") }}</label>
        <select class="form-control" name="locale" id="locale">
          {%- if (person and ("en_US" in person.locale_display_options)) or config.get("DEFAULT_LOCALE") == "en_US" -%}
          <option value="en_US" {{ "selected" if ((person and person.locale_code == "en_US") or ((not person or not person.locale_code) and config.get("DEFAULT_LOCALE") == "en_US")) }}>{{ _("American English") }}{{(" (" + _("Default") + ")") if config.get("DEFAULT_LOCALE") == "en_US" }}</option>
          {%- endif -%}
          {%- if (person and ("en_AU" in person.locale_display_options)) or config.get("DEFAULT_LOCALE") == "en_AU" -%}
          <option value="en_AU" {{ "selected" if ((person and person.locale_code == "en_AU") or ((not person or not person.locale_code) and config.get("DEFAULT_LOCALE") == "en_AU")) }}>{{ _("Australian English") }}{{(" (" + _("Default") + ")") if config.get("DEFAULT_LOCALE") == "en_AU" }}</option>
          {%- endif -%}
        </select>
        <input type="hidden" id="sys_default_locale" value="{{config.get('DEFAULT_LOCALE')}}" />
        <div class="get-demo-error get-locale-error error-message"></div>
        <div class="put-demo-error error-message"></div>
     </div>
     <script>$(function () {
        $('#locale').on('change', function() {
            setTimeout(function(){
                window.location.reload(true);
            },1000);
        });
     });</script>
{%- endmacro %}

{% macro profileName(person, isFocus=False) -%}
    <div class="form-group profile-name-label"><label>{{ _("Name") }}</label></div>
    <div class="row profile-section name-section">
        <div id="firstNameContainer" class="col-lg-4 col-md-5 col-sm-6 col-xs-12 first-name-container" data-loader-container="true">
            <div id="firstNameGroup" class="form-group float-input-label">
                <input {{"autofocus" if isFocus}} required="required" data-error="{{ _('First name is required and must not contain invalid characters.') }}" class="form-control float-text" id="firstname" name="firstname" placeholder="{{ _('First Name') }}" value="{{ person.first_name if person and person.first_name }}" type="text"  autocomplete="off" data-htmltags="true" data-error-field="errorfirstname"/>
                <div class="help-block with-errors"></div>
                <div id="errorfirstname" class="error-message"></div>
            </div>
        </div>
        <div id="lastNameContainer" class="col-lg-5 col-md-6 col-sm-6 col-xs-12 last-name-container" data-loader-container="true">
            <div id="lastNameGroup" class="form-group float-input-label">
                <input required="required" data-error="{{ _('Last name is required and must not contain invalid characters.') }}" class="form-control float-text" id="lastname" name="lastname" placeholder="{{ _('Last Name') }}" value="{{ person.last_name if person and person.last_name }}" type="text" autocomplete="off" data-error-field="errorlastname" data-htmltags="true"/>
                <div class="help-block with-errors"></div>
                <div id="errorlastname" class="error-message"></div>
            </div>
        </div>
    </div>
{%- endmacro %}

{% macro profileGender(person) -%}
    <div class="form-group profile-section flex-item" id="genderGroup">
        <label id="genderLabel">{{ _("Gender") }}</label>
        <div id="profile-gender-list" class="profile-radio-list" data-loader-container="true">
            <label class="radio-inline">
                <input type="radio" name="sex" id="sexM" value="male" required {{ "checked" if person and person.gender == "male"}}/>
                {{ _("Male") }}
            </label>
            <label class="radio-inline">
                <input type="radio" name="sex" id="sexF" value="female" required {{ "checked" if person and person.gender == "female"}}/>
                {{ _("Female") }}
            </label>
            <label class="radio-inline">
                <input type="radio" name="sex" id="sexO" value="other" required {{ "checked" if person and person.gender == "other"}}/>
                {{ _("Other") }}
            </label>
        </div>
    </div>
{%- endmacro %}

{% macro profileIndigenous(person) -%}
    {%- if person and person.org_coding_display_options.indigenous -%}
        <div id="userIndigenousStatusContainer" data-section-id="indigenous" class="flex-item"></div>
        <script>
        $(function () {
            (function() {
                $.ajax({
                    type:"GET",
                    url: '/fhir/valueset/AU-NHHD-METeOR-id-291036'
                }).done(function(data) {
                    var as = data["codeSystem"]["concept"];
                    var html = '<div class="form-group profile-section" id="userIndigenousStatus">' +
                    '<label>{{ _("Indigenous Status") }}</label>' +'<div class="profile-radio-list">';
                    as.forEach(function(o) {
                        html += '<div>' +
                                '<input type="radio" name="indigenous" value="' + o.code + '"><label>{%trans%}' + o.display + '{%endtrans%}</label></div>';
                    });
                    html += "</div></div>";
                    $("#userIndigenousStatusContainer").html(html);
                    getSaveLoaderDiv("profileForm", "userIndigenousStatus");
                    $("#userIndigenousStatusContainer input[type='radio']").each(function() {
                        $(this).attr("data-save-container-id", "userIndigenousStatus");
                        $(this).on("click", function() {
                            assembleContent.demo({{ person.id if person }},true, $(this));
                        });
                    });
                }).fail(function(){
                    console.log("Problem retrieiving indigenous statuses");
                });
            })();
        });
        </script>
    {%- endif -%}
{%- endmacro %}

{% macro profileRace(person) -%}
    {%- if person and person.org_coding_display_options.race -%}
        <div class="form-group profile-section flex-item optional" data-section-id="race" id="userRace" data-loader-container="true">
            <label>{{ _("Race") }}</label>
            <div class="profile-radio-list">
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name="race" value="1002-5">{{ _("American Indian or Alaska Native") }}
                    </label>
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name="race" value="2028-9">{{ _("Asian") }}
                    </label>
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name="race" value="2054-5">{{ _("Black or African American") }}
                    </label>
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name="race" value="2076-8">{{ _("Native Hawaiian or Other Pacific Islander") }}
                    </label>
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name="race" value="2106-3">{{ _("White") }}
                    </label>
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name="race" value="2131-1">{{ _("Other") }}
                    </label>
                </div>
            </div>
        </div>
    {%- endif -%}
{%- endmacro %}

{% macro profileEthnicity(person) -%}
    {%- if person and person.org_coding_display_options.ethnicity -%}
        <div class="form-group profile-section flex-item optional" data-section-id="ethnicity" data-loader-container="true" id="userEthnicity">
            <label>{{ _("Ethnicity") }}</label>
            <div class="profile-radio-list">
                <div class="radio">
                    <label>
                        <input type="radio" name="ethnicity" value="2135-2">{{ _("Hispanic or Latino") }}
                    </label>
                </div>
                <div class="radio">
                    <label>
                        <input type="radio" name="ethnicity" value="2186-5">{{ _("Not Hispanic or Latino") }}
                    </label>
                </div>
            </div>
        </div>
    {%- endif -%}
{%- endmacro %}

{% macro profileEmail(person) -%}
    <div class="form-group float-input-label profile-section" id="emailGroup" data-error-field="erroremail" data-loader-container="true">
        <label for="email">{{ _("Email Address") }}</label>
        <input type="text" class="form-control" id="email" name="email" data-save-container-id="emailGroup" placeholder="{{ _('Email Address') }}" value="{{ person.email if person and person.email and person.email != '__no_email__' }}" data-customemail="true" data-error-field="erroremail" required />
        <div class="help-block with-errors" id="erroremail"></div>
    </div>
    <script>
    function checkEmail(email) {
        if (hasValue(email)) {
            $("#btnPasswordResetEmail").attr("disabled", false);
            $("#btnProfileSendEmail").attr("disabled", false);
            $('#btnProfileSendEmail').removeClass('disabled');
        } else {
            if ($("#email").get(0).validity.valid) {
                $("#btnPasswordResetEmail").attr("disabled", true);
                $("#btnProfileSendEmail").attr("disabled", true);
                $('#btnProfileSendEmail').addClass('disabled');
            };
        };
    };
    $(function() {
        checkEmail($("#email").val());
        $("#email").on("blur, keyup", function() {
            checkEmail($(this).val());
            if ($(this).val() != "") $("#profileEmailSelect").attr("disabled", false);
            else $("#profileEmailSelect").val("").attr("disabled", true);
        });
        //in profile email is validated and updated after ajax call to check unique email
        {% if person %}
            $("#email").attr("data-update-on-validated", "true").attr("data-user-id", '{{person.id}}');
        {% endif %}
        $("#btnProfileSendEmail").blur();
    });</script>
{%- endmacro %}

{% macro profileEmailForm(person, invite_email) -%}
    {%- if person -%}
    <div id="sendEmailForm">
        <input type="hidden" name="_userId" id="_userId" value="{{person.id}}" />
        <div class="registration-status-container">
            <span class="text-muted">{{_('Registration status:')}}</span>
            {% if person and person.has_role("write_only") %}<h4 class="text-warning registration-label">{{_('not yet registered')}}</h4>
            {%- else -%}
            <h4 class="text-success registration-label">{{_('registered')}}</h4>
            {%- endif -%}
        </div>
        <label id="sendEmailLabel" class="text-muted">{{ _("Send email to ")}}{%- if person and person.has_role(ROLE.PATIENT)-%}{{_('patient')}}{%-else-%}{{_('user')}}{%-endif-%}</label>
        <select  id="profileEmailSelect" class="form-control bd-element">
            <option value="">{{ _("Select Email...") }}</option>
            {%- if person.has_role('write_only') %}<option value="invite">{{ app_text('profileSendEmail option invite') }}</option>{%- endif %}
            <option value="reminder">{{ app_text('profileSendEmail option reminder') }}</option>
        </select>
        <button id="btnProfileSendEmail" class="btn btn-tnth-primary disabled" type="button">{{ _("Send email") }}</button>
        <div id="profileEmailMessage" class="text-info"></div>
        <div id="profileEmailErrorMessage" class="text-danger"></div>
    </div>
    <script>$(function () {
        function getAccessUrl() {
            var url = '';
            $.ajax ({
                type: 'GET',
                url: '/api/user/' + $("#_userId").val() + '/access_url',
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                cache: false,
                async: false
            }).done(function(data) {
                url = data['access_url'];
                $("#profileEmailErrorMessage").text("");
                console.log(url);
            }).fail(function() {
                $("#profileEmailErrorMessage").text("{%trans%}failed request to get email invite url.{%endtrans%}");
            });
            return url;
        };
        if (!hasValue($("#email").val())) $("#profileEmailSelect").attr("disabled", true);

        $('#profileEmailSelect').on('change', function() {
            var message = '';
            if (this.value != '' && $("#email").val() != "" && $("#erroremail").text() == "") {
                message =  $(this).children('option:selected').text() + ' email will be sent to ' + $('#email').val();
                $('#profileEmailMessage').html(message);
                $('#btnProfileSendEmail').removeClass('disabled');
            } else {
                $('#profileEmailMessage').text('');
                $('#btnProfileSendEmail').addClass('disabled');
            }
        });

        $('#btnProfileSendEmail').on('click', function(event) {
            event.preventDefault();
            var emailTypeElem = $('#profileEmailSelect');
            var selectedOption = emailTypeElem.children('option:selected');
            var email = $('#email').val();

            if (selectedOption.val() != '') {
                var subject = '';
                var body = '';
                var return_url = '';
                var parentName = "";
                var selectedOrg = $("#userOrgs input[name='organization']:checked");
                var clinicName = (function() {
                    var cn = "";
                    if (selectedOrg.length > 0 ) cn = selectedOrg.closest("label").text();
                    if (!hasValue(cn)) cn = "{%trans%}your clinic{%endtrans%}";
                    return cn;
                })();
                var parentName = (function() {
                    var pName = "";
                    if (selectedOrg.length > 0) {
                        pName = $(selectedOrg).attr("data-parent-name");
                        if (!hasValue(pName)) pName = $(selectedOrg).closest(".org-container[data-parent-id]").attr("data-parent-name");
                    };
                    return pName;
                })();
                var greeting = (function() {
                    var fname = "";
                    var lname = "";
                    if (!$("#firstNameGroup").hasClass("has-error") && !$("#lastNameGroup").hasClass("has-error")) {
                        fname = $("#firstname").val();
                        lname = $("#lastname").val();
                    } else {
                        $.ajax ({
                            type: "GET",
                            url: '/api/demographics/{{person.id}}',
                            async: false,
                            cache: false
                        }).done(function(data) {
                            if (data && data.name) {
                                fname = data.name.given;
                                lname = data.name.family;
                            };
                        }).fail(function() {
                        });
                    };
                    var txt = "{%trans%}Hello{%endtrans%}";
                    if (hasValue(fname)) txt += " " + fname;
                    if (hasValue(lname)) txt += " " + lname;
                    return txt;
                })();
                if (selectedOption.val() == 'invite'){
                    return_url = getAccessUrl();
                    if (hasValue(return_url)) {
                        {#- javascript variables are not available at template
                           rendering time.  insert a placeholder and then
                           replace once the variable is available. -#}
                        body = '{{ invite_email.body.encode("string-escape") | safe }}';
                        body = body.replace(/url_placeholder/g, decodeURIComponent(return_url));
                        subject = '{{ invite_email.subject }}';
                    };
                }
                else { // reminder
                    body = '{{ app_text('profileSendEmail reminder email_body', url_for('user.login', _external=True, email=person.email)) | safe }}'.replace(/\(clinic name\)/g, clinicName);
                    subject = '{{ app_text('profileSendEmail reminder email_subject') }}'.replace(/\(clinic name\)/g, clinicName);
                }
                if (body != '') {
                    $.ajax ({
                        type: 'POST',
                        url: '/invite',
                        cache: false,
                        contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                        data: {'subject': subject, 'recipients': email, 'body': body}
                    }).done(function(data) {
                        $('#profileEmailMessage').html("<strong class='text-success'>{% trans %}" + selectedOption.text() + ' email sent to ' + email + "{%endtrans%}</strong>");
                        $('#profileEmailSelect').val("");
                        $('#btnProfileSendEmail').addClass('disabled');
                    }).fail(function(xhr) {
                        var errorMessage = "error sending invite email, " + subject + ", status: " + xhr.status + ", response text: " + xhr.responseText;
                        tnthAjax.reportError(this.userId, "{{url_for('portal.invite')}}", errorMessage, true);
                        $('#profileEmailMessage').text('{%trans%}Unable to send email.{%endtrans%}');
                    });
                };
            } else $('#profileEmailMessage').text('{%trans%}You must select a email type.{%endtrans%}');
        });
     });</script>
    {%- endif -%}
{%- endmacro %}
{% macro profileSendEmail(person, invite_email) -%}
    {%- if person -%}
        <div class="form-group float-input-label well well-lg" id="profileSendEmailContainer">{{profileEmailForm(person, invite_email)}}</div>
    {% endif %}
{%- endmacro %}
{% macro profileStaffRegistrationEmail(person) -%}
    {%- if person -%}
    <div id="sendRegistrationEmailForm">
        <input type="hidden" name="_userId" id="_userId" value="{{person.id}}" />
        <div class="registration-status-container">
            <span class="text-muted">{{_('Registration status:')}}</span>
            {% if person and person.has_role("write_only") %}<h4 class="text-warning registration-label">{{_("not yet registered")}}</h4>
            {%- else -%}
            <h4 class="text-success registration-label">{{_('registered')}}</h4>
            {%- endif -%}
        </div>
        <button id="btnProfileSendEmail" class="btn btn-tnth-primary disabled">{{ _("Send registration email") }}</button>
        <div id="profileEmailMessage" class="text-info"></div>
        <div id="profileEmailErrorMessage" class="text-danger"></div>
    </div>
    <script>$(function () {
        function getAccessUrl() {
            var url = '';
            $.ajax ({
                type: 'GET',
                url: '/api/user/' + $("#_userId").val() + '/access_url',
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                async: false
            }).done(function(data) {
                url = data['access_url'];
                $("#profileEmailErrorMessage").text("");
                console.log(url);
            }).fail(function() {
                $("#profileEmailErrorMessage").text("{%trans%}failed request to get email invite url{%endtrans%}");
            });
            return url;
        };
        if (!hasValue($("#email").val())) $("#profileEmailSelect").attr("disabled", true);

        $('#btnProfileSendEmail').on('click', function(event) {
            event.preventDefault();
            var email = $('#email').val();
            var subject = '';
            var body = '';
            var return_url = '';
            var clinicName = (function() {
                var orgs = $("#userOrgs input[name='organization']:checked");
                var parentName = "";
                if (orgs.length > 0 ) {
                    orgs.each(function() {
                        if (!parentName) {
                            parentName = $(this).attr("data-parent-name");
                            if (!hasValue(parentName)) parentName = $(this).closest(".org-container[data-parent-id]").attr("data-parent-name");
                        };
                    });
                };
                var cn = parentName ? parentName: "{%trans%}your clinic{%endtrans%}";
                return cn;
            })();
            return_url = getAccessUrl();
            if (hasValue(return_url)) {
                $.ajax ({
                    type: "GET",
                    url: "{{url_for('portal.staff_registration_email', user_id=person.id)}}",
                    cache: false,
                    async: false
                }).done(function(data) {
                    if (hasValue(data)) {
                        body = data;
                        var fname = "";
                        var lname = "";
                        if (!$("#firstNameGroup").hasClass("has-error") && !$("#lastNameGroup").hasClass("has-error")) {
                            fname = $("#firstname").val();
                            lname = $("#lastname").val();
                        } else {
                            $.ajax ({
                                type: "GET",
                                url: '{{url_for("demographics_api.demographics", patient_id=person.id)}}',
                                async: false,
                                cache: false
                            }).done(function(data) {
                                if (data && data.name) {
                                    fname = data.name.given;
                                    lname = data.name.family;
                                };
                            }).fail(function() {
                            });
                        };
                        body = body.replace(/\(firstname\)/i, fname)
                                   .replace(/\(lastname\)/i, lname)
                                   .replace(/\(registrationlink\)/gi, return_url)

                    };
                }).fail(function(xhr) {
                });

                //provide default body content if no body content was returned from ajax call
                if (!hasValue(body)) {
                    body = "{%trans%}<p>Hello, this is an invitation to complete your registration.</p>{%endtrans%}";
                    body += "<a href='" + decodeURIComponent(return_url) + "'>{%trans%}Verify your account to complete registration{%endtrans%}</a>";
                };

                subject = "{%trans%}Registration invite from {%endtrans%} " + clinicName;
            };

            $.ajax ({
                type: 'POST',
                url: "{{url_for('portal.invite')}}",
                contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                data: {'subject': subject, 'recipients': email, 'body': body}
            }).done(function(data) {
                $('#profileEmailMessage').text('{%trans%}invite email sent to {%endtrans%}' + email);
            }).fail(function() {
                $('#profileEmailErrorMessage').text('{%trans%}Unable to send email.{%endtrans%}');
            });
        });
     });</script>
    {%- endif -%}
{%- endmacro %}

{% macro profilePhone(person) -%}
    <div id="phoneGroup" class="form-group float-input-label profile-section" data-loader-container="true">
        <label for="phone">{{ _("Cell") }} <span class="text-muted smaller-text">({{ _("Optional") }})</span></label>
        <input type="text" class="form-control" id="phone" name="phone" placeholder="{{ _('XXX-XXX-XXXX') }}" value="{{ person.phone if person and person.phone }}"  data-htmltags="true" data-error-field="errorphone"/>
    </div>
    <div id="errorphone" class="error-message"></div>
{%- endmacro %}

{% macro profileAltPhone(person) -%}
    <div id="altPhoneGroup" class="form-group float-input-label profile-section" data-loader-container="true">
        <label for="altPhone">{{ _("Phone (Other)") }} <span class="text-muted smaller-text">({{ _("Optional") }})</span></label>
        <input type="text" class="form-control" id="altPhone" name="altPhone" placeholder="{{ _('XXX-XXX-XXXX') }}" value="{{ person.alt_phone if person and person.alt_phone }}"  data-htmltags="true" data-error-field="erroraltPhone"/>
        <div id="erroraltPhone" class="error-message"></div>
    </div>
{%- endmacro %}

{% macro resetPassword(person) %}
    <div id="resetPasswordGroup" class="form-group profile-section flex-item">
        <button id="btnPasswordResetEmail" class="btn btn-tnth-primary">{{ _("Send email") }}</button>
        <div id="passwordResetMessage" class="text-info"></div>
    </div>
    <script>
    {% if person %}
    $(function() {
        if (!hasValue($("#email").val())) $("#btnPasswordResetEmail").attr("disabled", true);
        $('#btnPasswordResetEmail').on('click', function(event) {
            event.preventDefault();
            email = $('#email').val()
            if (email) {
                $.ajax ({
                    type: 'POST',
                    url: '/api/user/' + {{person.id}} + '/password_reset',
                    contentType: 'application/x-www-form-urlencoded; charset=UTF-8'
                }).done(function(data) {
                    $('#passwordResetMessage').text('{%trans%}Password reset email sent to {%endtrans%}' + email);
                }).fail(function() {
                    console.log('failed request');
                    $('#passwordResetMessage').text('{%trans%}Unable to send email.{%endtrans%}');
                });
            } else {
                $('#passwordResetMessage').text('{%trans%}No email address found for user{%endtrans%}');
            };
        });
    });
    {% endif %}
    </script>
{%-endmacro %}

{% macro profileOrgsSelector(person, current_user, consent_agreements) -%}
    <div id="userOrgs_view" class="view-container"></div>
    <div class="edit-container">
        <div id="userOrgs" class="customized">
           <input type="hidden" id="stock_consent_url" value="{{ url_for('portal.stock_consent', org_name='placeholder', _external=True)}}" />
           <p class="prompt text-muted">{{ _("In what state ")}}{% if current_user and current_user.has_role(ROLE.STAFF)%}{{_("is the patient ")}}{%else%}{{_("are you ")}}{% endif %}{{_("currently receiving prostate cancer care?") }}</p>
           <div class="state-selector-container selector-show"><select id="stateSelector" class="form-control"></select></div>
           <div id="fillOrgs" userId="{{person.id if person}}" class="orgs-by-state" {%if person and person.has_role(ROLE.PATIENT) and person.id == current_user.id %}patient_view="true"{%endif%}>
               <p class="clinic-prompt prompt selector-show">{{ _("What is your main clinic for prostate cancer care?")}}</p>
               <div class="main-state-container selector-show">
               </div>
           </div>
            <div class="noOrg-container" style="display: none">
                <label>
                    <input id="noOrgs" class="clinic" type="radio" name="organization" value="0" />
                    <span>{{ _("None of the Above") }}</span>
                </label>
            </div>
           <div id="userOrgsInfo" class="text-muted selector-show">{{_("No clinic found in selected state.")}}</div>
           <div id="defaultConsentContainer"></div>
           {% if consent_agreements %}{{consent(person, consent_agreements, current_user, True)}}{% endif %}
        </div>
    </div>
    <div class="get-orgs-error error-message"></div>
    <div class="get-demo-error error-message"></div>
    <div class="put-demo-error error-message"></div>
    <script>
        var CONSENT_WITH_TOP_LEVEL_ORG = {% if config.CONSENT_WITH_TOP_LEVEL_ORG %}true{% else %}false{% endif %};
        function handleCheckedItem() {
            var o = $("#userOrgs input[name='organization']:checked");
            if (o.length > 0 && o.val() != 0) {
                o.closest(".state-container").show();
                $(".clinic-prompt").show();
            };
        };
        $(function () {
            $("#stateSelector").on("change", function() {
                var selectedState = $(this).find("option:selected"), container = $("#" + selectedState.val() + "_container");
                var defaultPrompt = "What is your main clinic for prostate cancer care";
                $("#userOrgsInfo").hide();
                if (selectedState.val() != "") {
                    if (selectedState.val() == "none") {
                        $(".state-container, .noOrg-container").hide();
                        $(".clinic-prompt").text("").hide();
                        $("#noOrgs").prop("checked", true).trigger("click");
                        //send of ajax to update org to 0 here
                    } else {
                        if (container.length > 0) {
                            $(".state-container").hide();
                            $(".clinic-prompt").text(defaultPrompt + " in " + selectedState.text() + "?").show();
                            $(".noOrg-container").show();
                            $("#noOrgs").prop("checked", false);
                            container.show();
                        } else {
                            $(".state-container, .clinic-prompt, .noOrg-container").hide();
                            $("#userOrgsInfo").show();
                        };
                    };
                } else {
                    $(".state-container, .noOrg-container").hide();
                    $(".clinic-prompt").text("").hide();
                };
            });
            $.ajax ({
                type: "GET",
                url: '/api/organization',
                async: false
            }).done(function(data) {
                if (data && data.entry) {
                  var entry = data.entry, states = {};

                  /**** draw state select element first to gather all states
                        assign orgs to each state in array
                  ***/
                  entry.forEach(function(item) {
                    var __state = "";
                    if (item.identifier) {
                        (item.identifier).forEach(function(region) {
                            if (region.system === SYSTEM_IDENTIFIER_ENUM["practice_region"] && region.value) {
                                __state = (region.value).split(":")[1];
                                if (!states[__state]) {
                                    $("#stateSelector").append("<option value='" + __state + "'>" + stateDict[__state] + "</option>");
                                    $("#userOrgs .main-state-container").prepend("<div id='" + __state + "_container' state='" + __state + "' class='state-container'></div>");
                                    states[__state] = [item.id];
                                } else (states[__state]).push(item.id);
                            };
                        });
                    };
                  });

                  /**** draw input element(s) that belongs to each state based on parent organization id ***/
                  entry.forEach(function(item) {
                    if (parseInt(item.id) != 0) {
                        var parentId;
                        if (item.partOf) parentId = (item.partOf.reference).split("/")[2];
                        else parentId = item.id;
                        if (parentId) {
                            var parentState = (function(o) {
                                var s = "", found = false;
                                for (var state in states) {
                                    if (!found) {
                                        (states[state]).forEach(function(i) {
                                            if (i == o) {
                                               s = state;
                                               found = true;
                                            };
                                        });
                                    };
                                };
                                return s;
                            })(parentId);
                            if ($("#" + parentState + "_container").length > 0) {
                                $("#" + parentState + "_container").append("<div class='radio'><label><input class='clinic' type='radio' id='" + item.id + "_org' value='" + item.id + "' state='" + parentState + "' name='organization' data-parent-name='" + item.name + "' data-parent-id='" + parentId + "'>{%trans%}" + item.name + "{%endtrans%}</label></div>");
                            };
                        };
                    };
                  });

                  var selectOptions = $("#stateSelector").sortOptions();
                  if (selectOptions.length > 0) {
                      $("#stateSelector").empty().append(selectOptions)
                      .append("<option value='none'>Other</option>")
                      .prepend("<option value='' selected>Select</option>")
                      .val("");
                      $(".state-container, .clinic-prompt").hide();
                      setTimeout(function() { OT.handlePreSelectedClinic();}, 200);
                      //case of pre-selected clinic, need to check if any clinic has prechecked
                      setTimeout(function() { handleCheckedItem();}, 500);

                      OT.populateOrgsList(entry);
                      $("#userOrgs input[name='organization']").each(function() {
                        if ($(this).val() != 0) OT.getDefaultModal(this);
                      });

                      {% if person %} tnthAjax.getDemo({{person.id}}); {% endif %}
                      OT.handleEvent();
                    } else { // if no states found, then need to draw the orgs UI
                        $("#userOrgs .selector-show").hide();
                        setTimeout(function() { tnthAjax.getOrgs({{ person.id if person }}, false, false, function() {
                            OT.filterOrgs(OT.getHereBelowOrgs());
                            OT.morphPatientOrgs();
                            $(".noOrg-container, .noOrg-container *").show();
                        }); }, 500);
                    };

                  if ($("#mainDiv.profile").length > 0) setTimeout(function() { tnthAjax.getConsent({{ person.id if person }}, true);}, 500);
                };

            }).fail(function() {

            });
        });
    </script>
{%- endmacro %}

<!--this has an ajax call to fill in the content-->
{% macro profileOrg(person, removeNone, consent_agreements, current_user) -%}
    <div id="userOrgs_view" class="view-container"></div>
    <div class="edit-container">
        <div class="form-group profile-section standard" id="userOrgs">
            {% if 'patient' in config.CONSENT_EDIT_PERMISSIBLE_ROLES %}<label>{{ _("Main clinic for prostate cancer care") }}</label>{%else%}
            <label>{{_("Clinics ")}}<span class="text-muted smaller-text">({{ _("Optional") }})</span></label>{% endif %}
            <div class="indent">
            <input type="hidden" id="stock_consent_url" value="{{ url_for('portal.stock_consent', org_name='placeholder', _external=True)}}">
            <div id="fillOrgs" {% if person and person.has_role(ROLE.PATIENT) and (person.id == current_user.id) %}patient_view="true"{%endif%}></div>
            <div class="noOrg-container" style="{{'display:none' if removeNone == 'true'}}"><label><input id="noOrgs" class="clinic" type="checkbox" name="organization" value="0"><span>{{ _("None of the Above") }}</span></label></div>
            </div>
            {% if consent_agreements %}{{consent(person, consent_agreements, current_user)}} {% endif %}
            <div class="help-block with-errors"></div>
        </div>
    </div>
    <div class="get-orgs-error error-message"></div>
    <div class="get-demo-error error-message"></div>
    <div class="put-demo-error error-message"></div>
    <script>
        var CONSENT_WITH_TOP_LEVEL_ORG = {% if config.CONSENT_WITH_TOP_LEVEL_ORG %}true{% else %}false{% endif %};
        var ORG_EDIT_PERMISSIBLE_ROLES = {% if config.CONSENT_EDIT_PERMISSIBLE_ROLES %}{{ config.CONSENT_EDIT_PERMISSIBLE_ROLES|safe }}{% else %}false{% endif %};
        var leafOrgs = false;
        {% if person and person.has_role(ROLE.PATIENT) and current_user.has_role(ROLE.STAFF) and not(current_user.has_role(ROLE.ADMIN)) %}
            leafOrgs = {% if current_user.leaf_organizations() %} {{current_user.leaf_organizations() | safe}} {% else %} false {% endif %};
        {% endif %}
        $(function () {
            setTimeout(function() { tnthAjax.getOrgs({{ person.id if person }}, false, false, _handleOrgs);}, 500);
        });

        function _handleOrgs() {
            if (leafOrgs) OT.filterOrgs(leafOrgs);
            {%- if ((person.has_role(ROLE.PATIENT) or current_user.has_role(ROLE.PATIENT)) and 'patient' in config.CONSENT_EDIT_PERMISSIBLE_ROLES) or
                ((person.has_role(ROLE.PATIENT) and current_user.has_role(ROLE.STAFF)) and 'staff' in config.CONSENT_EDIT_PERMISSIBLE_ROLES)
             -%}
               OT.morphPatientOrgs();
            {%- endif -%}
            {%- if (person and (person.has_role(ROLE.STAFF) or person.has_role(ROLE.STAFF_ADMIN))) -%}
                $("#userOrgs .noOrg-container").hide();
            {%- endif -%}
            setTimeout(function() { tnthAjax.getConsent({{ person.id if person }});}, 500);
        };
    </script>
{%- endmacro %}
{% macro consent_modal(person, consent_agreement, org) -%}
    {%- if person and consent_agreement and org -%}
        <div class="modal fade" id="{{org}}_consentModal" tabindex="-1" role="dialog" aria-labelledby="{{org}}_consentModal">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">{{ _("Consent to share information") }}</h4>
                    </div>
                    <div class="modal-body">
                        <div class="terms-wrapper">
                            <h4>Terms</h4>
                            <div class="terms-container">{{consent_agreement.asset|safe}}</div>
                        </div>
                        <input type="hidden" class="agreement-url" value="{{consent_agreement.url|safe}}" />
                        <br/>
                        <p>{{_("I consent to sharing information with the ")}}<span class="consent-clinic-name">{{consent_agreement.organization_name}}.</span></p>
                        <div id="{{org}}_consentAgreementRadioList" class="profile-radio-list">
                          <label class="radio-inline">
                              <input type="radio" name="toConsent" id="{{org}}_consent_yes" data-org="{{org}}" value="yes"/>
                              {{ _("Yes") }}
                          </label>
                          <br/>
                          <label class="radio-inline">
                              <input type="radio" name="toConsent" id="{{org}}_consent_no" data-org="{{org}}"  value="no"/>
                              {{ _("No") }}
                          </label>
                        </div>
                        <div id="{{org}}_consentAgreementMessage" class="error-message"></div>
                     </div>
                     <br/>
                     <div class="modal-footer" >
                        <div id="{{org}}_loader" class="loading-message-indicator"><i class="fa fa-spinner fa-spin fa-2x"></i></div>
                        <button type="button" class="btn btn-default btn-consent-close" data-org="{{org}}" data-dismiss="modal" aria-label="Close">{{ _("Close") }}</button>
                     </div>
                </div>
            </div>
        </div>
        <script>
            $(function() {
                (function() {
                    var agreement_url = "{{consent_agreement.url}}";
                    if (/stock\-org\-consent/.test(agreement_url)) $(".terms-wrapper").hide();
                })();
            });
        </script>
    {%- endif -%}
{%- endmacro %}
{% macro consent(person, consent_agreements, current_user, includeModal) -%}
    {%- if person and consent_agreements -%}
        <div id="consentContainer">
            {{consent_fields(consent_agreements, current_user)}}
            {%- if includeModal-%}
                {%- for org in consent_agreements -%}
                   {%- if consent_agreements[org].url and consent_agreements[org].asset -%}
                   {{consent_modal(person, consent_agreements[org], org)}}
                   {%- endif -%}
                {%- endfor -%}
            {%- endif -%}
            <div class="get-consent-error error-message"></div>
        </div>
        <script>
            $(function() {
                $("#consentContainer input[name='toConsent']").each(function() {
                    $(this).on("click", function(e) {
                        e.stopPropagation();
                        $("#consentContainer button.btn-consent-close, #consentContainer button[data-dismiss]").attr("disabled", true);
                        var orgId = $(this).attr("data-org");
                        $("#" + orgId + "_loader").show();
                        if ($(this).val() == "yes") {
                            (function(orgId) {
                                var params = CONSENT_ENUM["consented"];
                                params.org = orgId;
                                params.agreementUrl = $("#" + orgId + "_agreement_url").val();
                                setTimeout(function() { tnthAjax.setConsent({{person.id}}, params);}, 10);
                                setTimeout(function() { tnthAjax.removeObsoleteConsent();}, 100);
                            })(orgId);
                        }
                        else {
                            tnthAjax.deleteConsent({{person.id}}, {"org":orgId});
                            setTimeout(function() { tnthAjax.removeObsoleteConsent();}, 100);
                        };
                        if (typeof reloadConsentList != "undefined") setTimeout("reloadConsentList();", 500);
                        setTimeout('$(".modal").modal("hide");', 250);
                    });
                });
                $(document).delegate("#consentContainer button[data-dismiss]", "click", function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    setTimeout(function() { location.reload();}, 10);
                });
                $("#consentContainer .modal").each(function() {
                    $(this).on("hidden.bs.modal", function() {
                        if ($("#consentContainer input[name='toConsent']:checked").length > 0) {
                            var userId = $("#fillOrgs").attr("userId");
                            assembleContent.demo(userId ,true, $("#userOrgs input[name='organization']:checked"), true);
                        };
                    });
                    $(this).on("show.bs.modal", function() {
                        $("#consentContainer .loading-message-indicator").hide();
                        $("#consentContainer button.btn-consent-close, #consentContainer button[data-dismiss]").attr("disabled", false).show();
                        $("#consentContainer input[name='toConsent']").each(function(){
                            $(this).prop("checked", false);
                        });
                        var agreement_url = $(this).find(".agreement-url").val();
                        if (/stock\-org\-consent/.test(agreement_url)) $(".terms-container").hide();
                    });
                });
            });
        </script>
    {%- endif -%}
{%- endmacro %}

{% macro patientReports(person) -%}
    <input type="hidden" id="pr_user_id" value="{{person.id}}"/>
    <div id="prTableToolBar"><span id="tableCount"></span></div>
    <table id="profilePatientReportTable" class="smaller-text"></table>
    <div id="patientReportErrorMessage" class="text-muted"></div>
    <script>
    $(function () {
         var ww = $(window).width();
         var prUserId = $("#pr_user_id").val();

        $.ajax ({
            type: "GET",
            url: '/api/user/' + $("#pr_user_id").val() + '/user_documents?document_type=PatientReport',
            contentType: "application/json; charset=utf-8",
            dataType: 'json'
        }).done(function(data) {
            if (data["user_documents"] && data["user_documents"].length > 0 ) {
                var fData = [];
                data["user_documents"].forEach(function(item) {
                    item["filename"] = escapeHtml(item["filename"]);
                    item["document_type"] = escapeHtml(item["document_type"]);
                    item["uploaded_at"] = tnthDates.formatDateString(item["uploaded_at"], "iso");
                    item["actions"] = '<a title="Download" href="' + '/api/user/' + String(item["user_id"]) + '/user_documents/' + String(item["id"]) + '"><i class="fa fa-arrow-down"></i></a>';
                    fData.push(item);
                });

                $('#profilePatientReportTable').bootstrapTable( {
                    data: fData,
                    pagination: true,
                    pageSize: 5,
                    pageList: [5, 10, 25, 50, 100],
                    classes: 'table table-responsive profile-patient-reports',
                    sortName: 'uploaded_at',
                    search: true,
                    smartDisplay: true,
                    showToggle: true,
                    showColumns: true,
                    toolbar: "#prTableToolBar",
                    rowStyle: function rowStyle(row, index) {
                          return {
                            css: {"background-color": (index % 2 != 0 ? "#F2F2F2" : "#FFF")}
                          };
                    },
                    undefinedText: '--',
                    columns: [
                        {
                            field: 'filename',
                            title: 'Filename',
                            searchable: true,
                            sortable: true
                        }, {
                            field: 'uploaded_at',
                            title: 'Uploaded At (GMT)',
                            sortable: true,
                            searchable: true,
                            width: '20%'
                        }, {
                            field: 'document_type',
                            title: 'Document Type',
                            sortable: true,
                            visible: false
                        }, {
                            field: 'contributor',
                            title: 'Contributor',
                            sortable: true,
                            searchable: true
                        }, {
                            field: 'actions',
                            title: 'Actions',
                            sortable: false,
                            searchable: false,
                            visible: true
                        }
                    ]
                } );
            } else {
                $("#patientReportErrorMessage").text("{%trans%}No reports available.{%endtrans%}").removeClass("error-message");
            }

        }).fail(function() {
            $("#profilePatientReportTable").closest("div.profile-item-container").hide();
            $("#patientReportErrorMessage").text("{%trans%}Problem retrieving reports from server.{%endtrans%}").addClass("error-message");
        });
     });</script>
{%- endmacro %}

{% macro profileConsent(person, current_user) -%}
    {% if person %}
    <div id="profileConsentList">{{_("No information available.")}}</div>
    <div class="get-consent-error error-message"></div>
    <div class="set-consent-error error-message"></div>
    <div class="delete-consent-error error-message"></div>
    <script>
        var CONSENT_DATE_LABEL = "{{ app_text('consent date label') }}";
        var CONSENT_EDIT_PERMISSIBLE_ROLES = {% if config.CONSENT_EDIT_PERMISSIBLE_ROLES %}{{ config.CONSENT_EDIT_PERMISSIBLE_ROLES|safe }}{% else %}false{% endif %};
        var consentEditable = {% if (current_user.has_role(ROLE.STAFF) and ROLE.STAFF in config.CONSENT_EDIT_PERMISSIBLE_ROLES) or (current_user.has_role(ROLE.PATIENT) and ROLE.PATIENT in config.CONSENT_EDIT_PERMISSIBLE_ROLES) or current_user.has_role(ROLE.ADMIN) %}true{% else %}false{% endif %};
        var isTestPatient = {% if current_user and not current_user.has_role(ROLE.PATIENT) %}'{{config.get("SYSTEM.TYPE")}}'.toUpperCase() != "PRODUCTION"{% else %}false{% endif %};
        var _isAdmin = {%if current_user.has_role(ROLE.ADMIN) %}true{%else%}false{%endif%};
        /**** this function is used when this section becomes editable, note: this is called after the user has edited the consent list; this will refresh the list ****/
        function reloadConsentList() {
            var eventLoading = '<div id="consentListLoad"><i class="fa fa-spinner fa-spin fa-2x loading-message"></i></div>';
            $("#profileConsentList").animate({opacity: 0}, function() {
                    $(this).html(eventLoading).css('opacity',1);
                    // Set a one second delay before getting updated list. Mostly to give user sense of progress/make it
                    // more obvious when the updated list loads
                    setTimeout(function(){
                        tnthAjax.getConsent({{person.id}}, true);
                    },1500);

            });
        };
        /*******  NOTE, this call is already made when getting the organizations
        $(function () {
            setTimeout("tnthAjax.getConsent({{person.id}}, false);", 1000);
        });
        *******/
    </script>
    {% endif %}
{%- endmacro %}
{% macro profileConsentDate() -%}
 <div id="consentDateEditContainer">
    <div class="form-group">
        <label>{{ app_text('consent date label')}}</label>
        <input type="hidden" name="consentDate" id="consentDate" value="" />
        <div class="flex">
            <div class="flex-item">
                <input class="form-control" id="consentDay" name="consentDay" placeholder="DD" type="text" pattern="(\d)?\d" maxlength="2" data-error="{{_('Date must be valid and in the required format.')}}" autocomplete="off" required />
            </div>
            <div class="flex-item">
                <select class="form-control" name="consentMonth" id="consentMonth" data-error="{{_('Date must be valid and in the required format.')}}" required>
                    <option value="">{{ _("Month") }}...</option>
                    <option value="01">{{ _("January") }}</option>
                    <option value="02">{{ _("February") }}</option>
                    <option value="03">{{ _("March") }}</option>
                    <option value="04">{{ _("April") }}</option>
                    <option value="05">{{ _("May") }}</option>
                    <option value="06">{{ _("June") }}</option>
                    <option value="07">{{ _("July") }}</option>
                    <option value="08">{{ _("August") }}</option>
                    <option value="09">{{ _("September") }}</option>
                    <option value="10">{{ _("October") }}</option>
                    <option value="11">{{ _("November") }}</option>
                    <option value="12">{{ _("December") }}</option>
                </select>
            </div>
            <div class="flex-item">
                <input class="form-control" id="consentYear" name="consentYear" placeholder="YYYY" pattern = "(19|20)\d{2}" type="text" maxlength="4" data-error="{{_('Date must be valid and in the required format.')}}" autocomplete="off" required />
            </div>
        </div>
        <div class="help-block with-errors"></div>
        <span id="errorConsentDate" class="help-block error-message"></span>
    </div>
</div>
{%- endmacro %}
{% macro profileAuditLog(person, current_user) -%}
    {% if (person and current_user) and (current_user.has_role(ROLE.ADMIN) or current_user.has_role(ROLE.STAFF) or current_user.has_role(ROLE.INTERVENTION_STAFF)) %}
        <input type="hidden" id="audit_user_id" value="{{person.id}}"/>
        <div id="auditTableToolBar"></div>
        <table id="profileAuditLogTable" class="smaller-text"></table>
        <div id="profileAuditLogErrorMessage" class="error-message"></div>
        <script>
        function _showText(obj) {
            if (obj) {
                var f = $(obj).parent().find('.second');
                f.toggleClass('hide');
                $(obj).text($(obj).text() ==='{%trans%}More...{%endtrans%}' ? '{%trans%}Less{%endtrans%}...': '{%trans%}More{%endtrans%}...');
            }
        };
        $(function () {
             var ww = $(window).width();
             var auditUserId = $("#audit_user_id").val();
            $.ajax ({
                type: "GET",
                url: '/api/user/' + $("#audit_user_id").val() + '/audit',
                contentType: "application/json; charset=utf-8",
                dataType: 'json'
            }).done(function(data) {
                if (data["audits"] && data["audits"].length > 0 ) {
                    var fData = [];
                    data["audits"].forEach(function(item) {
                        item["by"] = item["by"]["reference"];
                        var r = /\d+/g;
                        var m = r.exec(String(item["by"]));
                        if (m) item["by"] = m[0]
                        else item["by"] = "-";
                        item["lastUpdated"] = tnthDates.formatDateString(item["lastUpdated"], "iso");
                        item["comment"] = escapeHtml(item["comment"]);
                        var c = String(item["comment"]);
                        var len = ((ww < 650) ? 20 : (ww < 800? 40 : 80));

                        item["comment"] = c.length > len ? (c.substring(0, len+1) + "<span class='second hide'>" + c.substr(len+1) + "</span><br/><sub onclick='_showText(this)' class='pointer text-muted'>{%trans%}More{%endtrans%}}...</sub>") : item["comment"];
                        fData.push(item);
                    });

                    $('#profileAuditLogTable').bootstrapTable( {
                        data: fData,
                        pagination: true,
                        pageSize: 5,
                        pageList: [5, 10, 25, 50, 100],
                        classes: 'table table-responsive profile-audit-log',
                        sortName: 'lastUpdated',
                        search: true,
                        smartDisplay: true,
                        showToggle: true,
                        showColumns: true,
                        toolbar: "#auditTableToolBar",
                        rowStyle: function rowStyle(row, index) {
                              return {
                                css: {"background-color": (index % 2 != 0 ? "#F2F2F2" : "#FFF")}
                              };
                        },
                        undefinedText: '--',
                        columns: [
                            {
                                field: 'by',
                                title: 'User',
                                width: '5%',
                                sortable: true,
                                searchable: true
                            }, {
                                field: 'comment',
                                title: 'Comment',
                                searchable: true,
                                sortable: true
                            }, {
                                field: 'lastUpdated',
                                title: "{%trans%}Date/Time{%endtrans %} <span class='gmt'> {%trans%}(GMT), Y-M-D{%endtrans%}</span>",
                                sortable: true,
                                searchable: true,
                                /******
                                sorter: function(a, b) {
                                    return new Date(b).getTime() - new Date(a).getTime();
                                },
                                ****/
                                width: '20%'
                            },
                            {
                                field: 'version',
                                title: 'Version',
                                sortable: true,
                                visible: false
                            }
                        ]
                    } );
                } else {
                    $("#profileAuditLogErrorMessage").text("{%trans%}No audit log item found.{%endtrans%}");
                }


            }).fail(function() {
                $("#profileAuditLogErrorMessage").text("{%trans%}Problem retrieving audit log from server.{%endtrans%}");
            });
         });</script>
     {% endif %}
{%- endmacro %}

{% macro profileRole(person, current_user) -%}
    {% if (person and current_user) and current_user.has_role('admin') and not person.has_role('service') %}
        <h4 class="text-muted">{% if person and person.username %}{{ _("for") + " " + person.username }} {% endif %}</h4>
        <p class="small-text text-muted">{{ _("Editable by admins only.") }}</p>
        <!-- roles are populated in main.js -->
        <div class="form-group" id="rolesGroup"></div>
        <div id="rolesLoadingContainer" data-save-container-id="rolesLoadingContainer" data-loader-container="true"></div>
        <div class="get-roles-error error-message"></div>
        <div class="put-roles-error error-message"></div>
        <div class="delete-roles-error error-message"></div>
    {% endif %}
    {% if person %}
    <script>
    $(function () {
        tnthAjax.getRoleList(function() {
            tnthAjax.getRoles({{ person.id }}, true);
            $("#rolesGroup input[name='user_type']").each(function() {
                $(this).on("click", function() {
                    var roles = $("#rolesGroup input:checkbox:checked").map(function(){
                        return { name: $(this).val() };
                    }).get();
                    var toSend = {"roles": roles};
                    tnthAjax.putRoles({{person.id}},toSend, $("#rolesLoadingContainer"));
                 });
            });
        });
    });
    </script>
    {% endif %}

{%- endmacro %}

{% macro profileSessionList(person, current_user) -%}
    <div id="userSessionsListContainer">
        <input type="hidden" id="_session_user_id" value="{{person.id if person}}"/>
        <table id="userSessionListTable" class="tnth-admin-table table table-hover table-condensed table-striped table-bordered table-responsive small-text">
            <caption>{{ _("Session History") }} <span class="text-muted smaller-text">({{ _("click each row to review report") }})</span></caption>
            <tr><th>{{ _("Questionnaire Name") }}</th><th>{{ _("Status") }}</th><th>{{ _("Last Updated") }} <small id="gmtText" class="gmt">( {{ _("GMT, Y-M-D") }} )</small></th></tr>
        </table>
        <div id="profileSessionListError" class="error-message"></div>
    </div>
    <script>
        $(function () {
        var sessionListHTML = "";
        var sessionUserId = $("#_session_user_id").val();

        $.ajax ({
                type: "GET",
                url: '/api/patient/' + sessionUserId + '/assessment',
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                cache: false
            }).done(function(data) {
                var entries = data.entry ? data.entry : null;
                if (entries && entries.length > 0) {
                    entries.forEach(function(entry, index) {

                        var reference = entry['questionnaire']['reference'];
                        var arrRefs = String(reference).split('/');
                        var instrumentId = arrRefs.length > 0 ? arrRefs[arrRefs.length - 1] : "";
                        var authoredDate = String(entry['authored']);
                        $("#gmtText").show();
                        if (instrumentId) {
                            var reportLink = '/patients/sessionReport/' + sessionUserId + '/' + instrumentId + "/" + authoredDate;
                            sessionListHTML += '<tr title="{%trans%}Click to view report{%endtrans%}"  ' +
                                                (index % 2 != 0 ? 'class="odd"': 'class="even"') + '>' +
                                                [entry['questionnaire']['display'],
                                                 entry['status'],
                                                 tnthDates.formatDateString(entry['authored'], "iso")].map(function(o) {
                                                    return  '<td><a href="' + reportLink + '">{%trans%}' + o + '{%endtrans%}</a></td>'
                                                 }).join('') +
                                                 '</tr>';
                        };
                    });
                        $("#userSessionListTable").append(sessionListHTML);
                        $("#userSessionListTable").show();

                } else {
                    $("#userSessionListTable").hide();
                    $("#userSessionsListContainer").prepend("<span class='text-muted'>{%trans%}No questionnaire data found.{%endtrans%}</span>");
                };

            }).fail(function() {
                console.log("Problem retrieving session data from server.");
                $("#userSessionListTable").hide();
                $("#profileSessionListError").html("{%trans%}Problem retrieving session data from server.{%endtrans%}");
            });

    });
    </script>
{%- endmacro %}
{% macro profileAssessment(person, instrument_id, authored_date) -%}
        <div id="userSessionReportDetail" cellpadding="2">
            <input type="hidden" id="_report_user_id" value="{{person.id if person}}" />
            <input type="hidden" id="_report_authored_date" value="{{authored_date}}" />
            <table class="tnth-admin-table table table-condensed table-striped table-bordered small-text" id="userSessionReportDetailTable" ></table><br />
        </div>
        <script>
        $(function () {
            if (!(_isTouchDevice())) $('#userSessionReportDetailHeader [data-toggle="tooltip"]').tooltip();

            var sessionListHTML = "";
            var sessionUserId = $("#_report_user_id").val();
            var sessionAuthoredDate = $("#_report_authored_date").val();

            $.ajax ({
                    type: "GET",
                    url: '/api/patient/' + sessionUserId + '/assessment/{{instrument_id}}',
                    contentType: "application/json; charset=utf-8",
                    dataType: 'json'
                }).done(function(data) {
                    //console.log(data)
                    $(".report-error-message").hide();
                    $("#userSessionReportDetailTable").html('');
                    if (data.entry && data.entry.length > 0) {
                        var entries = data['entry'];
                        var entry;
                        entries.forEach(function(item) {
                            if (!entry && (item["authored"] == sessionAuthoredDate)) entry = item;
                        });

                        if (!entry) entry = entries[0];
                        var reportHTML = '<caption><hr/><span class="profile-item-title">{%trans%}' +
                                        entries[0]['questionnaire']['display'] +
                                        '{%endtrans%}</span><br/><span class="text-muted smaller-text">{%trans%}Last Updated{%endtrans%} - ' +
                                        tnthDates.formatDateString(sessionAuthoredDate, "iso") +
                                         " <span class='gmt'>{%trans%}(GMT, Y-M-D){%endtrans%}</span>" + '</span><hr/></caption>';
                        reportHTML += '<tr><TH>{%trans%}Question{%endtrans%}</TH><TH>{%trans%}Response{%endtrans%}</TH></tr>';
                        entry['group']['question'].forEach(function(entry) {
                            var q = entry['text'] ? entry['text'] : '', a = '', qcNeeded = true;
                            if (hasValue(q)) {
                                q = q.replace(/^[\d\w]{1,3}\./, '');  //replace question # in the beginning of the question
                                qcNeeded = false;
                            };
                            if (entry['answer']) {
                                (entry['answer']).forEach(function(item) {
                                    if (item.valueString) a += (hasValue(a) ? "<br/>" : "") + item.valueString;
                                    if (qcNeeded && item.valueCoding && item.valueCoding.code) q += (hasValue(q) ? "<br/>" : "") + item.valueCoding.code;
                                });
                            };
                            if (!hasValue(q)) q = entry['linkId'];
                            reportHTML += '<tr><td>{%trans%}' + (hasValue(q)? q: "--") + '{%endtrans%}</td><td>{%trans%}' + (String(a) !== 'undefined' ? a : '--') + '{%endtrans%}</td></tr>';
                        });
                        $("#userSessionReportDetailTable").append(reportHTML);

                    }
                    //console.log(data);

                }).fail(function(xhr) {
                    $(".report-error-message").show();
                    $(".report-error-message").append("<br/>" + xhr.responseText);

                });

        });
        </script>

{%- endmacro %}

{% macro profileClinicalPCALocalized(person, current_user) -%}
 <div class="row">
        <div class="col-md-12">
            <div class="profile-item-container">
                <h4 id="clinicalQuestionsLoc" class="profile-item-title index-item">{{ _("Clinical Question") }}</h4>
                <p class="text-muted">{{ _("Question asked of the patient at account creation") }}</p>
                <input type="hidden" id="iq_userId" value="{{person.id if person}}" />
                <div id="pcaLocalizedContainer" class="well" style="margin-top: 1em; padding: 0.7em 2em 1em 2em">
                     <div id="patMeta" data-topic="pca_localized" class="pat-q">
                      <br />
                      <p>{{ _("Is the prostate cancer only within the prostate?") }}</p>
                      <div class="form-group">
                        <div class="radio">
                          <label>
                            <input type="radio" class="init-queries-field" data-save-container-id="pcaLocalizedContainer" name="pca_localized" id="pca_localized_yes" value="true"> {{ _("Yes") }}
                          </label>
                        </div>
                        <div class="radio">
                          <label>
                            <input type="radio" class="init-queries-field" data-save-container-id="pcaLocalizedContainer" name="pca_localized" id="pca_localized_no" value="false"> {{ _("No (the cancer is in other parts of my body, too)") }}
                          </label>
                        </div>
                      </div>
                    </div>
                </div>
            </div>
        </div>
</div>
<script>
    {% if person %}
        $(function () {
            tnthAjax.getClinical({{ person.id }});
            $("#pca_localized_yes").on("click", function() {
                tnthAjax.putClinical({{person.id}},"pca_localized","true", $(this));
                setTimeout(function() { adjustAssessmentInstrument();}, 1000);
            });
            $("#pca_localized_no").on("click", function() {
                tnthAjax.putClinical({{person.id}},"pca_localized","false", $(this));
                setTimeout(function() { adjustAssessmentInstrument();}, 1000);
            });
            getSaveLoaderDiv("profileForm", "pcaLocalizedContainer");
        });
    {% endif %}

</script>
{%- endmacro %}

{% macro profileClinicalQuestions(person, current_user) -%}
    <div class="row">
        <div class="col-md-12">
            <div class="profile-item-container {% if person and current_user and person.id == current_user.id %}editable{% endif %}" data-sections="clinical">
                <h4 id="clinicalQuestionsLoc" class="profile-item-title index-item">{% if person.id == current_user.id %}{{_("My Prostate Cancer Profile")}}{% else %}{{ _("Clinical Questions") }}{% endif %}</h4>
                {% if person.id != current_user.id %}<p class="text-muted">{{ _("Questions asked of the patient at registration") }}</p>{% endif %}
                <input type="hidden" id="iq_userId" value="{{person.id if person}}" />
                <div class="view-container">
                     <table>
                        <tr><td class="text-muted">{{_("Have you had a prostate cancer biopsy?")}}</td><td><div id="biopsy_view"></div></td></tr>
                        <tr><td class="text-muted">{{_("Have you been diagnosed with prostate cancer?")}}</td><td><div id="pca_diag_view"></div></td></tr>
                        <tr><td class="text-muted">{{_("Is the prostate cancer only within the prostate?")}}</td><td><div id="pca_localized_view"></div></td></tr>
                   </table>
                </div>
                <div id="patientQContainer" class="edit-container">
                    {{patientQGroup(current_user)}}
                </div>
                <div class="get-clinical-error error-message"></div>
                <div class="put-clinical-error error-message"></div>
                <div class="post-clinical-error error-message"></div>
            </div>
        </div>
    </div>
    <script>
        function checkDiagnosis() {
            var diag = $("#pca_diag_yes");

            if (diag.is(":checked")) {
              diag.parents(".pat-q").nextAll().fadeIn();
            } else {
              diag.parents(".pat-q").nextAll().fadeOut();
            };
            {% if person and current_user and (person.id != current_user.id) %}
                if (!$("#patientQ input[type='radio']").is(":checked")) {
                    $("#patientQContainer").append("<span class='text-muted'>{{ _('no answers provided') }}</span>");
                };
            {% endif %}
            fillViews.clinical();

        };
        $(function () {
            $("#patientQ").show();
            //don't show treatment
            $("#patTx").remove();

            $("#patientQ hr").hide();
            {% if person and current_user and person.id != current_user.id %}
                $("#patientQ input[type='radio']").each(function() {
                    $(this).attr("disabled", "disabled");
                });
                //$("#biopsyDate").attr("disabled", true);
                $("#biopsy_day, #biopsy_month, #biopsy_year").each(function() {
                    $(this).attr("disabled", true);
                });
            {% endif %}

            {% if person %}
                $(".pat-q input:radio").on("click",function(){
                      var thisItem = $(this);
                      var toCall = thisItem.attr("name")
                      // Get value from div - either true or false
                      var toSend = thisItem.val();
                      if (toCall != "biopsy") tnthAjax.postClinical({{person.id}},toCall,toSend, $(this).attr("data-status"), $(this));

                      if (toSend == "true" || toCall ==  "pca_localized") {
                        if (toCall == "biopsy") {
                            if ($("#biopsyDate").val() == "") return true;
                            else {
                              //$("#biopsyDate").datepicker("hide").blur();
                              tnthAjax.postClinical({{person.id}}, toCall, toSend, "", $(this), {"issuedDate": $("#biopsyDate").val()});
                            };
                        };
                        thisItem.parents(".pat-q").nextAll().fadeIn();
                      } else {
                        if (toCall == "biopsy") {
                            tnthAjax.postClinical({{person.id}}, toCall, "false", $(this).attr("data-status"), $(this));
                            ["pca_diag", "pca_localized"].forEach(function(fieldName) {
                                $("input[name='" + fieldName + "']").each(function() {
                                    $(this).prop("checked", false);
                                });
                            });
                            if ($("input[name='pca_diag']").length > 0) {
                                tnthAjax.putClinical({{person.id}},"pca_diag","false", $(this));
                            };
                            if ($("input[name='pca_localized']").length > 0) {
                                tnthAjax.putClinical({{person.id}},"pca_localized","false", $(this));
                            };
                        } else if (toCall == "pca_diag") {
                            ["pca_localized"].forEach(function(fieldName) {
                              $("input[name='" + fieldName + "']").each(function() {
                                  $(this).prop("checked", false);
                              });
                            });
                            if ($("input[name='pca_localized']").length > 0) {
                                tnthAjax.putClinical({{person.id}},"pca_localized","false", $(this));
                            };
                        }
                        thisItem.parents(".pat-q").nextAll().fadeOut();
                      };
                  });
             {% endif %}

            [{
                "fields": $("#patientQ input[name='biopsy']"),
                "containerId": "patBiopsy"
            },
            {
                "fields": $("#patientQ input[name='pca_diag']"),
                "containerId": "patDiag"
            },
            {
                "fields": $("#patientQ input[name='pca_localized']"),
                "containerId": "patMeta"
            }
            ].forEach( function(item) {
                item.fields.each(function() {
                     getSaveLoaderDiv("profileForm", item.containerId);
                    $(this).attr("data-save-container-id", item.containerId);
                });
            });

            //wait for ajax calls to finish?
            //hide rest of the questions if the patient hasn't been diagnosed with prostate cancer
            setTimeout(function() { checkDiagnosis();}, 1000);


        });
    </script>
{%- endmacro %}

{% macro profileInterventionReports(person) -%}
    <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="profile-item-container">
                    <h4 id="interventionReportsLoc" class="profile-item-title index-item">{{ _("Intervention Reports") }}</h4>
                    <div>
                        {%- if person and person.staff_html() -%}
                            {{person.staff_html() | safe}}
                        {%- else -%}
                            <div class="text-muted">{{ _("No reports available.") }}</div>
                        {%- endif -%}
                    </div>
                </div>
            </div>
    </div>
{%- endmacro %}

{% macro profileTimeZone(person) %}
    <div id="profileTimeZoneGroup" class="form-group timezone-container flex-item">
        <label>Time Zone</label>
        <select class="form-control" id="profileTimeZone" data-save-container-id="profileTimeZoneGroup">
            <option value="UTC">-- Select --</option>
            <option value="America/Denver">{{_("America/Denver")}}</option>
            <option value="America/Los_Angeles">{{_("America/Los Angeles")}}</option>
            <option value="America/Indianapolis">{{_("America/Indianapolis")}}</option>
            <option value="America/New_York">{{_("America/New York")}}</option>
            <option value="Australia/Adelaide">{{_("Australia/Adelaide")}}</option>
            <option value="Australia/Brisbane">{{_("Australia/Brisbane")}}</option>
            <option value="Australia/Broken_Hill">{{_("Australia/Broken_Hill")}}</option>
            <option value="Australia/Canberra">{{_("Australia/Canberra")}}</option>
            <option value="Australia/Currie">{{_("Australia/Currie")}}</option>
            <option value="Australia/Darwin">{{_("Australia/Darwin")}}</option>
            <option value="Australia/Eucla">{{_("Australia/Eucla")}}</option>
            <option value="Australia/Hobart">{{_("Australia/Hobart")}}</option>
            <option value="Australia/Lindeman">{{_("Australia/Lindeman")}}</option>
            <option value="Australia/Lord_Howe">{{_("Australia/Lord_Howe")}}</option>
            <option value="Australia/Melbourne">{{_("Australia/Melbourne")}}</option>
            <option value="Australia/North">{{_("Australia/North")}}</option>
            <option value="Australia/Perth">{{_("Australia/Perth")}}</option>
            <option value="Australia/Queensland">{{_("Australia/Queensland")}}</option>
            <option value="Australia/South">{{_("Australia/South")}}</option>
            <option value="Australia/Sydney">{{_("Australia/Sydney")}}</option>
            <option value="Australia/Tasmania">{{_("Australia/Tasmania")}}</option>
            <option value="Australia/Victoria">{{_("Australia/Victoria")}}</option>
            <option value="Australia/West">{{_("Australia/West")}}</option>
            <option value="Australia/Yancowinna">{{_("Australia/Yancowinna")}}</option>
        </select>
    </div>
    <div class="timezone-warning"></div>
    <div class="timezone-error"></div>
    <script>
    {% if person %}
    $(function() {
        getSaveLoaderDiv("profileForm", "profileTimeZoneGroup");
        $('#profileTimeZone').on('change', function() {
            $(".timezone-error").html("");
            $(".timezone-warning").html("");
            assembleContent.demo({{ person.id }},true, $(this), true);
            fillViews.timezone();
        });
    });
    {% endif %}
    </script>
{%-endmacro %}

{% macro profileDeceased(person, current_user) -%}
    <div class="row">
        <div class="col-md-12 col-xs-12">
            <div class="profile-item-container editable" data-sections="deceased">
                <h4 id="deathLoc" class="profile-item-title index-item">{{ _("Deceased Status") }}</h4>
                <input type="hidden" id="deathDate" value="" />
                <div class="view-container">
                    <div id="boolDeath_view"></div>
                    <div id="deathDate_view"></div>
                </div>
                <div class="edit-container">
                    <div class="checkbox" id="boolDeathGroup">
                        <label>
                            <input type="checkbox" name="boolDeath" id="boolDeath" value="1" data-save-container-id="boolDeathGroup" />{{ _("Has the patient passed away?") }}
                        </label>
                    </div>
                    <hr/>
                    <div class="form-group">
                        <label class="text-muted">{{ _("Deceased Date") }}</label>
                    </div>
                    <div class="row deceased-date-container">
                        <div class="col-md-3 col-xs-6">
                            <div id="deathDayContainer" class="form-group profile-section">
                                <input class="form-control" id="deathDay" name="deathDay" data-save-container-id="deathDayContainer" placeholder="DD" type="text" pattern="\d[\d]?" maxlength="2" required />
                                 <div class="help-block with-errors"></div>
                            </div>
                        </div>
                        <div class="col-md-3 col-xs-10">
                            <div id="deathMonthContainer" class="form-group profile-section">
                                <select class="form-control" name="deathMonth" id="deathMonth" data-save-container-id="deathMonthContainer" required>
                                    <option value="">{{ _("Month") }}...</option>
                                    <option value="01">{{ _("January") }}</option>
                                    <option value="02">{{ _("February") }}</option>
                                    <option value="03">{{ _("March") }}</option>
                                    <option value="04">{{ _("April") }}</option>
                                    <option value="05">{{ _("May") }}</option>
                                    <option value="06">{{ _("June") }}</option>
                                    <option value="07">{{ _("July") }}</option>
                                    <option value="08">{{ _("August") }}</option>
                                    <option value="09">{{ _("September") }}</option>
                                    <option value="10">{{ _("October") }}</option>
                                    <option value="11">{{ _("November") }}</option>
                                    <option value="12">{{ _("December") }}</option>
                                </select>
                                <div class="help-block with-errors"></div>
                            </div>
                        </div>
                        <div class="col-md-3 col-xs-6">
                            <div id="deathYearContainer" class="form-group profile-section">
                                <input class="form-control" id="deathYear" name="deathYear" placeholder="YYYY" pattern = "\d{4}" type="text" maxlength="4" data-save-container-id="deathYearContainer" required />
                                <div class="help-block with-errors"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="errorDeathDate" class="get-demo-error error-message"></div>
                <div class="put-demo-error error-message"></div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(
            function() {
                __convertToNumericField($("#deathDay, #deathYear"));
                getSaveLoaderDiv("profileForm", "boolDeathGroup");
                $("#boolDeath").on("change", function() {
                    if (!($(this).is(":checked"))) {
                        $("#deathYear").val("");
                        $("#deathDay").val("");
                        $("#deathMonth").val("");
                        $("#deathDate").val("");
                    }
                    assembleContent.demo({{person.id}}, true, $(this));
                });

                ["deathDay", "deathMonth", "deathYear"].forEach(function(fn) {
                    getSaveLoaderDiv("profileForm", $("#"+fn).attr("data-save-container-id"));
                    var fd = $("#" + fn);
                    var triggerEvent = fd.attr("type") == "text" ? "blur": "change";
                    fd.on(triggerEvent, function() {
                         var d = $("#deathDay");
                         var m = $("#deathMonth");
                         var y = $("#deathYear");
                         if (d.val() != "" && m.val() != "" && y.val() != "") {
                            if (d.get(0).validity.valid && m.get(0).validity.valid && y.get(0).validity.valid) {
                                var today = new Date();
                                // Check to see if this is a real date
                                var iy = parseInt(y.val()), im = parseInt(m.val()), iid=parseInt(d.val());
                                var date = new Date(iy,im-1,iid);
                                var errorMsg = "";

                                if (date.getFullYear() == iy && (date.getMonth() + 1) == im && date.getDate() == iid) {
                                    if (iy < 1900) errorMsg = "Year must be after 1900";
                                    // Only allow if birthdate is before today
                                    if (date.setHours(0,0,0,0) > today.setHours(0,0,0,0)) {
                                        errorMsg = "{%trans%}The date must not be in the future.{%endtrans%}";
                                    };
                                } else errorMsg = "{%trans%}Invalid Date. Please enter a valid date.{%endtrans%}";

                                if (errorMsg == "") {
                                    $("#deathDate").val(y.val()+"-"+m.val()+"-"+d.val());
                                    $("#boolDeath").prop("checked", true);
                                    $("#errorDeathDate").text("");
                                    assembleContent.demo({{person.id}}, true, $(this));
                                } else {
                                    $("#errorDeathDate").text(errorMsg);
                                };
                            };
                        };
                    });
                });
            }
        );
    </script>
{%- endmacro %}
{% macro profileStudyID(current_user) -%}
    <div id="profileStudyIDContainer" class="form-group" data-loader-container="true">
        <label class="text-muted">{{_("Study ID")}}</label>
        <input type="text" id="profileStudyId" class="form-control" {%if current_user and current_user.has_role(ROLE.PATIENT) %}disabled{% endif %}/>
        <div class="help-block with-errors"></div>
        <div id="errorprofileStudyId" class="error-message"></div>
    </div>
{%- endmacro %}
{% macro profileSiteID(current_user) -%}
    <div id="profileSiteIDContainer" class="form-group" data-loader-container="true">
        <label class="text-muted">{{_("Site ID")}}</label>
        <input type="text" id="profileSiteId" class="form-control" {%if current_user and current_user.has_role(ROLE.PATIENT) %}disabled{% endif %} data-htmltags="true" data-error-field="errorprofileSiteId"/>
        <div class="help-block with-errors"></div>
        <div id="errorprofileSiteId" class="error-message"></div>
    </div>
{%- endmacro %}
{% macro profileCustomDetail(person, invite_email) -%}
     <div class="row">
        <div class="col-md-12 col-xs-12">
            <h4 class="profile-item-title detail-title">{{_("Three ways to complete questionnaire")}}</h4>
            <div class="custom-container">
                <input type="text" style="position: fixed; left: -10000000px;" autofocus/>
                <div class="profile-item-container custom-container-item-right">
                    <h4 id="customSendEmailLoc" class="profile-item-title index-item">{{_("Send email")}}</h4>
                    <br/>
                    <div class="text-muted custom-container-content">{{_("Invite or remind patient over email to complete their questionnaire")}}</div>
                    <br/>
                    <div>{{profileEmailForm(person, invite_email)}}</div>
                </div>
                <div class="profile-item-container custom-container-item-right">
                    <h4 id="customLoginAsLoc" class="profile-item-title index-item">{{_("Log in as patient")}}</h4>
                    <div class="custom-container-content text-muted">{{_("This logs you out, and logs in the patient without their needing to enter credentials. This is so the patient can complete their questionnaire on this device. Ideal for tablet and kiosk computers.")}}</div><br/>
                    <button id="loginAsButton" class="btn btn-tnth-primary custom-btn" type="button">{{_("Log in as patient")}}</button>
                </div>
                 <div class="profile-item-container custom-container-item">
                    <h4 id="customEnterManuallyLoc" class="profile-item-title index-item">{{_("Enter manually")}}</h4><br/>
                    <div class="custom-container-content enter-manual-container text-muted">{{_("Enter questionnaire responses on patient's behalf. Helpful if responses have been completed on paper.")}}</div><br/>
                    <div id="enterManualInfoContainer" class="text-info"></div>
                    <a class="btn btn-tnth-primary custom-btn" id="assessmentLink" data-toggle="modal" data-target="#manualEntryModal">{{_("Enter manually")}}</a>
                    <div class="modal fade" id="manualEntryModal" tabindex="-1" role="dialog" aria-labelledby="assessmentLink">
                          <div class="modal-dialog" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title">{{ _("Enter questionnaire manually on patient's behalf") }}</h4>
                              </div>
                              <div class="modal-body">
                                <p class="text-left text-muted">{{ _('Select the method in which the questionnaire will be completed:') }}</p>
                                 <div class="form-group">
                                    <div class="profile-radio-list">
                                      <label class="radio-inline">
                                          <input type="radio" name="entryMethod" id="interviewAssisted" value="interview_assisted"/>
                                          <span>{{ _("Interview assisted") }}</span>
                                      </label>
                                      <br/>
                                      <label class="radio-inline">
                                          <input type="radio" name="entryMethod" id="paper" value="paper"/>
                                          <span>{{ _("Paper") }}</span>
                                      </label>
                                    </div>
                                  </div>
                                  <div id="manualEntryMessageContainer" class="error-message"></div>
                              </div>
                              <div class="modal-footer">
                                <div id="manualEntryLoader" class="loading-message-indicator">
                                    <i class="fa fa-spinner fa-spin fa-2x loading-message"></i>
                                </div>
                                <div id="manualEntryButtonsContainer">
                                    <a href="#" id="meSubmit" class="btn btn-default">{{ _("OK") }}</a>
                                    <button type="button" class="btn btn-default" data-dismiss="modal">{{ _("Cancel") }}</button>
                                </div>
                              </div>
                            </div>
                          </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
    $(document).ready(function() {
        $("#profileSendEmailContainer").hide();
        $(".registration-email-prompt").hide();
        $("#sendEmailLabel").hide();
        $("#loginAsPatient").hide();
        $("#navMenuXs").hide();
        if (! hasValue($("#email").val()) ){
            $("#profileEmailSelect").attr("disabled", true);
        } else $("#profileEmailSelect").attr("disabled", false);
        $("#email").on("keyup", function() {
            if (hasValue($(this).val())) $("#profileEmailSelect").attr("disabled", false);
            else $("#profileEmailSelect").attr("disabled", true);
        });
        $("#loginAsButton").on("click", function(e) {
            e.preventDefault();
            e.stopPropagation();
            handleLoginAs(e);
        });

        $(document).delegate("#meSubmit", "click", function(event){
            var method = "";
            $("input[name='entryMethod']").each(function() {
                if ($(this).is(":checked")) {
                    method = $(this).val();
                };
            });
            if (method != "") {
                $("#manualEntryMessageContainer").text("");
                //check if the user has given web consent here, if not redirect to form
                var assessment_url = {%if person.assessment_link%}"{{person.assessment_link|safe}}"{%else%}""{%endif%};
                if (hasValue(assessment_url)) {
                    var still_needed = false;
                    tnthAjax.getStillNeededCoreData('{{person.id if person}}', true, function(data) {
                            if (data && ! data.error && data.length > 0) still_needed = true;
                        }, method);
                    if (/\?/.test(assessment_url)) assessment_url += "&entry_method=" + method;
                    else assessment_url += "?entry_method=" + method;
                    var winLocation = !still_needed ? assessment_url : "{{url_for('portal.website_consent_script', patient_id=person.id)}}" + "?entry_method=" + method + "&redirect_url=" + encodeURIComponent(assessment_url);
                    $("#manualEntryButtonsContainer").hide();
                    $("#manualEntryLoader").show();
                    setTimeout(function() { window.location = winLocation;}, 100);
                } else {
                    $("#manualEntryMessageContainer").html("{%trans%}The user does not have a valid assessment link.{%endtrans%}");
                };
            } else {
                $("#manualEntryMessageContainer").html("{%trans%}You must select a method.{%endtrans%}");
            };
          });

          $("input[name='entryMethod']").on("click", function() {
              if ($(this).is(":checked")) $("#manualEntryMessageContainer").text("");
          });

        {%- if person -%}
            $.ajax ({
                type: "GET",
                url: '/api/patient/{{person.id}}/assessment-status',
                cache: false
            }).done(function(data) {
                if (data && (data.assessment_status).toUpperCase() == "COMPLETED") {
                    $("#assessmentLink").attr("disabled", true);
                    $("#enterManualInfoContainer").text("{%trans%}All available questionnaires have been completed.{%endtrans%}");
                };
            }).fail(function() {
               // console.log("Problem retrieving data from server.");
            });
        {%- endif -%}
    });</script>
{%- endmacro %}
{% macro profileInterventions(user_interventions) -%}
  <div class="row">
        <div class="col-md-12 col-xs-12">
            <div class="profile-item-container">
                <h4 id="interventionsLoc" class="profile-item-title index-item">{{_("Interventions")}}</h4>
                    {% if user_interventions %}
                        {% if user_interventions.length != 0 %}<p class="text-muted">{{_("Patient is participating in the following intervention(s): ")}}</p>{% endif %}
                        {% for intervention in user_interventions %}
                            <div class="capitalize">{{intervention.name | replace("_", " ")}}</div>
                        {% endfor %}
                        {% if user_interventions.length == 0 %}<div class="text-muted">{{_("None")}}</div>{% endif %}
                    {% else %}
                        <div class="text-muted">{{_("None")}}</div>
                    {% endif %}
                </div>
            </div>
    </div>
{%- endmacro %}

{% macro user_profile(person, current_user, consent_agreements, user_interventions) -%}
     <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="profile-item-container editable" data-sections="demo">
                <h4 id="patientInformationLoc" class="profile-item-title index-item">{{_("My Information") }}</h4>
                <div class="view-container">
                   <table>
                        <tr><td class="text-muted">{{_("Name")}}</td><td><div id="name_view"></div></td></tr>
                        <tr><td class="text-muted">{{_("Date of Birth")}}</td><td><div id="dob_view"></div></td></tr>
                        <tr><td class="text-muted">{{_("Email")}}</td><td><div id="email_view"></div></td></tr>
                        <tr><td class="text-muted">{{_("Cell")}}</td><td><div id="phone_view"></div></td></tr>
                        <tr><td class="text-muted">{{_("Phone (Other)")}}</td><td><div id="alt_phone_view"></div></td></tr>
                   </table>
                </div>
                <div class="edit-container">
                    {{profileName(person)}}
                    {{profileBirthDate(person)}}
                    {{profileEmail(person)}}
                    {{profilePhone(person)}}
                    {{profileAltPhone(person)}}
                </div>
                <div class="get-demo-error error-message"></div>
                <div class="put-demo-error error-message"></div>
            </div>
        </div>
    </div>
    {% if person and person.has_role(ROLE.PATIENT) %}
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="profile-item-container patient-detail-container editable" data-sections="detail">
                    <h4 id="patientDetailLoc" class="profile-item-title index-item">{{ _("My Detail") }}</h4>
                    <div class="view-container">
                        <table>
                            <tr class="gender-view"><td class="text-muted">{{_("Gender")}}</td><td><div id="gender_view"></div></td></tr>
                            <tr id="ethnicityViewRow" data-section-id="ethnicity" class="ethnicity-view optional"><td class="text-muted">{{_("Ethnicity")}}</td><td><div id="ethnicity_view"></div></td></tr>
                            <tr id="raceViewRow" data-section-id="race" class="race-view optional"><td class="text-muted">{{_("Race")}}</td><td><div id="race_view"></div></td></tr>
                            <tr id="indigenousViewRow" data-section-id="indigenous" class="indigenous-view"><td class="text-muted">{{_("Indigenous")}}</td><td><div id="indigenous_view"></div></td></tr>
                       </table>
                    </div>
                    <div class="flex edit-container">
                        {{profileGender(person)|show_macro('gender')}}
                        {{profileEthnicity(person)|show_macro('ethnicity')}}
                        {{profileRace(person)|show_macro('race')}}
                        {{profileIndigenous(person)|show_macro('indigenous')}}
                    </div>
                    <div class="no-data-container"></div>
                    <div class="get-demo-error error-message"></div>
                    <div class="put-demo-error error-message"></div>
                </div>
            </div>
        </div>
        <div class="row" id="profileSessionListMainContainer">
            <div class="col-md-12 col-xs-12">
                <div  class="profile-item-container">
                     <h4 id="proAssessmentsLoc" class="profile-item-title index-item">{{ _("My Questionnaires") }}</h4>
                    {{profileSessionList(person, current_user)}}
                </div>
            </div>
        </div>
        {%- if person and person.has_role(ROLE.PATIENT) %}
            <div class="row">
                <div class="col-md-12 col-xs-12">
                    <div class="profile-item-container">
                        <h4 id="patientReportsLoc" class="profile-item-title index-item">{{ _("My Reports") }}</h4>
                        {{patientReports(person)}}
                    </div>
                </div>
            </div>
        {%- endif %}
        {{profileClinicalQuestions(person, current_user) | show_macro('clinical_questions')}}
        {{profileProcedures(person, current_user) | show_macro('procedures')}}
        {%-if person.has_role(ROLE.PATIENT) and ROLE.PATIENT in config.CONSENT_EDIT_PERMISSIBLE_ROLES-%}
            <div class="row">
                <div class="col-md-12 col-xs-12">
                    <div class="profile-item-container editable" data-sections="org">
                        <h4 id="orgsLoc" class="profile-item-title index-item">{{ _("My Clinic") }}</h4>
                         {{profileOrgsSelector(person, current_user, consent_agreements)}}
                    </div>
                </div>
            </div>
        {%-else-%}
             <div class="row">
                <div class="col-md-12 col-xs-12">
                    <div class="profile-item-container {% if person and person.has_role(ROLE.ADMIN) %}editable{% endif %}" data-sections="org">
                        <h4 id="orgsLoc" class="profile-item-title index-item">{{ _("My Clinic") }}</h4>
                        {{profileOrg(person,None,consent_agreements, current_user)}}
                    </div>
                </div>
            </div>
        {%-endif-%}
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="profile-item-container">
                    <h4 id="consentHistoryLoc" class="profile-item-title index-item">{{_("My Agreement")}}</h4>
                    {{profileConsent(person, current_user)}}
                </div>
            </div>
        </div>
    {% else %}
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="profile-item-container {% if person and person.has_role(ROLE.ADMIN) %}editable{% endif %}" data-sections="org">
                    <h4 id="orgsLoc" class="profile-item-title index-item">{{ _("My Clinic") }}</h4>
                    {{profileOrg(person,None,consent_agreements, current_user)}}
                </div>
            </div>
        </div>
    {% endif %}
     <div class="row">
        <div class="col-md-12 col-xs-12">
            <div  class="profile-item-container editable" data-sections="locale, timezone">
                <h4 id="timeZoneLocaleLoc" class="profile-item-title index-item">{{_("My Locale / Time Zone")}}</h4>
                <div class="view-container">
                    <table>
                        <tr class="locale-view"><td class="text-muted">{{_("Language")}}</td><td><div id="locale_view"></div></td></tr>
                        <tr class="timezone-view"><td class="text-muted">{{_("Time Zone")}}</td><td><div id="timezone_view"></div></td></tr>
                    </table>
                    <div class="get-demo-error get-locale-error error-message"></div>
                    <div class="put-demo-error error-message"></div>
                </div>
                <div class="edit-container flex">
                    {{profileLocale(person)|show_macro('language')}}
                    {{profileTimeZone(person)}}
                </div>
            </div>
        </div>
    </div>
    {% if person and person.has_role(ROLE.ADMIN) and not person.has_role(ROLE.SERVICE) %}
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="profile-item-container">
                     <h4 id="rolesLoc" class="profile-item-title index-item">{{ _("My Roles") }}</h4>
                    {{profileRole(person, current_user)}}
                </div>
            </div>
        </div>
    {% endif %}
{%- endmacro %}

{% macro profile(person, current_user, consent_agreements, user_interventions, invite_email) -%}
    <!-- remember to add xs class to side when custom content is present -->
    {%- if config.CUSTOM_PATIENT_DETAIL -%}
        {%- if current_user and person and current_user.has_role(ROLE.STAFF) and person.has_role(ROLE.PATIENT) -%}
            {{ profileCustomDetail(person, invite_email) }}
        {%- endif -%}
    {%- endif -%}
    {% if person and person.has_role(ROLE.PATIENT) -%}
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <h4 class="profile-item-title detail-title">{{_("Patient Details")}}</h4>
            </div>
        </div>
    {%- endif %}
    <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="profile-item-container editable" data-sections="demo">
                <h4 id="patientInformationLoc" class="profile-item-title index-item">{% if person.has_role(ROLE.PATIENT) %}{{ _("Patient Information") }}{%else%}{{ _("User Information") }}{%endif%}</h4>
                <div class="view-container">
                   <table>
                        <tr><td class="text-muted">{{_("Name")}}</td><td><div id="name_view"></div></td></tr>
                        <tr><td class="text-muted">{{_("Date of Birth")}}</td><td><div id="dob_view"></div></td></tr>
                        <tr><td class="text-muted">{{_("Email")}}</td><td><div id="email_view"></div></td></tr>
                        {% if person.has_role('patient') %}<tr class="study-id-view"><td class="text-muted">{{_("Study Id")}}</td><td><div id="study_id_view"></div></td></tr>{% endif %}
                        {% if person.has_role('patient') %}<tr class="site-id-view"><td class="text-muted">{{_("Site Id")}}</td><td><div id="site_id_view"></div></td></tr>{% endif %}
                        <tr><td class="text-muted">{{_("Cell")}}</td><td><div id="phone_view"></div></td></tr>
                        <tr><td class="text-muted">{{_("Phone (Other)")}}</td><td><div id="alt_phone_view"></div></td></tr>
                   </table>

                </div>
                <div class="edit-container">
                    {{profileName(person)}}
                    {{profileBirthDate(person)}}
                    {{profileEmail(person)}}
                    {% if person.has_role('patient') %} {{profileStudyID(current_user)}} {% endif %}
                    {% if person.has_role('patient') %} {{profileSiteID(current_user)}} {% endif %}
                    {{profilePhone(person)}}
                    {{profileAltPhone(person)}}
                </div>
                <div class="get-demo-error error-message"></div>
                <div class="put-demo-error error-message"></div>
            </div>
        </div>
    </div>
    {%-if person and person.has_role(ROLE.PATIENT) %}
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="profile-item-container patient-detail-container editable" data-sections="detail">
                    <h4 id="patientDetailLoc" class="profile-item-title index-item">{% if person.has_role('patient') %}{{ _("Patient Detail") }}{%else%}{{ _("User Detail") }}{%endif%}</h4>
                    <div class="view-container">
                         <table>
                            <tr class="gender-view"><td class="text-muted">{{_("Gender")}}</td><td><div id="gender_view"></div></td></tr>
                            <tr data-section-id="ethnicity" class="ethnicity-view optional"><td class="text-muted">{{_("Ethnicity")}}</td><td><div id="ethnicity_view"></div></td></tr>
                            <tr data-section-id="race" class="race-view optional"><td class="text-muted">{{_("Race")}}</td><td><div id="race_view"></div></td></tr>
                            <tr data-section-id="indigenous" class="indigenous-view"><td class="text-muted">{{_("Indigenous")}}</td><td><div id="indigenous_view"></div></td></tr>
                       </table>
                    </div>
                    <div class="flex edit-container">
                        {{profileGender(person)|show_macro('gender')}}
                        {{profileEthnicity(person)|show_macro('ethnicity')}}
                        {{profileRace(person)|show_macro('race')}}
                        {{profileIndigenous(person)|show_macro('indigenous')}}
                    </div>
                    <div class="no-data-container"></div>
                    <div class="get-demo-error error-message"></div>
                    <div class="put-demo-error error-message"></div>
                </div>
            </div>
        </div>
    {%- endif %}
    {%- if person and person.has_role(ROLE.PATIENT) -%}
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="profile-item-container">
                    <h4 id="communicationsLoc" class="profile-item-title index-item">{{ _("Communications") }}</h4>
                    <div class="flex">
                        <div id="resetPasswordContainer" class="flex-item">
                            <p class="text-muted communication-prompt">{{_("Send reset password email to patient")}}</p>
                            {{resetPassword(person)}}
                        </div>
                        {%- if not config.CUSTOM_PATIENT_DETAIL -%}
                        <div id="registrationEmailContainer" class="flex-item"><p class="text-muted communication-prompt registration-email-prompt">{{_("Send registration email to patient")}}</p>{{profileSendEmail(person, invite_email)}}</div>
                        {%- endif %}
                    </div>
                </div>
            </div>
        </div>
    {%- elif person and person.has_role(ROLE.STAFF) and current_user and current_user.has_role(ROLE.STAFF_ADMIN)-%}
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="profile-item-container">
                    <h4 id="communicationsLoc" class="profile-item-title index-item">{{ _("Communications") }}</h4>
                    <div class="flex">
                        <div id="resetPasswordContainer" class="flex-item">
                            <p class="text-muted communication-prompt">{{_("Send reset password email to staff")}}</p>
                            {{resetPassword(person)}}
                        </div>
                        {%- if person and person.has_role(ROLE.WRITE_ONLY) -%}
                            <div id="registrationEmailContainer" class="flex-item"><p class="text-muted communication-prompt registration-email-prompt">{{_("Send registration email to user")}}</p>{{profileStaffRegistrationEmail(person)}}</div>
                        {%- endif -%}
                    </div>
                </div>
            </div>
        </div>
    {%- endif -%}
    <div class="row">
        <div class="col-md-12 col-xs-12">
            <div class="profile-item-container {% if (current_user and current_user.has_role(ROLE.STAFF) and ROLE.STAFF in config.CONSENT_EDIT_PERMISSIBLE_ROLES) or (current_user and current_user.has_role(ROLE.ADMIN)) or (person and person.has_role(ROLE.STAFF) and current_user and current_user.has_role(ROLE.STAFF_ADMIN))%}editable{% endif %}" data-sections="org">
                <h4 id="orgsLoc" class="profile-item-title index-item">{{ _("Clinic") }}</h4>
                {{profileOrg(person,None,consent_agreements, current_user)}}
            </div>
        </div>
    </div>
    {%- if person and (person.has_role(ROLE.PATIENT) or person.has_role(ROLE.PARTNER))%}
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="profile-item-container">
                    <h4 id="consentHistoryLoc" class="profile-item-title index-item">{% if config.CONSENT_WITH_TOP_LEVEL_ORG %}{{_("Agreement to Share Clinical Information")}} {%else%}{{ _("Consent History") }} {%endif%}</h4>
                    {{profileConsent(person, current_user)}}
                </div>
            </div>
        </div>
    {%- endif %}

    {%- if person and (person.has_role(ROLE.PATIENT)) and current_user and current_user.has_role(ROLE.INTERVENTION_STAFF) %}
        {{profileInterventions(user_interventions) | show_macro('interventions')}}
    {%- endif %}

    {%- if person and person.has_role(ROLE.PATIENT)%}
        <div class="row" id="profileSessionListMainContainer">
            <div class="col-md-12 col-xs-12">
                <div  class="profile-item-container">
                     <h4 id="proAssessmentsLoc" class="profile-item-title index-item">{% if current_user and current_user.has_role(ROLE.PATIENT) %}{{ _("My Questionnaires") }}{% else %}{{ _("PRO Questionnaires") }}{% endif %}</h4>
                    {{profileSessionList(person, current_user)}}
                </div>
            </div>
        </div>
    {%- endif %}

    {%- if person and person.has_role(ROLE.PATIENT) %}
        {{profileClinicalQuestions(person, current_user) | show_macro('clinical_questions')}}
    {%- endif %}

    {%- if person and person.has_role(ROLE.PATIENT) %}
        {{profileProcedures(person, current_user) | show_macro('procedures')}}
    {%- endif %}

    {%- if person and person.has_role(ROLE.PATIENT) %}
        {{profileInterventionReports(person) | show_macro('intervention_reports')}}
    {%- endif %}

    {%- if (person and current_user) and person.has_role(ROLE.PATIENT) %}
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="profile-item-container">
                    <h4 id="patientReportsLoc" class="profile-item-title index-item">{{ _("Patient Reports") }}</h4>
                    {{patientReports(person)}}
                </div>
            </div>
        </div>
    {%- endif %}
    {%- if (person and current_user) and person.has_role(ROLE.PATIENT) %}
        {{profileDeceased(person, current_user)}}
    {%- endif %}
    <div class="row">
        <div class="col-md-12 col-xs-12">
            <div  class="profile-item-container editable" data-sections="locale,timezone">
                <h4 id="timeZoneLocaleLoc" class="profile-item-title index-item">{{_("Locale / Time Zone")}}</h4>
                <div class="view-container">
                    <table>
                        <tr class="locale-view"><td class="text-muted">{{_("Language")}}</td><td><div id="locale_view"></div></td></tr>
                        <tr class="timezone-view"><td class="text-muted">{{_("Time Zone")}}</td><td><div id="timezone_view"></div></td></tr>
                    </table>
                    <div class="get-demo-error get-locale-error error-message"></div>
                    <div class="put-demo-error error-message"></div>
                </div>
                <div class="edit-container flex">
                    {{profileLocale(person)|show_macro('language')}}
                    {{profileTimeZone(person)}}
                </div>
            </div>
        </div>
    </div>
    {%- if (person and current_user) and current_user.has_role(ROLE.ADMIN) and not person.has_role(ROLE.SERVICE) %}
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="profile-item-container">
                     <h4 id="rolesLoc" class="profile-item-title index-item">{{ _("User Roles") }}</h4>{{profileRole(person, current_user)}}
                </div>
            </div>
        </div>
    {%- endif %}

    {%- if (person and current_user) and (current_user.has_role(ROLE.ADMIN) or current_user.has_role(ROLE.STAFF) or current_user.has_role(ROLE.INTERVENTION_STAFF)) %}
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="profile-item-container">
                    <h4 id="auditLogLoc" class="profile-item-title index-item">{{ _("Audit Log") }}</h4>
                    {{profileAuditLog(person, current_user)}}
                </div>
            </div>
        </div>
    {%- endif %}
{%- endmacro %}

{% macro profileProcedures(person, current_user) -%}
    <script src="{{ url_for('static', filename='js/procedures.js') }}"></script>
    <div class="row">
        <div class="col-md-12 col-xs-12">
            <div class="profile-item-container editable" data-sections="procedure">
                <h4 id="clinicalDataLoc" class="profile-item-title index-item">{% if person.id == current_user.id %}{{_("My Treatments")}}{%else%}{{ _("Clinical Data") }}{% endif %}</h4>
                <div class="view-container"><div id="procedure_view"></div></div>
                <div class="edit-container">
                    <p style="color: #696767">{%if (current_user and person) and current_user.has_role(ROLE.STAFF) and current_user.id != person.id %}{{ _("Which of the following prostate cancer management options has the patient had, if any? If you don&#39;t remember the exact date, please make your best guess.") }}{%else%}{{ _("Which of the following prostate cancer management options have you had, if any? If you don&#39;t remember the exact
                            date, please make your best guess.") }}{%endif%}<span class="text-muted smaller-text"></span></p><br/>
                    <div id="profileProcedureContainer">
                        <div id="procedureForm" class="form-inline event-element">
                            <p class="text-muted"><em>{{ _("Select")}}</em> {{ _("an option") }}:</p>
                            <div class="row">
                                <div class="col-md-6 col-xs-11">
                                    <div class='form-group'>
                                        <select class='form-control' id='tnthproc'>
                                            <option value=''>{{ _("Select") }}...</option>
                                            <option value='373818007'>{{ _("Started watchful waiting") }}</option>
                                            <option value='424313000'>{{ _("Started active surveillance") }}</option>
                                            <option value='26294005'>{{ _("Radical prostatectomy (nerve-sparing)") }}</option>
                                            <option value='26294005-nns'>{{ _("Radical prostatectomy (non-nerve-sparing)") }}</option>
                                            <option value='33195004'>{{ _("External beam radiation therapy") }}</option>
                                            <option value='228748004'>{{ _("Brachytherapy") }}</option>
                                            <option value='707266006'>{{ _("Androgen deprivation therapy") }}</option>
                                            <option value='999999999'>{{ _("None of the above") }}</option>
                                        </select>
                                        <div class="help-block with-errors"></div>
                                    </div>
                                </div>
                            </div>
                            <br/>
                            <div id="procDateGroup" class="form-group">
                                <label class="procedureDateLabel">{{ _("Date") }}:</label>
                                <div class="flex">
                                    <div class="flex-item">
                                        <input class="form-control" id="procDay" name="procDay" type="text" placeholder="DD" maxlength="2" />
                                    </div>
                                    <div class="flex-item">
                                        <select class="form-control" name="procMonth" id="procMonth">
                                            <option value="">{{ _("Month") }}...</option>
                                            <option value="01">{{ _("January") }}</option>
                                            <option value="02">{{ _("February") }}</option>
                                            <option value="03">{{ _("March") }}</option>
                                            <option value="04">{{ _("April") }}</option>
                                            <option value="05">{{ _("May") }}</option>
                                            <option value="06">{{ _("June") }}</option>
                                            <option value="07">{{ _("July") }}</option>
                                            <option value="08">{{ _("August") }}</option>
                                            <option value="09">{{ _("September") }}</option>
                                            <option value="10">{{ _("October") }}</option>
                                            <option value="11">{{ _("November") }}</option>
                                            <option value="12">{{ _("December") }}</option>
                                        </select>
                                    </div>
                                    <div class="flex-item">
                                        <input class="form-control" id="procYear" name="procYear" placeholder="YYYY" type="text" maxlength="4"/>
                                    </div>
                                    <div class="flex-item">
                                        <button class='btn btn-default' id='tnthproc-submit' name='tnthproc' data-name='' data-date='' data-date-read=''  type="submit" disabled><i class='fa fa-plus'></i>&nbsp;<span class="smaller-text">{{_("Save")}}</span></button>
                                    </div>
                                </div>
                                <div class="row">
                                     <div class="col-md-10 col-xs-10"><div id="procDateErrorContainer" class="help-block with-errors"></div></div>
                                </div>
                            </div>
                            <br />
                            <div id="eventListLoad"><i class="fa fa-spinner fa-spin fa-2x loading-message"></i></div>
                            <div id="pastTreatmentsContainer" class="inner">
                                 <hr style="border-bottom: 1px solid #e5e5e5"/>
                                {%- if person.id == current_user.id -%}
                                    <p class="text-muted">{{_("My History")}}:</p>
                                {%- else -%}
                                    <p class="text-muted"><em>{{_("Past")}}</em>&nbsp;{{ _("Management(s)") }}:</p>
                                {%- endif -%}
                                <div id="userProcedures"></div>
                            </div>
                            <br/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        var subjectId = {{ person.id if person}};
        var currentUserId = {{ current_user.id if current_user}};
        $(document).ready(function(){
            tnthAjax.getProc({{ person.id if person}}, false);
            __convertToNumericField($("#procYear, #procDay"));
        });
    </script>
{%- endmacro %}
{% macro profileSaveBtn() -%}
    <p id="saveMsg" class="error-message text-muted  bg-warning" style="display: none"><small>{{ _("You have updated your profile. Click the Save button to submit your changes.") }} {{ _("Or") }} <a href="">{{ _("cancel") }}</a>.</small></p>
    <p id="errorMsg" class="error-message text-muted  bg-danger" style="display: none"><small>{{ _("There is a problem with your profile. Please correct it before saving.") }}<br/>{{ _("Make sure all required fields are filled out and all entries are valid.") }}</small></p>
    <p id="serviceErrorMsg" class="error-message text-muted bg-danger" style="display: none"></p>
    <button id="updateProfile" type="submit" class="btn btn-lg btn-tnth-primary">{{ _("Save") }}</button>
    <span id="confirmMsg" class="text-muted tnth-hide small-text">&nbsp;&nbsp;<em>{{ _("Profile changes have been saved") }}</em></span>
{%- endmacro %}
{% macro accountCreationScript() -%}
    <script>
    var AccountCreationObj = function (roles) {
        this.attempts = 0;
        this.max_attempts = 3;
        this.params = null;
        this.roles = roles;
        this.userId = "None created";

        $.ajaxSetup({
            timeout: 5000,
            retryAfter:3000
        });

        this.__request = function(params) {
            if (!params) return false;
            if (!hasValue(params.apiUrl)) {
                if (params.callback) (params.callback).call(self, {"error": "API url is required."});
                return false;
            };
            var errorMessage = "";
            var self = this;
            self.attempts++;
            self.params = params;
            $.ajax ({
                type: (params.requestType ? params.requestType : 'GET'),
                url: String(params.apiUrl).replace('//', '/'),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: params.sync ? false : true,
                data: params.requestData
            }).done(function(data) {
                self.attempts = 0;
                if (params.callback) (params.callback).call(self, {"data": data});
            }).fail(function(xhr) {
                if (self.attempts < self.max_attempts) {
                    setTimeout ( function() { self.__request( self.params ) } , $.ajaxSetup().retryAfter );
                } else {
                    errorMessage = '{{_("Error processing request:")}} ' + params.apiUrl;
                    errorMessage += ";  response status code: " + (parseInt(xhr.status) == 0 ? "request timed out/network error": xhr.status);

                    $("#error_response_text").html($.trim(xhr.responseText));
                    var response_text =  $("#error_response_text").text();
                    errorMessage +=";  response text: " + (hasValue(response_text) ? response_text : "no response text returned from server");
                    self.attempts = 0;
                    if (params.callback) (params.callback).call(self, {"error": errorMessage});
                };
            });
            return errorMessage;
        };
        this.__setAccount = function() {
            var orgIDs = $('#userOrgs input:checked').map(function(){
                return { organization_id: $(this).val() };
            }).get();

            var _accountArray = {};
            _accountArray['organizations'] = orgIDs;
            if (this.roles) _accountArray['roles'] =  this.roles;
            _accountArray['consents'] = getConsents();

            //note, this will call put/demographics to update demographics after
            this.__request({'apiUrl': '/api/account', 'requestType': 'POST', 'requestData': JSON.stringify(_accountArray), 'sync': true, 'callback': this.__setDemo});
        };
        this.__setDemo = function(returnedData) {
            var responseData = returnedData && returnedData.data? returnedData.data : null;
            var self = this;
            if (responseData) {

                self.userId = responseData['user_id'];
                if (isNaN(self.userId)) {
                    self.__handleError("Invalid user id: " + self.userId);
                    self.__handleButton();
                    return false;
                };

                var _demoArray = {};
                _demoArray['resourceType'] = 'Patient';
                _demoArray['name'] = {
                    'given': $.trim($('input[name=firstname]').val()),
                    'family':$.trim($('input[name=lastname]').val())
                };
                _demoArray['birthDate'] = $('input[name=birthDate]').val();

                _demoArray['telecom'] = [];

                var emailVal = $.trim($('input[name=email]').val());
                if (hasValue(emailVal)) {
                    _demoArray['telecom'].push({ 'system': 'email', 'value': emailVal });
                } else {
                    _demoArray['telecom'].push({ 'system': 'email', 'value': '__no_email__'});
                };
                _demoArray['telecom'].push({ 'system': 'phone', 'use': 'mobile', 'value': $.trim($('input[name=phone]').val())});
                _demoArray['telecom'].push({ 'system': 'phone', 'use': 'home', 'value': $.trim($('input[name=altPhone]').val())});

                var orgIDs = $('#userOrgs input:checked').map(function(){
                    return { reference: 'api/organization/'+$(this).val() };
                }).get();

                _demoArray['careProvider'] = orgIDs;

                var arrCommunication = OT.getCommunicationArray();
                if (arrCommunication.length > 0) {
                    _demoArray['communication'] = arrCommunication;
                };

                /*** SYSTEM uri is defined by SYSTEM_IDENTIFIER_ENUM, see main.js for details **/
                var studyId = $("#profileStudyId").val();
                if (hasValue(studyId)) {
                    var studyIdObj = {
                        system: SYSTEM_IDENTIFIER_ENUM["external_study_id"],
                        use: "secondary",
                        value: studyId
                    };
                    if (!_demoArray["identifier"]) _demoArray["identifier"] = [];
                    _demoArray["identifier"].push(studyIdObj);
                };

                var siteId = $("#profileSiteId").val();
                if (hasValue(siteId)) {
                    var siteIdObj = {
                        system: SYSTEM_IDENTIFIER_ENUM["external_site_id"],
                        use: "secondary",
                        value: siteId
                    };
                    if (!_demoArray["identifier"]) _demoArray["identifier"] = [];
                    _demoArray["identifier"].push(siteIdObj);
                };


                var states = [];
                $("#userOrgs input[name='organization']").each(function() {
                    if ($(this).is(":checked")) {
                        if (hasValue($(this).attr("state"))) states.push($(this).attr("state"));
                    };
                });

                if (states.length > 0) {
                    if (!_demoArray["identifier"]) _demoArray["identifier"] = [];
                    states.forEach(function(state) {
                        _demoArray["identifier"].push({
                            system: SYSTEM_IDENTIFIER_ENUM["practice_region"],
                            use: "secondary",
                            value: "state:" + state
                        });
                    });
                };

                self.__request({'apiUrl':'/api/demographics/'+this.userId, 'requestType': 'PUT', 'requestData': JSON.stringify(_demoArray), 'sync': true, 'callback': this.__handleDisplay});

            } else {
                //Display Error Here
                if (returnedData.error) {
                   this.__handleError(returnedData.error);
                   this.__handleButton();
                };
            };
        };
        this.__handleDisplay = function(responseObj) {
            var err = responseObj && responseObj.error ? responseObj.error: null;
            var self = this;
            if (!hasValue(err)) {
                $('#confirmMsg').fadeIn();
                self.__handleButton();
                setTimeout(function() { $('#confirmMsg').fadeOut(); }, 800);
                setTimeout(function() { self.__redirect(self.userId); }, 1000);
                self.__clear();
            } else {
                self.__handleError(err);
                self.__handleButton();
            };
        };
        this.__handleError = function(errorMessage) {
            if (hasValue(errorMessage)) {
                $('#serviceErrorMsg').html('<small>[Processing error] ' + errorMessage + '</small>').fadeIn();
                tnthAjax.reportError(this.userId, "{{url_for('patients.patient_profile_create')}}", errorMessage, true);
            };
        };
        this.__redirect = function() {
            if (this.userId) {
                var isPatient = false;
                if (this.roles) {
                    this.roles.forEach(function(role) {
                        if (!isPatient && role.name.toLowerCase() == "patient") isPatient = true;
                    });
                };
                if (isPatient) {
                    $("#redirectLink").attr('href', '/patients/patient_profile/' + this.userId);
                } else $("#redirectLink").attr('href', '/profile/' + this.userId);
                $("#redirectLink")[0].click();
            };
        };
        this.__clear = function() {
            $("input.form-control, select.form-control").each(
                function() {
                    $(this).val("");
            });
        };
        this.__handleButton = function(vis) {
            if (vis == "hide") {
                $("#updateProfile").attr("disabled", true).hide();
                $(".save-button-container").find(".loading-message-indicator").show();
            } else {
                $("#updateProfile").attr("disabled", false).show();
                $(".save-button-container").find(".loading-message-indicator").hide();
            };
        };

        this.__checkFields = function(silent) {
            var hasError = false;

            /* check all required fields to make sure all fields are filled in */
            $("input[required], select[required]").each(function() {
                if (!hasValue($(this).val())) {
                    //this should display error message associated with empty field
                    if (!silent) $(this).trigger("focusout");
                    hasError = true;
                };
            });
            /* check email field */
            if ($("#noEmail").length > 0 && !$("#noEmail").is(":checked")) {
                if ($("#emailGroup").hasClass("has-error")) {
                    hasError = true;
                } else {
                    if ($("#current_user_email").val() === $("#email").val()) {
                        if (!silent) this.setHelpText("emailGroup", "{{_('Email is already in use.')}}", true);
                        hasError = true;
                    } else {
                        this.setHelpText("emailGroup", "", false);
                    };
                };
            };
            /* check organization */
            if ($("#userOrgs input").length > 0 && $("#userOrgs input:checked").length == 0) {
                if (!silent) this.setHelpText("userOrgs", "{{_('An organization must be selected.')}}", true);
                hasError = true;
            } else this.setHelpText("userOrgs", "", false);

            /* finally check fields to make sure there isn't error, e.g. due to validation error */
            $("#createProfileForm .help-block.with-errors").each(function() {
                if ($(this).text() != "") hasError = true;
            });

            if (hasError) {
                if (!silent) $("#errorMsg").fadeIn("slow");
            } else {
                $("#errorMsg").hide();
                $('#serviceErrorMsg').html('').hide();
            };
            return hasError;
        };

        this.clearError = function() {
            var hasError = this.__checkFields(true);
            if (!hasError) $("#errorMsg").html("").hide();
        };

        this.setHelpText = function(elementId, message, hasError) {
            if (hasError) $("#" + elementId).find(".help-block").text(message).addClass("error-message")
            else $("#" + elementId).find(".help-block").text("").removeClass("error-message");
        };
        this.getOrgs = function(callback) {
            var self = this;
            self.attempts++;
            $.ajax ({
                type: "GET",
                url: '/api/organization'
            }).done(function(data) {
                self.attempts = 0;
                if (data) {
                    if (callback) callback(data);
                } else {
                    if (callback) {
                        callback({"error": "{{_('no data returned')}}"});
                    };
                };
            }).fail(function() {
                /*
                 * retry here
                 */
                if (self.attempts < self.max_attempts) {
                    setTimeout ( function() { self.getOrgs( callback ) } , $.ajaxSetup().retryAfter );
                } else {
                    var errorMessage = '{{_("Error occurred retrieving clinics data.")}}';
                    if (callback) callback({"error": errorMessage});
                    self.attempts = 0;
                };
            });
        };
        function getParentOrgId(obj) {
            var parentOrgId =  $(obj).attr("data-parent-id");
            if (!hasValue(parentOrgId)) parentOrgId = $(obj).closest(".org-container[data-parent-id]").attr("data-parent-id");
            return parentOrgId;
        };

        function getConsents() {
            var orgs = {}, consents = [];
            $("#createProfileForm input[name='organization']").each(function() {
                if ($(this).prop("checked")) {
                    var consent_org_id;
                    {% if config.CONSENT_WITH_TOP_LEVEL_ORG %}
                        consent_org_id = getParentOrgId(this);
                    {% else %}
                        consent_org_id = $(this).val();
                    {% endif %}
                    if (consent_org_id && !orgs[consent_org_id]) {
                        orgs[consent_org_id] = true;
                        var agreement = $("#" + getParentOrgId(this) + "_agreement_url").val();
                        if (!hasValue(agreement)) {
                            var stockConsentUrl = $("#stock_consent_url").val();
                            agreement = stockConsentUrl.replace("placeholder", encodeURIComponent($(this).attr("data-parent-name")));
                        };
                        if (hasValue(agreement)) {
                            var ct = $("#consentDate").val();
                            var consentItem = {};
                            if (hasValue(ct)) {
                                consentItem["acceptance_date"] = ct;
                            };
                            consentItem["organization_id"] = consent_org_id;
                            consentItem["agreement_url"] = agreement;
                            consentItem["staff_editable"] = true;
                            consentItem["include_in_reports"] = true;
                            consentItem["send_reminders"] = true;
                            consents.push(consentItem);
                        };
                    };
                };
            });
            return consents;
        };
    };

    //events associated with elements on the account creation page
    $(document).ready(function(){
        $("#createProfileForm .back-button-container").prepend(__getLoaderHTML());
        $("#createProfileForm .save-button-container").prepend(__getLoaderHTML());
        $("#createProfileForm .btn-tnth-back").on("click", function(e) {
            e.preventDefault();
            $(this).prev(".loading-message-indicator").show();
            $(this).hide();
            window.location = $(this).attr("href");
        });
        $("#updateProfile").attr("disabled", true);
        $("#createProfileForm input, #createProfileForm select").on("focusout", function() {
            $("#updateProfile").attr("disabled", false);
            setTimeout(function() { aco.clearError(); }, 600);
        });
        $("#noEmail").on("click, change", function() {
            if ($(this).is(":checked")) {
                $("#erroremail").hide();
                $("#email").val("").attr("disabled", true).removeAttr("required").removeAttr("data-customemail");
                setTimeout('$("#erroremail").text(""); $("#email").closest("form-group").removeClass("has-error"); $("#email").css("border-color", "#ccc");', 600);
            }
            else {
                $("#erroremail").show();
                $("#email").attr("disabled", false).attr("required", "required").attr("data-customemail", "true");
            };
        });

        function getDateWithTimeZone(dObj) {
            /*
             * param is a date object
             * calculating UTC date using Date object's timezoneOffset method
             * the method return offset in minutes, so need to convert it to miliseconds
             * adding the resulting offset will be the UTC date/time
             */
            var utcDate = new Date(dObj.getTime()+(dObj.getTimezoneOffset())*60*1000);
            //I believe this is a valid python date format, will save it as GMT date/time
            //NOTE, conversion already occurred, so there will be no need for backend to convert it again
            return tnthDates.formatDateString(utcDate, "yyyy-mm-dd hh:mm:ss");
        }

        if ($("#consentDateEditContainer").length > 0) {
            //default consent date to today's date
            var today = new Date();
            var td = pad(today.getDate()), tm = pad(today.getMonth()+1), ty = pad(today.getFullYear());
            var th = today.getHours(), tmi = today.getMinutes(), ts = today.getSeconds();
            $("#consentDay").val(td);
            $("#consentMonth").val(tm);
            $("#consentYear").val(ty);
            //saving the consent date in GMT
            //default to today's date
            $("#consentDate").val(getDateWithTimeZone(tnthDates.getDateObj(ty, tm, td, th, tmi, ts)));
            if (_isTouchDevice()) {
                $("#consentDay, #consentYear").each(function() {
                    $(this).attr("type", "tel");
                });
            };
            $("#consentDay, #consentMonth, #consentYear").each(function() {
              $(this).on("change", function() {
                  var d = $("#consentDay");
                  var m = $("#consentMonth");
                  var y = $("#consentYear");
                  if (d.val() != "" && m.val() != "" && y.val() != "") {
                      if (this.validity.valid) {
                          var isValid = tnthDates.validateDateInputFields(m.val(), d.val(), y.val(), "errorConsentDate");
                          if (isValid) {
                            var timezoneOffset = Math.floor(((new Date()).getTimezoneOffset())/60);
                            //saving the time at 12
                            $("#consentDate").val(getDateWithTimeZone(tnthDates.getDateObj(y.val(),m.val(),d.val(),12,0,0)));
                            $("#errorConsentDate").text("").hide();
                            //success
                          } else {
                             //fail
                            $("#consentDate").val("");
                          };
                      };
                  };
              });
            });
        };
        $('#createProfileForm').validator().on('submit', function (e) {
            if (e.isDefaultPrevented()) {
                // handle the invalid form...
                aco.__checkFields();
                return false;
            } else {
               var hasError = aco.__checkFields();
               if (hasError) return false;

                // everything looks good!
                e.preventDefault();

                aco.__handleButton("hide");
                setTimeout("aco.__setAccount();", 0);

            };
        });
    });

    </script>
{%- endmacro %}
