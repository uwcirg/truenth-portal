{% from "initial_queries_macros.html" import patientQGroup %}

{% macro profileImage(person) -%}
    {% if person and person.image_url %}
        <div class="profile-img hidden-xs">
            <img src="{{ person and person.image_url }}" />
        </div>
    {% endif %}
{%- endmacro %}

{% macro profileBirthDate(person) -%}
    <input type="hidden" name="birthDate" id="birthday" value="{{ person and person.birthdate if person.birthdate }}">
    <div class="form-group profile-section" id="bdGroup">
        <label>{{ _("Birth Date") }}</label>
        <div class="row">
            <div class="col-md-4 col-xs-6">
                <input class="form-control bd-element" id="date" name="birthdayDate" error-field="errorbirthday" placeholder="DD" type="text" pattern="((0)?[1-9]|1\d|2\d|3[01])" maxlength="2" data-error="Birthday must be valid and in required format." required />
            </div>
            <div class="col-md-4 col-xs-10">
                <select class="form-control bd-element" name="birthdayMonth" id="month" error-field="errorbirthday" data-error="Birthday must be valid and in required format." required>
                    <option value="">{{ _("Month") }}...</option>
                    <option value="01">{{ _("January") }}</option>
                    <option value="02">{{ _("February") }}</option>
                    <option value="03">{{ _("March") }}</option>
                    <option value="04">{{ _("April") }}</option>
                    <option value="05">{{ _("May") }}</option>
                    <option value="06">{{ _("June") }}</option>
                    <option value="07">{{ _("July") }}</option>
                    <option value="08">{{ _("August") }}</option>
                    <option value="09">{{ _("September") }}</option>
                    <option value="10">{{ _("October") }}</option>
                    <option value="11">{{ _("November") }}</option>
                    <option value="12">{{ _("December") }}</option>
                </select>
            </div>
            <div class="col-md-4 col-xs-6">
                <input class="form-control bd-element" id="year" name="birthdayYear" placeholder="YYYY" pattern = "(19|20)\d{2}" type="text" maxlength="4" error-field="errorbirthday" data-error="Birthday must be valid and in required format." required />
            </div>
        </div>
        <div class="help-block with-errors"></div>
        <span id="errorbirthday" class="help-block" style="display: none; color:#a94442"></span>
     </div>
     <script>
        $(function () {// Fill in 3 birthday fields based on existing value - requires date format YYYY-MM-DD
            var currentBd = $("#birthday").val();
            if (currentBd) {
                var bdArray = currentBd.split("-");
                $("#year").val(bdArray[0]);
                $("#month").val(bdArray[1]);
                $("#date").val(bdArray[2]);
            };

            ["year", "month", "date"].forEach(function(fn) {
                var field = $("#" + fn);
                var triggerEvent = field.attr("type") == "text" ? "blur" : "change";
                field.on(triggerEvent, function() {
                    var y = $("#year"), m = $("#month"), d = $("#date");

                    if (y.get(0).validity.valid && m.get(0).validity.valid && d.get(0).validity.valid) {

                        var isValid = tnthDates.validateBirthDate(m.val(), d.val(), y.val() );
                        //console.log("valid? " + isValid)
                        if (isValid) {
                            $("#birthday").val(y.val() + "-" + m.val() + "-" + d.val());
                        } else {
                            $("#birthday").val("");
                            return false;
                        };
                    };
                    //assembleContent.demo({{person.id}}, true);
                });
            });

        });
     </script>
{%- endmacro %}

{% macro profileLocale(person) -%}
    <div class="form-group float-input-label profile-section">
        <label for="locale">{{ _("Language") }}</label>
        <select class="form-control" name="locale" id="locale">
          <option value="en_US" {{ "selected" if ((person and person.locale_code == "en_US") or ((not person or not person.locale_code) and config.get("DEFAULT_LOCALE") == "en_US")) }}>{{ _("American English") }}{{(" (" + _("Default") + ")") if config.get("DEFAULT_LOCALE") == "en_US" }}</option>
          <option value="en_AU" {{ "selected" if ((person and person.locale_code == "en_AU") or ((not person or not person.locale_code) and config.get("DEFAULT_LOCALE") == "en_AU")) }}>{{ _("Australian English") }}{{(" (" + _("Default") + ")") if config.get("DEFAULT_LOCALE") == "en_AU" }}</option>
          <!--<option value="es_ES" {{ "selected" if ((person and person.locale_code == "es_ES") or ((not person or not person.locale_code) and config.get("DEFAULT_LOCALE") == "es_ES")) }}>{{ _("Spanish") }}{{(" (" + _("Default") + ")") if config.get("DEFAULT_LOCALE") == "es_ES" }}</option> -->
        </select>
     </div>
     <script>$(function () {
        $('#locale').on('change', function() {
            setTimeout(function(){
                window.location.reload(true);
            },1000);
        });
     });</script>
{%- endmacro %}

{% macro profileName(person, isFocus=False) -%}
    <div class="form-group profile-name-label">
        <label>{{ _("Name") }}</label>
    </div>
    <div class="row profile-section name-section">
        <div class="col-md-6 col-xs-12">
            <div class="form-group float-input-label">
                <input {{"autofocus" if isFocus}} required="required" data-error="{{ _('First name is required') }}" class="form-control float-text" id="firstname" name="firstname" placeholder="{{ _('First Name') }}" value="{{ person.first_name if person and person.first_name }}" type="text" />
                <div class="help-block with-errors"></div>
            </div>
        </div>
        <div class="col-md-6 col-xs-12">
            <div class="form-group float-input-label">
                <input required="required" data-error="{{ _('Last name is required') }}" class="form-control float-text" id="lastname" name="lastname" placeholder="{{ _('Last Name') }}" value="{{ person.last_name if person and person.last_name }}" type="text" />
                <div class="help-block with-errors"></div>
            </div>
        </div>
    </div>
{%- endmacro %}

{% macro profileGender(person) -%}
    <div class="form-group profile-section" id="genderGroup">
        <label id="genderLabel">{{ _("Gender") }}</label>
        <div id="profile-gender-list" class="profile-radio-list">
            <label class="radio-inline">
                <input type="radio" name="sex" id="sexM" value="male" required {{ "checked" if person and person.gender == "male"}}/>
                {{ _("Male") }}
            </label>
            <label class="radio-inline">
                <input type="radio" name="sex" id="sexF" value="female" required {{ "checked" if person and person.gender == "female"}}/>
                {{ _("Female") }}
            </label>
            <label class="radio-inline">
                <input type="radio" name="sex" id="sexO" value="other" required {{ "checked" if person and person.gender == "other"}}/>
                {{ _("Other") }}
            </label>
        </div>
    </div>
{%- endmacro %}

{% macro profileIndigenous(person) -%}
    {% if person and person.org_coding_display_options.indigenous %}
        <div id="userIndigenousStatusContainer"></div>
        <script>
        $(function () {
            (function() {
                $.ajax({
                    type:"GET",
                    url: '/fhir/valueset/AU-NHHD-METeOR-id-291036'
                }).done(function(data) {
                    var as = data["codeSystem"]["concept"];
                    var html = '<div class="form-group profile-section" id="userIndigenousStatus">' +
                    '<label>{{ _("Indigenous Status") }}</label>' +'<div class="profile-radio-list">';
                    as.forEach(function(o) {
                        html += '<div>' + '<label>' +
                                '<input type="radio" name="indigenous" value="' + o.code + '">&nbsp;&nbsp;' + o.display + '</label></div>';
                    });
                    html += "</div></div>";
                    $("#userIndigenousStatusContainer").html(html);
                    getSaveLoaderDiv("profileForm", "userIndigenousStatus");
                    $("#userIndigenousStatusContainer input[type='radio']").each(function() {
                        $(this).attr("save-container-id", "userIndigenousStatus");
                        $(this).on("click", function() {
                            //console.log("value: " + $(this).val());
                            assembleContent.demo({{ person.id if person }},true, $(this));
                        });
                    });

                }).fail(function(){
                    console.log("Problem retrieiving indigenous statuses");
                });
            })();
        });
        </script>
    {% endif %}
{%- endmacro %}

{% macro profileRace(person) -%}
    {% if person and person.org_coding_display_options.race %}
        <div class="form-group profile-section" id="userRace">
            <label>{{ _("Race") }}</label>
            <div class="profile-radio-list">
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name="race" value="1002-5">{{ _("American Indian or Alaska Native") }}
                    </label>
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name="race" value="2028-9">{{ _("Asian") }}
                    </label>
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name="race" value="2054-5">{{ _("Black or African American") }}
                    </label>
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name="race" value="2076-8">{{ _("Native Hawaiian or Other Pacific Islander") }}
                    </label>
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name="race" value="2106-3">{{ _("White") }}
                    </label>
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name="race" value="2131-1">{{ _("Other") }}
                    </label>
                </div>
            </div>
        </div>
    {% endif %}
{%- endmacro %}

{% macro profileEthnicity(person) -%}
    {% if person and person.org_coding_display_options.ethnicity %}
        <div class="form-group profile-section" id="userEthnicity">
            <label>{{ _("Ethnicity") }}</label>
            <div class="profile-radio-list">
                <div class="radio">
                    <label>
                        <input type="radio" name="ethnicity" value="2135-2">{{ _("Hispanic or Latino") }}
                    </label>
                </div>
                <div class="radio">
                    <label>
                        <input type="radio" name="ethnicity" value="2186-5">{{ _("Not Hispanic or Latino") }}
                    </label>
                </div>
            </div>
        </div>
    {% endif %}
{%- endmacro %}

{% macro profileEmail(person) -%}
    <div class="form-group float-input-label profile-section" id="emailGroup">
        <label for="email">{{ _("Email Address") }}</label>
        <input type="text" class="form-control" id="email" name="email" error-field="erroremail" save-container-id="email" place-holder="{{ _('Your email') }}" value="{{ person.email if person and person.email and person.email != '__no_email__' }}" data-customemail="true" required>
        <div class="help-block with-errors" id="erroremail"></div>
    </div>
{%- endmacro %}

{% macro profileEmailForm(person) -%}
    {% if person %}
    <form id="sendEmailForm" action="{{ url_for('portal.invite') }}" method="POST">
        <input type="hidden" name="_userId" id="_userId" value="{{person.id}}" />
        <div class="registration-status-container">
            <span class="text-muted">Registration Status: </span>
            {% if person and person.has_role("write_only") %}<h4 class="text-warning registration-label">not yet registered</h4>
            {% else %}
            <h4 class="text-success registration-label">registered</h4>
            {% endif %}
        </div>
        <label id="sendEmailLabel" class="text-muted">{{ _("Send Email to Patient") }}</label>
        <select  id="profileEmailSelect" class="form-control bd-element">
            <option value="">{{ _("Select Email...") }}</option>
            {% if person.has_role('write_only') %}<option value="invite">{{ app_text('profileSendEmail option invite') }}</option>{% endif %}
            <option value="reminder">{{ app_text('profileSendEmail option reminder') }}</option>
        </select>
        <button id="btnProfileSendEmail" class="btn btn-tnth-primary disabled">{{ _("Send email") }}</button>
        <div id="profileEmailMessage" class="text-info"></div>
    </form>
    {% endif %}
{%- endmacro %}


{% macro profileSendEmail(person) -%}
    {% if person %}
    <div class="form-group float-input-label well well-lg" id="profileSendEmailContainer">
        {{profileEmailForm(person)}}
    </div>
    <script async>$(function () {

        function getAccessUrl() {
            var url = '';
            $.ajax ({
                type: 'GET',
                url: '/api/user/' + $("#_userId").val() + '/access_url',
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                async: false
            }).done(function(data) {
                url = data['access_url'];
                console.log(url);
            }).fail(function() {
                console.log('failed request');
            });
            return url;
        };

        $('#profileEmailSelect').on('change', function() {
            var message = '';
            if (this.value != '') {
                message =  $(this).children('option:selected').text() + ' email will be sent to ' + $('#email').val();
                $('#profileEmailMessage').text(message);
                $('#btnProfileSendEmail').removeClass('disabled');
            } else {
                $('#profileEmailMessage').text('');
                $('#btnProfileSendEmail').addClass('disabled');
            }
        });

        $('#btnProfileSendEmail').on('click', function(event) {
            event.preventDefault();
            var emailTypeElem = $('#profileEmailSelect');
            var selectedOption = emailTypeElem.children('option:selected');
            var email = $('#email').val();

            if (selectedOption.val() != '') {
                var subject = '';
                var body = '';
                var return_url = '';
                var clinicName = (function() {
                    var orgs = $("#userOrgs input[name='organization']:checked").not('[parent_org]');
                    var parentName = "";
                    if (orgs.length > 0 ) {
                        orgs.each(function() {
                            if (!parentName) {
                                parentName = $(this).attr("data-parent-name");
                                if (!hasValue(parentName)) parentName = $(this).closest(".org-container[data-parent-id]").attr("data-parent-name");
                                //console.log("pn: " + parentName)
                            };
                        });
                    };
                    var cn = parentName ? parentName: "your clinic";
                    return cn;
                })();
                if (selectedOption.val() == 'invite'){
                    return_url = getAccessUrl();
                    {# javascript variables are not available at template
                       rendering time.  insert a placeholder and then
                       replace once the variable is available. #}
                    body = '{{ app_text('profileSendEmail invite email_body',
                            'url_placeholder') | safe }}'.replace(/\(clinic name\)/g, clinicName);
                    body = body.replace(/url_placeholder/g, return_url);
                    subject = '{{ app_text('profileSendEmail invite email_subject') }}'.replace(/\(clinic name\)/g, clinicName);
                }
                else { // reminder
                    body = '{{ app_text('profileSendEmail reminder email_body', url_for('user.login', _external=True, email=person.email)) | safe }}'.replace(/\(clinic name\)/g, clinicName);
                    subject = '{{ app_text('profileSendEmail reminder email_subject') }}'.replace(/\(clinic name\)/g, clinicName);
                }
                if (body != '') {
                    $.ajax ({
                        type: 'POST',
                        url: '/invite',
                        contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                        data: {'subject': subject, 'recipients': email, 'body': body}
                    }).done(function(data) {
                       //console.log('data ' + data);
                        $('#profileEmailMessage').text(selectedOption.text() + ' email sent to ' + email);
                    }).fail(function() {
                        console.log('failed request');
                        $('#profileEmailMessage').text('Unable to send email.');
                    });
                } else {
                    $('#profileEmailMessage').text('Unable to generate URL for email');
                };
            };
        });


     });</script>
     {% endif %}
{%- endmacro %}

{% macro profilePhone(person) -%}
    <div class="form-group float-input-label profile-section">
        <label for="phone">{{ _("Cell") }} <span class="text-muted smaller-text">({{ _("Optional") }})</span></label>
        <input type="text" class="form-control" id="phone" name="phone" placeholder="{{ _('XXX-XXX-XXXX') }}" value="{{ person.phone if person and person.phone }}">
    </div>
{%- endmacro %}

<!--this has an ajax call to fill in the content-->
{% macro profileOrg(person, removeNone, consent_agreements, current_user) -%}
    <div class="form-group profile-section" id="userOrgs">
        {% if 'patient' in config.CONSENT_EDIT_PERMISSIBLE_ROLES %}<label>{{ _("Main clinic for prostate cancer care") }}</label>{%else%}
        <label>{{_("Clinics ")}}<span class="text-muted smaller-text">({{ _("Optional") }})</span></label>{% endif %}
        <div class="indent">
        <div id="fillOrgs"></div>
        <div class="noOrg-container" style="{{'display:none' if removeNone == 'true'}}"><label><input id="noOrgs" class="clinic" type="checkbox" name="organization" value="0"><span>{{ _("None of the Above") }}</span></label></div>
        </div>
        {% if consent_agreements %}{{consent(person, consent_agreements, current_user)}} {% endif %}
        <div class="help-block with-errors"></div>
    </div>
    <script>
        var CONSENT_WITH_TOP_LEVEL_ORG = {% if config.CONSENT_WITH_TOP_LEVEL_ORG %}true{% else %}false{% endif %};
        var ORG_EDIT_PERMISSIBLE_ROLES = {% if config.CONSENT_EDIT_PERMISSIBLE_ROLES %}{{ config.CONSENT_EDIT_PERMISSIBLE_ROLES|safe }}{% else %}false{% endif %};
        var orgsEditable = {% if (current_user.has_role(ROLE.STAFF) and ROLE.STAFF in config.CONSENT_EDIT_PERMISSIBLE_ROLES) or (current_user.has_role(ROLE.PATIENT) and ROLE.PATIENT in config.CONSENT_EDIT_PERMISSIBLE_ROLES) or current_user.has_role(ROLE.ADMIN) %}true{% else %}false{% endif %};
        //STAFF CANNOT EDIT THEIR OWN ORGS
        {% if not(current_user.has_role(ROLE.ADMIN)) and current_user.has_role(ROLE.STAFF) and (current_user.id == person.id) %}orgsEditable = false;{% endif %}

        function disableOrgs() {
            $("#userOrgs input[name='organization']").not('[parent_org]').each(function() {
                    $(this).attr("disabled", true);
            });
        };
        var leafOrgs = false;
        {% if current_user.has_role(ROLE.STAFF) and not(current_user.has_role(ROLE.ADMIN)) %}
            leafOrgs = {% if current_user.leaf_organizations() %} {{current_user.leaf_organizations() | safe}} {% else %} false {% endif %};
        {% endif %}
        $(function () {
            {% if consent_agreements %}tnthAjax.getConsent({{ person.id if person }}, true);{% endif %}
            tnthAjax.getOrgs({{ person.id if person }}, false, false, _handleOrgs);
        });

        function _handleOrgs() {

            if (leafOrgs) OT.filterOrgs(leafOrgs);
            if (!orgsEditable) disableOrgs();

            {% if (person.has_role('patient') or current_user.has_role('patient')) and 'patient' in config.CONSENT_EDIT_PERMISSIBLE_ROLES %}
                var userOrgs = $("#userOrgs input[name='organization']").not('[parent_org]');
                var checkedOrgs = {};
                userOrgs.each(function() {
                    if ($(this).prop("checked")) {
                        checkedOrgs[$(this).val()] = true;
                    };
                    $(this).attr("type", "radio");
                    if (checkedOrgs[$(this).val()]) {
                        $(this).prop("checked", true);
                    };
                });
            {% endif %}
            {% if (current_user.has_role('patient') or current_user.has_role('write_only')) and not('patient' in config.CONSENT_EDIT_PERMISSIBLE_ROLES) %}
                var userOrgs = $("#userOrgs input[name='organization']").not('[parent_org]');
                var checkedOrgs = [];
                userOrgs.each(function() {
                    if ($(this).prop("checked") && parseInt($(this).val()) != 0) {
                        checkedOrgs.push({
                            "id": $(this).val(),
                            "name": $("#org-label-" + $(this).val()).text()
                        });
                    };
                });
                if (checkedOrgs.length > 0) {
                    var html = "";
                    checkedOrgs.forEach(function(item) {
                        html += '<div id="' + item.id + '_container" class="org-container"><label id="org-label-' + item.id + '" class="org-label"><input class="clinic" type="checkbox" name="organization" id="' + item.id + '_org" value="' + item.id + '" disabled="disabled" checked>' + item.name + "</label></div>";
                    });
                    $("#fillOrgs").html(html);
                    $("div.noOrg-container").hide();
                } else {
                    if ($("#noOrgs").is(":checked")) {
                        $("#fillOrgs").html("<span class='text-muted'>No organization/affiliation</span>");
                        $("div.noOrg-container").hide();
                    };
                }

            {% endif %}
        };
    </script>
{%- endmacro %}

{% macro consent(person, consent_agreements, current_user) -%}
    {% if person and consent_agreements %}
        <div id="consentContainer">
            {% for org in consent_agreements %}
              <div id="{{org}}_consentItem" class="consent"><input type="hidden" id="{{org}}_agreement_url" value="{{consent_agreements[org].agreement_url}}" /></div>
            {% endfor %}
        </div>
    {% endif %}
{%- endmacro %}

{% macro patientReports(person) -%}
    <input type="hidden" id="pr_user_id" value="{{person.id}}"/>
    <div id="prTableToolBar"><span id="tableCount"></span></div>
    <table id="profilePatientReportTable" class="smaller-text">
    </table>
    <script async>

    $(function () {
         var ww = $(window).width();
         var prUserId = $("#pr_user_id").val();
         var userTimeZone = getUserTimeZone(prUserId);
         var userLocale = getUserLocale(prUserId);

        $.ajax ({
            type: "GET",
            url: '/api/user/' + $("#pr_user_id").val() + '/user_documents?document_type=PatientReport',
            contentType: "application/json; charset=utf-8",
            dataType: 'json'
        }).done(function(data) {
            if (data["user_documents"] && data["user_documents"].length > 0 ) {
                var fData = [];
                data["user_documents"].forEach(function(item) {
                    if (String(userTimeZone).toUpperCase() != "UTC") item["uploaded_at"] = convertUserDateTimeByLocaleTimeZone(String(item["uploaded_at"]), userTimeZone, userLocale);
                    else item["uploaded_at"] = String(item["uploaded_at"]).replace(/[tz]/gi, " ");
                    item["actions"] = '<a title="Download" href="' + '/api/user/' + String(item["user_id"]) + '/user_documents/' + String(item["id"]) + '"><i class="fa fa-arrow-down"></i></a>';
                    fData.push(item);
                });

                $('#profilePatientReportTable').bootstrapTable( {
                    data: fData,
                    pagination: true,
                    pageSize: 5,
                    pageList: [5, 10, 25, 50, 100],
                    classes: 'table table-responsive profile-patient-reports',
                    sortName: 'uploaded_at',
                    search: true,
                    smartDisplay: true,
                    showToggle: true,
                    showColumns: true,
                    toolbar: "#prTableToolBar",
                    rowStyle: function rowStyle(row, index) {
                          return {
                            css: {"background-color": (index % 2 != 0 ? "#F2F2F2" : "#FFF")}
                          };
                    },
                    undefinedText: '--',
                    columns: [
                        {
                            field: 'user_id',
                            title: 'User',
                            width: '5%',
                            sortable: true,
                            searchable: true
                        }, {
                            field: 'filename',
                            title: 'Filename',
                            searchable: true,
                            sortable: true
                        }, {
                            field: 'uploaded_at',
                            title: 'Uploaded At' + (userTimeZone == "UTC" ? " (GMT)" : ""),
                            sortable: true,
                            searchable: true,
                            width: '20%'
                        }, {
                            field: 'document_type',
                            title: 'Document Type',
                            sortable: true,
                            visible: false
                        }, {
                            field: 'actions',
                            title: 'Actions',
                            sortable: false,
                            searchable: false,
                            visible: true
                        }
                    ]
                } );
            } else {
                $("#profilePatientReportTable").closest("div.profile-item-container").hide();
            }


        }).fail(function() {
            $("#profilePatientReportTable").closest("div.profile-item-container").hide();
            console.log("Problem retrieving patient reports from server.");
        });
     });</script>
{%- endmacro %}

{% macro profileConsent(person, current_user) -%}
    {% if person %}
    <div id="profileConsentList"></div>
    <script async>
        var CONSENT_EDIT_PERMISSIBLE_ROLES = {% if config.CONSENT_EDIT_PERMISSIBLE_ROLES %}{{ config.CONSENT_EDIT_PERMISSIBLE_ROLES|safe }}{% else %}false{% endif %};
        var consentEditable = {% if (current_user.has_role(ROLE.STAFF) and ROLE.STAFF in config.CONSENT_EDIT_PERMISSIBLE_ROLES) or (current_user.has_role(ROLE.PATIENT) and ROLE.PATIENT in config.CONSENT_EDIT_PERMISSIBLE_ROLES) or current_user.has_role(ROLE.ADMIN) %}true{% else %}false{% endif %};
        var _isAdmin = {%if current_user.has_role(ROLE.ADMIN) %}true{%else%}false{%endif%};

        /**** this function is used when this section becomes editable ****/
        function reloadConsentList() {
            var eventLoading = '<div style="margin: 1em" id="consentListLoad"><i class="fa fa-spinner fa-spin fa-2x loading-message"></i></div>';
            $("#profileConsentList").animate({opacity: 0}, function() {
                    $(this).html(eventLoading).css('opacity',1);
                    // Set a one second delay before getting updated list. Mostly to give user sense of progress/make it
                    // more obvious when the updated list loads
                    setTimeout(function(){
                        tnthAjax.getConsent({{person.id}});
                    },1000);

            });
        };
        $(function () {
            setTimeout("tnthAjax.getConsent({{person.id}}, false);", 500);
        });
    </script>
    {% endif %}
{%- endmacro %}

{% macro profileAuditLog(person, current_user) -%}
    {% if (person and current_user) and (current_user.has_role(ROLE.ADMIN) or current_user.has_role(ROLE.STAFF)) %}
        <input type="hidden" id="audit_user_id" value="{{person.id}}"/>
        <div id="auditTableToolBar"><span id="tableCount"></span></div>
        <table id="profileAuditLogTable" class="smaller-text">
        </table>
        <script async>
        function _showText(obj) {
            if (obj) {
                var f = $(obj).parent().find('.second');
                f.toggleClass('hide');
                $(obj).text($(obj).text() ==='More...' ? 'Less...': 'More...');
            }
        }

        $(function () {
             var ww = $(window).width();
             var auditUserId = $("#audit_user_id").val();
             var userTimeZone = getUserTimeZone(auditUserId);
             var userLocale = getUserLocale(auditUserId);

            $.ajax ({
                type: "GET",
                url: '/api/user/' + $("#audit_user_id").val() + '/audit',
                contentType: "application/json; charset=utf-8",
                dataType: 'json'
            }).done(function(data) {
                //console.log(data["audits"]);
                if (data["audits"] && data["audits"].length > 0 ) {
                    var fData = [];
                    data["audits"].forEach(function(item) {
                        item["by"] = item["by"]["reference"];
                        //item["lastUpdated"] = item["lastUpdated"].replace("T", " ");
                        var r = /\d+/g;
                        var m = r.exec(String(item["by"]));
                        if (m) item["by"] = m[0]
                        else item["by"] = "-";
                        //console.log(r.exec(String(item["by"])));

                        if (String(userTimeZone).toUpperCase() != "UTC") item["lastUpdated"] = convertUserDateTimeByLocaleTimeZone(String(item["lastUpdated"]), userTimeZone, userLocale);
                        else item["lastUpdated"] = String(item["lastUpdated"]).replace(/[tz]/gi, " ");
                        var c = String(item["comment"]);
                        var len = ((ww < 650) ? 20 : (ww < 800? 40 : 80));

                        item["comment"] = c.length > len ? (c.substring(0, len+1) + "<span class='second hide'>" + c.substr(len+1) + "</span><br/><sub onclick='_showText(this)' class='pointer text-muted'>More...</sub>") : item["comment"];
                        fData.push(item);
                    });

                    $('#profileAuditLogTable').bootstrapTable( {
                        data: fData,
                        pagination: true,
                        pageSize: 5,
                        pageList: [5, 10, 25, 50, 100],
                        classes: 'table table-responsive profile-audit-log',
                        sortName: 'lastUpdated',
                        search: true,
                        smartDisplay: true,
                        showToggle: true,
                        showColumns: true,
                        toolbar: "#auditTableToolBar",
                        rowStyle: function rowStyle(row, index) {
                              return {
                                css: {"background-color": (index % 2 != 0 ? "#F2F2F2" : "#FFF")}
                              };
                        },
                        undefinedText: '--',
                        columns: [
                            {
                                field: 'by',
                                title: 'User',
                                width: '5%',
                                sortable: true,
                                searchable: true
                            }, {
                                field: 'comment',
                                title: 'Comment',
                                searchable: true,
                                sortable: true
                            }, {
                                field: 'lastUpdated',
                                title: 'Date/Time' + (userTimeZone == "UTC" ? "<span class='gmt'> (GMT)</span>" : ($(".timezone-error").text() == "" ? "" : ("<span class='gmt'> (GMT)</span>"))),
                                sortable: true,
                                searchable: true,
                                /******
                                sorter: function(a, b) {
                                    return new Date(b).getTime() - new Date(a).getTime();
                                },
                                ****/
                                width: '20%'
                            },
                            {
                                field: 'version',
                                title: 'Version',
                                sortable: true,
                                visible: false
                            }
                        ]
                    } );
                } else {
                    $("#profileAuditLogTable").closest("div.profile-item-container").hide();
                }


            }).fail(function() {
                $("#profileAuditLogTable").closest("div.profile-item-container").hide();
                console.log("Problem retrieving audit log from server.");
            });
         });</script>
     {% endif %}
{%- endmacro %}

{% macro profileRole(person, current_user) -%}
    {% if (person and current_user) and current_user.has_role('admin') and not person.has_role('service') %}
        <h4 class="text-muted">{% if person and person.username %}{{ _("for") + " " + person.username }} {% endif %}</h4>
        <p class="small-text text-muted">{{ _("Editable by admins only.") }}</p>
        <!-- roles are populated in main.js -->
        <div class="form-group" id="rolesGroup" style="margin-left: 10px"></div>
    {% endif %}
    {% if person %}
    <script async>
    $(function () {
        tnthAjax.getRoleList();
        tnthAjax.getRoles({{ person.id }}, true);
        $("#rolesGroup input[name='user_type']").each(function() {
            $(this).on("click", function() {
                var roles = $("#rolesGroup input:checkbox:checked").map(function(){
                    return { name: $(this).val() };
                }).get();
                var toSend = {"roles": roles};
                //console.log('update role: ' + toSend);
                tnthAjax.putRoles({{person.id}},toSend);
             });
        });
    });
    </script>
    {% endif %}

{%- endmacro %}

{% macro profileSessionList(person, current_user) -%}

    <div class="form-group profile-section" id="userSessionsListContainer">

        <input type="hidden" id="_session_user_id" value="{{person.id if person}}"/>
        <table id="userSessionListTable" class="tnth-admin-table table table-hover table-condensed table-striped table-bordered table-responsive small-text">
            <caption>{{ _("Session History") }} <span class="text-muted smaller-text">({{ _("click each row to review report") }})</span></caption>
            <tr><th>{{ _("Questionnaire Name") }}</th><th>{{ _("Status") }}</th><th>{{ _("Last Updated") }} <small id="gmtText" class="gmt">( {{ _("GMT Time Zone") }} )</small></th></tr>
        </table>
        <div id="profileSessionListError" style="color: #a94442"></div>
    </div>
    <script async>
        $(function () {
        var sessionListHTML = "";
        var sessionUserId = $("#_session_user_id").val();
        var userTimeZone = getUserTimeZone(sessionUserId);
        var userLocale = getUserLocale(sessionUserId);

        $.ajax ({
                type: "GET",
                url: '/api/patient/' + sessionUserId + '/assessment',
                contentType: "application/json; charset=utf-8",
                dataType: 'json'
            }).done(function(data) {
                var entries = data.entry ? data.entry : null;
                if (entries && entries.length > 0) {
                    entries.forEach(function(entry, index) {

                        var reference = entry['questionnaire']['reference'];
                        var arrRefs = String(reference).split('/');
                        var instrumentId = arrRefs.length > 0 ? arrRefs[arrRefs.length - 1] : "";
                        var authoredDate = String(entry['authored']);
                        var originalAuthoredDate = authoredDate;
                        if (userTimeZone != "UTC") {
                            authoredDate = convertUserDateTimeByLocaleTimeZone(authoredDate, userTimeZone, userLocale);
                            if($(".timezone-error").text() == "") $("#gmtText").hide();
                        }
                        else {
                            $("#gmtText").show();
                        }
                        if (instrumentId) {
                            var reportLink = '/patients/sessionReport/' + sessionUserId + '/' + instrumentId + "/" + originalAuthoredDate;
                            sessionListHTML += '<tr title="Click to view report"  ' +
                                                (index % 2 != 0 ? 'class="odd"': 'class="even"') + '>' +
                                                [entry['questionnaire']['display'],
                                                 entry['status'],
                                                 authoredDate.replace(/[tz]/gi, " ")].map(function(o) {
                                                    return  '<td><a href="' + reportLink + '">' + o + '</a></td>'
                                                 }).join('') +
                                                 '</tr>';
                        };
                    });
                        $("#userSessionListTable").append(sessionListHTML);
                        $("#userSessionListTable").show();

                } else {
                    $("#userSessionListTable").hide();
                    $("#userSessionsListContainer").append("<span class='text-muted'>No Questionnaire Data Found.</span>");
                };

            }).fail(function() {
                console.log("Problem retrieving session data from server.");
                $("#userSessionListTable").hide();
                $("#profileSessionListError").html("Problem retrieving session data from server.");
            });

    });
    </script>
{%- endmacro %}
{% macro profileAssessment(person, instrument_id, authored_date) -%}

        <div id="userSessionReportDetail" cellpadding="2">
            <input type="hidden" id="_report_user_id" value="{{person.id if person}}" />
            <input type="hidden" id="_report_authored_date" value="{{authored_date}}" />
            <table class="tnth-admin-table table table-condensed table-striped table-bordered small-text" id="userSessionReportDetailTable" ></table><br />
        </div>
        <script>
        $(function () {

            if (!(_isTouchDevice())) $('#userSessionReportDetailHeader [data-toggle="tooltip"]').tooltip();

            var sessionListHTML = "";
            var sessionUserId = $("#_report_user_id").val();
            var sessionAuthoredDate = $("#_report_authored_date").val();
            var userTimeZone = getUserTimeZone(sessionUserId);
            var userLocale = getUserLocale(sessionUserId);
            var convertedAuthoredDate = convertUserDateTimeByLocaleTimeZone(sessionAuthoredDate, userTimeZone, userLocale);

            $.ajax ({
                    type: "GET",
                    url: '/api/patient/' + sessionUserId + '/assessment/{{instrument_id}}',
                    contentType: "application/json; charset=utf-8",
                    dataType: 'json'
                }).done(function(data) {
                    //console.log(data)
                    $(".report-error-message").hide();
                    $("#userSessionReportDetailTable").html('');
                    if (data.entry && data.entry.length > 0) {
                        var entries = data['entry'];
                        var entry;
                        entries.forEach(function(item) {
                            if (!entry && (item["authored"] == sessionAuthoredDate)) entry = item;
                        });

                        if (!entry) entry = entries[0];
                        var reportHTML = '<caption><hr/><span class="profile-item-title">' +
                                        entries[0]['questionnaire']['display'] +
                                        '</span><br/><span class="text-muted smaller-text">Last Updated - ' +
                                        String(entry['authored']).replace(/[tz]/gi, " ") +
                                        convertedAuthoredDate.replace(/[tz]/gi, " ") +
                                        (String(userTimeZone).toLowerCase() == "utc" ? " <span class='gmt'>GMT</span>": "") + '</span><hr/></caption>';
                        reportHTML += '<tr><TH>Question</TH><TH>Response</TH></tr>';
                        entry['group']['question'].forEach(function(entry) {
                            var q = entry['text'] ? entry['text'] : '';
                            var sq = "";
                            sq = q.replace(/^[\d\w]{1,3}\./, "");  //replace question # in the beginning of the question

                            var a = entry['answer'] && entry['answer'][0] && entry['answer'][0]['valueString'] ? entry['answer'][0]['valueString'] : 'undefined';
                            reportHTML += '<tr><td>' + sq + '</td><td>' + (String(a) !== 'undefined' ? a : '--') + '</td></tr>';
                        });
                        $("#userSessionReportDetailTable").append(reportHTML);

                    }
                    //console.log(data);

                }).fail(function(xhr) {
                    console.log("Problem retrieving session data from server.");
                    $(".report-error-message").show();
                    $(".report-error-message").append("<br/>" + xhr.responseText);

                });

        });
        </script>

{%- endmacro %}

{% macro profileClinicalPCALocalized(person, current_user) -%}
 <div class="row">
        <div class="col-md-12">
            <div class="profile-item-container">
                <h4 id="clinicalQuestionsLoc" class="profile-item-title index-item">{{ _("Clinical Question") }}</h4>
                <p class="text-muted">{{ _("Question inquired of the patient at account creation") }}</p>
                <input type="hidden" id="iq_userId" value="{{person.id if person}}" />
                <div id="pcaLocalizedContainer" class="well" style="margin-top: 1em; padding: 0.7em 2em 1em 2em">
                     <div id="patMeta" data-topic="pca_localized" class="pat-q">
                      <br />
                      <p>{{ _("Is the prostate cancer only within the prostate?") }}</p>
                      <div class="form-group">
                        <div class="radio">
                          <label>
                            <input type="radio" class="init-queries-field" save-container-id="pcaLocalizedContainer" name="pca_localized" id="pca_localized_yes" value="true"> {{ _("Yes") }}
                          </label>
                        </div>
                        <div class="radio">
                          <label>
                            <input type="radio" class="init-queries-field" save-container-id="pcaLocalizedContainer" name="pca_localized" id="pca_localized_no" value="false"> {{ _("No (the cancer is in other parts of my body, too)") }}
                          </label>
                        </div>
                      </div>
                    </div>
                </div>
            </div>
        </div>
</div>
<script>
    {% if person %}
        $(function () {
            tnthAjax.getClinical({{ person.id }});
            $("#pca_localized_yes").on("click", function() {
                tnthAjax.putClinical({{person.id}},"pca_localized","true", $(this));
                setTimeout('adjustAssessmentInstrument();', 1000);
            });
            $("#pca_localized_no").on("click", function() {
                tnthAjax.putClinical({{person.id}},"pca_localized","false", $(this));
                setTimeout('adjustAssessmentInstrument();', 1000);
            });
            getSaveLoaderDiv("profileForm", "pcaLocalizedContainer");
        });
    {% endif %}

</script>
{%- endmacro %}

{% macro profileClinicalQuestions(person, current_user) -%}
    <div class="row">
        <div class="col-md-12">
            <div class="profile-item-container">
                <h4 id="clinicalQuestionsLoc" class="profile-item-title index-item">{{ _("Clinical Questions") }}</h4>
                <h4 class="text-muted">{{ _("Questions inquired of the patient at registration") }}</h4>
                <input type="hidden" id="iq_userId" value="{{person.id if person}}" />
                <div id="patientQContainer" class="well" style="margin-top: 1em; padding: 0.8em 2em 2em 2em">
                    {{patientQGroup(current_user)}}
                </div>
            </div>
        </div>
    </div>
    <script>
        function checkDiagnosis() {
            var diag = $("#pca_diag_yes");

            if (diag.is(":checked")) {
              diag.parents(".pat-q").nextAll().fadeIn();
            } else {
              diag.parents(".pat-q").nextAll().fadeOut();
            };
            {% if person and current_user and (person.id != current_user.id) %}
                if (!$("#patientQ input[type='radio']").is(":checked")) {
                    $("#patientQContainer").append("<span class='text-muted'>{{ _('no answers provided') }}</span>");
                };
            {% endif %}

        };
        $(function () {
            $("#patientQ").show();
            $("#patTx").remove();

            $("#patientQ hr").hide();
            {% if person and current_user and person.id != current_user.id %}
                $("#patientQ input[type='radio']").each(function() {
                    $(this).attr("disabled", "disabled");
                });
            {% endif %}

            {% if person %}
                $(".pat-q input:radio").on("click",function(){
                      var thisItem = $(this);
                      var toCall = thisItem.attr("name")
                      // Get value from div - either true or false
                      var toSend = thisItem.val();
                      tnthAjax.putClinical({{person.id}},toCall,toSend, $(this));

                      if (toSend == "true" || toCall ==  "pca_localized") {
                        thisItem.parents(".pat-q").nextAll().fadeIn();
                      } else {
                        if (toCall == "biopsy") {
                            ["pca_diag", "pca_localized"].forEach(function(fieldName) {
                                $("input[name='" + fieldName + "']").each(function() {
                                    $(this).prop("checked", false);
                                });
                            });
                            if ($("input[name='pca_diag']").length > 0) {
                                tnthAjax.putClinical({{person.id}},"pca_diag","false", $(this));
                            };
                            if ($("input[name='pca_localized']").length > 0) {
                                tnthAjax.putClinical({{person.id}},"pca_localized","false", $(this));
                            };
                        } else if (toCall == "pca_diag") {
                            ["pca_localized"].forEach(function(fieldName) {
                              $("input[name='" + fieldName + "']").each(function() {
                                  $(this).prop("checked", false);
                              });
                            });
                            if ($("input[name='pca_localized']").length > 0) {
                                tnthAjax.putClinical({{person.id}},"pca_localized","false", $(this));
                            };
                        }
                        thisItem.parents(".pat-q").nextAll().fadeOut();
                      };
                  });
             {% endif %}

            [{
                "fields": $("#patientQ input[name='biopsy']"),
                "containerId": "patBiopsy"
            },
            {
                "fields": $("#patientQ input[name='pca_diag']"),
                "containerId": "patDiag"
            },
            {
                "fields": $("#patientQ input[name='pca_localized']"),
                "containerId": "patMeta"
            }
            ].forEach( function(item) {
                item.fields.each(function() {
                     getSaveLoaderDiv("profileForm", item.containerId);
                    $(this).attr("save-container-id", item.containerId);
                });
            });

            //wait for ajax calls to finish?
            //hide rest of the questions if the patient hasn't been diagnosed with prostate cancer
            setTimeout("checkDiagnosis();", 1000);


        });
    </script>
{%- endmacro %}

{% macro profileInterventionReports(person) -%}
    <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="profile-item-container">
                    <h4 id="interventionReportsLoc" class="profile-item-title index-item">{{ _("Intervention Reports") }}</h4>
                    <div>
                        {% if person and person.staff_html() %}
                            {{person.staff_html() | safe}}
                        {% else %}
                            <div class="text-muted">{{ _("No Reports Available") }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
    </div>
{%- endmacro %}

{% macro profileTimeZone(person) %}
    <div id="profileTimeZoneGroup" class="form-group">
        <label>Time Zone</label>
        <select class="form-control" id="profileTimeZone" save-container-id="profileTimeZone">
            <option value="UTC">-- Select --</option>
            <option value="America/Denver">America/Denver</option>
            <option value="America/Los_Angeles">America/Los Angeles</option>
            <option value="America/Indianapolis">America/Indianapolis</option>
            <option value="America/New_York">America/New York</option>
            <option value="Australia/Adelaide">Australia/Adelaide</option>
            <option value="Australia/Brisbane">Australia/Brisbane</option>
            <option value="Australia/Broken_Hill">Australia/Broken_Hill</option>
            <option value="Australia/Canberra">Australia/Canberra</option>
            <option value="Australia/Currie">Australia/Currie</option>
            <option value="Australia/Darwin">Australia/Darwin</option>
            <option value="Australia/Eucla">Australia/Eucla</option>
            <option value="Australia/Hobart">Australia/Hobart</option>
            <option value="Australia/Lindeman">Australia/Lindeman</option>
            <option value="Australia/Lord_Howe">Australia/Lord_Howe</option>
            <option value="Australia/Melbourne">Australia/Melbourne</option>
            <option value="Australia/North">Australia/North</option>
            <option value="Australia/Perth">Australia/Perth</option>
            <option value="Australia/Queensland">Australia/Queensland</option>
            <option value="Australia/South">Australia/South</option>
            <option value="Australia/Sydney">Australia/Sydney</option>
            <option value="Australia/Tasmania">Australia/Tasmania</option>
            <option value="Australia/Victoria">Australia/Victoria</option>
            <option value="Australia/West">Australia/West</option>
            <option value="Australia/Yancowinna">Australia/Yancowinna</option>
        </select>
    </div>
    <div class="timezone-warning"></div>
    <div class="timezone-error"></div>
    <script>
    {% if person %}
    $(function() {
        getSaveLoaderDiv("profileForm", "profileTimeZone");
        $('#profileTimeZone').on('change', function() {
            $(".timezone-error").html("");
            $(".timezone-warning").html("");
            assembleContent.demo({{ person.id }},true, $(this), true);
            if ($.trim($("#profileTimeZone_error").text()) == "") {
                setTimeout(function(){
                    window.location.reload(true);
                },1000);
            };
        });
    });
    {% endif %}
    </script>
{%-endmacro %}

{% macro profileDeceased(person, current_user) -%}
    <div class="row">
        <div class="col-md-12 col-xs-12">
            <div class="profile-item-container">
                <h4 id="deathLoc" class="profile-item-title index-item">{{ _("Deceased Status") }}</h4>
                <br/>
                <input type="hidden" id="deathDate" value="" />
                <div class="checkbox" id="boolDeathGroup">
                    <label>
                        <input type="checkbox" name="boolDeath" id="boolDeath" value="1" save-container-id="boolDeathGroup">{{ _("Has the patient passed away?") }}
                    </label>
                </div>
                <hr/>
                <div class="form-group">
                    <label class="text-muted">{{ _("Deceased Date") }}</label>
                </div>
                <div class="row" style="margin-top:-8px">
                    <div class="col-md-3 col-xs-6">
                        <div class="form-group profile-section">
                            <input class="form-control" id="deathDay" name="deathDay" save-container-id="deathDay" placeholder="DD" type="text" pattern="\d[\d]?" maxlength="2" required />
                             <div class="help-block with-errors"></div>
                        </div>
                    </div>
                    <div class="col-md-3 col-xs-10">
                        <div class="form-group profile-section">
                            <select class="form-control" name="deathMonth" id="deathMonth" save-container-id="deathMonth" required>
                                <option value="">{{ _("Month") }}...</option>
                                <option value="01">{{ _("January") }}</option>
                                <option value="02">{{ _("February") }}</option>
                                <option value="03">{{ _("March") }}</option>
                                <option value="04">{{ _("April") }}</option>
                                <option value="05">{{ _("May") }}</option>
                                <option value="06">{{ _("June") }}</option>
                                <option value="07">{{ _("July") }}</option>
                                <option value="08">{{ _("August") }}</option>
                                <option value="09">{{ _("September") }}</option>
                                <option value="10">{{ _("October") }}</option>
                                <option value="11">{{ _("November") }}</option>
                                <option value="12">{{ _("December") }}</option>
                            </select>
                            <div class="help-block with-errors"></div>
                        </div>
                    </div>
                    <div class="col-md-3 col-xs-6">
                        <div class="form-group profile-section">
                            <input class="form-control" id="deathYear" name="deathYear" placeholder="YYYY" pattern = "\d{4}" type="text" maxlength="4" save-container-id="deathYear" required />
                            <div class="help-block with-errors"></div>
                        </div>
                    </div>
                </div>
                <div id="errorDeathDate" style="color:#a94442"><div>
                <br/>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(
            function() {
                getSaveLoaderDiv("profileForm", "boolDeathGroup");
                $("#boolDeath").on("change", function() {
                    if (!($(this).is(":checked"))) {
                        $("#deathYear").val("");
                        $("#deathDay").val("");
                        $("#deathMonth").val("");
                        $("#deathDate").val("");
                    }
                    assembleContent.demo({{person.id}}, true, $(this));
                });

                ["deathDay", "deathMonth", "deathYear"].forEach(function(fn) {
                    getSaveLoaderDiv("profileForm", fn);
                    var fd = $("#" + fn);
                    var triggerEvent = fd.attr("type") == "text" ? "blur": "change";
                    fd.on(triggerEvent, function() {
                         var d = $("#deathDay");
                         var m = $("#deathMonth");
                         var y = $("#deathYear");
                         if (d.val() != "" && m.val() != "" && y.val() != "") {
                            if (d.get(0).validity.valid && m.get(0).validity.valid && y.get(0).validity.valid) {
                                var today = new Date();
                                // Check to see if this is a real date
                                var iy = parseInt(y.val()), im = parseInt(m.val()), iid=parseInt(d.val());
                                var date = new Date(iy,im-1,iid);
                                var errorMsg = "";

                                if (date.getFullYear() == iy && (date.getMonth() + 1) == im && date.getDate() == iid) {
                                    if (iy < 1900) errorMsg = "Year must be after 1900";
                                    // Only allow if birthdate is before today
                                    if (date.setHours(0,0,0,0) > today.setHours(0,0,0,0)) {
                                        errorMsg = "The date must not be in the future.";
                                    };
                                } else errorMsg = "Invalid Date. Please enter a valid date.";

                                if (errorMsg == "") {
                                    $("#deathDate").val(y.val()+"-"+m.val()+"-"+d.val());
                                    $("#boolDeath").prop("checked", true);
                                    $("#errorDeathDate").text("");
                                    assembleContent.demo({{person.id}}, true, $(this));
                                } else {
                                    $("#errorDeathDate").text(errorMsg);
                                };
                            };
                        };
                    });
                });
            }
        );
    </script>
{%- endmacro %}
{% macro profileStudyID(person) -%}
    <div id="profileStudyIDContainer" class="form-group">
        <label class="text-muted">Study ID</label>
        <input type="text" id="profileStudyId" class="form-control" required/>
        <div class="help-block with-errors"></div>
    </div>
{%- endmacro %}
{% macro profileCustomDetail(person) -%}
     <div class="row">
        <div class="col-md-12 col-xs-12">
            <h4 class="profile-item-title">{{_("Three ways to complete questionnaire")}}</h4>
            <div class="custom-container">
                <div class="profile-item-container custom-container-item-right">
                    <h4 id="customSendEmailLoc" class="profile-item-title index-item">{{_("Send email")}}</h4>
                    <div class="text-muted custom-container-content">{{_("Invite or remind patient over email to complete their questionnaire")}}</div><br/>
                    <div>{{profileEmailForm(person)}}</div>
                </div>
                <div class="profile-item-container custom-container-item-right">
                    <h4 id="customLoginAsLoc" class="profile-item-title index-item">{{_("Log in as patient")}}</h4>
                    <div class="custom-container-content text-muted">{{_("This logs you out, and logs in the patient without their needing to enter credentials. This is so the patient can complete their questionnaire on this device. Ideal for tablet and kiosk computers.")}}</div><br/>
                    <button class="btn btn-tnth-primary" onclick="handleLoginAs();">{{_("Login as patient")}}</button>
                </div>
                <div class="profile-item-container custom-container-item">
                    <h4 id="customEnterManuallyLoc" class="profile-item-title index-item">{{_("Enter manually")}}</h4>
                    <div class="custom-container-content text-muted">{{_("Enter questionnaire responses on patient's behalf. Helpful if responses have been completed on paper.")}}</div><br/>
                    <a class="btn btn-tnth-primary" id="assessmentLink" href="/api/present-assessment?instrument_id=eortc&instrument_id=hpfs&instrument_id=prems&instrument_id=irondemog&subject_id={{person.id}}&initial=true">{{_("Enter manually")}}</a>

                </div>
            </div>
        </div>
    </div>
    <script>
    $(document).ready(function() {
        $("#profileSendEmailContainer").hide();
        $("#sendEmailLabel").hide();
        $("#loginAsPatient").hide();
        $("#navMenuXs").hide();
        if (! hasValue($("#email").val()) ){
            $("#profileEmailSelect").attr("disabled", true);
        } else $("#profileEmailSelect").attr("disabled", false);
        $("#email").on("keyup", function() {
            if (hasValue($(this).val())) $("#profileEmailSelect").attr("disabled", false);
            else $("#profileEmailSelect").attr("disabled", true);
        });
    });</script>
{%- endmacro %}
{% macro profile(person, current_user, consent_agreements) -%}
    <!-- remember to add xs class to side when custom content is present -->
    {% if config.CUSTOM_PATIENT_DETAIL %}
        {% if current_user and person and current_user.has_role(ROLE.STAFF) and person.has_role(ROLE.PATIENT) %}
            {{ profileCustomDetail(person) }}
        {% endif %}
    {% endif %}
    {% if current_user and person and current_user.has_role(ROLE.STAFF) and person.has_role(ROLE.PATIENT) %}
    <div class="row">
        <div class="col-md-12 col-xs-12">
            <h4 class="profile-item-title detail-title">Patient Details</h4>
        </div>
    </div>
    {% endif %}
    {% if person and person.has_role(ROLE.PATIENT) and current_user.has_role(ROLE.STAFF) and (current_user.id != person.id) %}
         <div class="row">
            <div class="col-md-6 col-sm-12 col-xs-12">
                <div class="profile-item-container side {% if config.CUSTOM_PATIENT_DETAIL %}side-md{%if person.has_role('patient')%} side-lg{%endif%}{%else%}side-lg{%endif%}">
                    <h4 id="patientInformationLoc" class="profile-item-title index-item">{% if person.has_role('patient') %}{{ _("Patient Information") }}{%else%}{{ _("User Information") }}{%endif%}</h4>
                    {{profileName(person)}}
                    {{profileBirthDate(person)}}
                    {% if person.has_role('patient') %} {{profileStudyID(person)}} {% endif %}
                </div>
            </div>
            <div class="col-md-6 col-sm-12 col-xs-12">
                <div class="profile-item-container side {% if config.CUSTOM_PATIENT_DETAIL %}side-md{%if person.has_role('patient')%} side-lg one-side{%endif%}{%else%}side-lg{%endif%}">
                    <h4 id="communicationsLoc" class="profile-item-title index-item">{{ _("Communications") }}</h4>
                    {{profilePhone(person)}}
                    {{profileEmail(person)}}
                    {{profileSendEmail(person)}}
                </div>
            </div>
        </div>
    {% else %}
        <div class="row">
            <div class="col-md-7 col-sm-12 col-xs-12">
                <div class="profile-item-container {% if config.CUSTOM_PATIENT_DETAIL %}side-md{%else%}side-md side-custom{%endif%}">
                     {% if person.has_role('patient') %}
                        <h4 id="patientInformationLoc" class="profile-item-title index-item">{{ _("Patient Information") }}</h4>
                     {% else %}
                        <h4 id="patientInformationLoc" class="profile-item-title index-item">{{ _("User Information") }}</h4>
                     {% endif %}
                     <br/>
                     {{profileName(person)}}
                     {{profileBirthDate(person)}}
                </div>
            </div>
            <div class="col-md-5 col-sm-12 col-xs-12">
                <div class="profile-item-container {% if config.CUSTOM_PATIENT_DETAIL %}side-md one-side{%else%}side-md side-custom one-side{%endif%}">
                    <h4 id="communicationLoc" class="profile-item-title index-item">{{ _("Communications") }}</h4>
                    <br/>
                    {{profileEmail(person)}}
                    {{profilePhone(person)}}
                </div>
            </div>
        </div>
    {% endif %}

    {% if (person and person.has_role(ROLE.PATIENT)) or (current_user.has_role(ROLE.STAFF) and current_user.id != person.id)%}
        <div class="row" id="profileSessionListMainContainer">
            <div class="col-md-12 col-xs-12">
                <div  class="profile-item-container">
                     <h4 id="proAssessmentsLoc" class="profile-item-title index-item">{{ _("PRO Questionnaires") }}</h4>
                    {{profileSessionList(person, current_user)}}
                </div>
            </div>
        </div>
    {% endif %}

    {% if (person.id == current_user.id and person.has_role(ROLE.PATIENT)) or (person.id != current_user.id and current_user.has_role(ROLE.STAFF))%}
        {{profileClinicalQuestions(person, current_user) | show_macro('clinical_questions')}}
    {% endif %}

    {% if person and person.has_role(ROLE.PATIENT) %}
        {{profileProcedures(person, current_user) | show_macro('procedures')}}
    {% endif %}

    {% if person and person.has_role(ROLE.PATIENT) %}
        {{profileInterventionReports(person) | show_macro('intervention_reports')}}
    {% endif %}

    <div class="row">
        <div class="col-md-12 col-xs-12">
            <div class="profile-item-container">
                <h4 id="orgsLoc" class="profile-item-title index-item">{{ _("Organization Affiliation") }} / {{ _("Clinics") }}</h4>
                {{profileOrg(person,None,consent_agreements, current_user)}}
            </div>
        </div>
    </div>
    {%if person and person.has_role('patient')%}
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="profile-item-container">
                    <h4 id="patientDetailLoc" class="profile-item-title index-item">{% if person.has_role(ROLE.PATIENT) %}{{ _("Patient Detail") }}{%else%}{{ _("User Detail") }}{%endif%}</h4>
                    <div class="flex">
                        <div>
                            {{profileGender(person)}}
                        </div>
                        <div>
                            {{profileEthnicity(person)|show_macro('ethnicity')}}
                        </div>
                        <div>
                            {{profileRace(person)|show_macro('race')}}
                        </div>
                        <div>
                            {{profileIndigenous(person)|show_macro('indigenous')}}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
     <div class="row">
        <div class="col-md-12 col-xs-12">
            <div  class="profile-item-container">
                <h4 id="timeZoneLocaleLoc" class="profile-item-title index-item">Locale / Time Zone</h4>
                <div class="flex">
                    <div class="timezone-container">
                        {{profileLocale(person)}}
                    </div>
                    <div class="timezone-container">
                        {{profileTimeZone(person)}}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% if (person and current_user) %}
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="profile-item-container">
                    <h4 id="patientReportsLoc" class="profile-item-title index-item">{{ _("Patient Reports") }}</h4>
                    {{patientReports(person)}}
                </div>
            </div>
        </div>
    {% endif %}
    {% if person and (person.has_role(ROLE.PATIENT) or person.has_role(ROLE.PARTNER))%}
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="profile-item-container">
                    <h4 id="consentHistoryLoc" class="profile-item-title index-item">{% if config.CONSENT_WITH_TOP_LEVEL_ORG %}{{_("Agreement to Share Clinical Information")}} {%else%}{{ _("Consent History") }} {%endif%}</h4>
                    {{profileConsent(person, current_user)}}
                </div>
            </div>
        </div>
    {% endif %}
    {% if (person and current_user) and person.has_role(ROLE.PATIENT) and current_user.has_role(ROLE.STAFF) %}
        {{profileDeceased(person, current_user)}}
    {% endif %}
    {% if (person and current_user) and current_user.has_role(ROLE.ADMIN) and not person.has_role(ROLE.SERVICE) %}
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="profile-item-container">
                     <h4 id="rolesLoc" class="profile-item-title index-item">{{ _("User Roles") }}</h4>
                    {{profileRole(person, current_user)}}
                </div>
            </div>
        </div>
    {% endif %}
    {% if (person and current_user) and (current_user.has_role(ROLE.ADMIN) or current_user.has_role(ROLE.STAFF)) %}
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="profile-item-container">
                    <h4 id="auditLogLoc" class="profile-item-title index-item">{{ _("Audit Log") }}</h4>
                    {{profileAuditLog(person, current_user)}}
                </div>
            </div>
        </div>
    {% endif %}
{%- endmacro %}

{% macro profileProcedures(person, current_user) -%}
    <script src="{{ url_for('static', filename='js/procedures.js') }}"></script>
    <style>
        .treatment-container {margin-left:0.5em;}
        #eventListtnthproc {margin-left: 0.5em}
        #eventListtnthproc td { padding: 0.15em;}
        #profileProcedureContainer { margin-left: 1em;}
        #profileProcedureContainer .inner {margin: 1em 0.5em 1em 0.5em}
        #procedureForm { margin-left: 0.5em;}
        #profileProcedureContainer .procedureDateLabel { margin-bottom: 0;}
        #profileProcedureContainer button.btn {color:#777}
    </style>
    <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="profile-item-container">
                    <h4 id="clinicalDataLoc" class="profile-item-title index-item">{{ _("Clinical Data") }}</h4>
                    <div>
                        <p style="color: #696767">{%if (current_user and person) and current_user.has_role(ROLE.STAFF) and current_user.id != person.id %}{{ _("Which of the following prostate cancer management options has the patient had, if any? If you don&#39;t remember the exact date, please make your best guess.") }}{%else%}{{ _("Which of the following prostate cancer management options have you had, if any? If you don&#39;t remember the exact
                            date, please make your best guess.") }}{%endif%}<span class="text-muted smaller-text"></span></p><br/>
                        <div id="profileProcedureContainer">
                            <form id="procedureForm" class="form-inline event-element">
                                <p class="text-muted"><em>{{ _("Select")}}</em> {{ _("an option") }}:</p>
                                <div class="row">
                                    <div class="col-md-6 col-xs-11">
                                        <div class='form-group'>
                                            <select class='form-control' id='tnthproc'>
                                                <option value=''>{{ _("Select") }}...</option>
                                                <option value='373818007'>{{ _("Started watchful waiting") }}</option>
                                                <option value='424313000'>{{ _("Started active surveillance") }}</option>
                                                <option value='26294005'>{{ _("Radical prostatectomy (nerve-sparing)") }}</option>
                                                <option value='26294005-nns'>{{ _("Radical prostatectomy (non-nerve-sparing)") }}</option>
                                                <option value='33195004'>{{ _("External beam radiation therapy") }}</option>
                                                <option value='228748004'>{{ _("Brachytherapy") }}</option>
                                                <option value='707266006'>{{ _("Androgen deprivation therapy") }}</option>
                                                <option value='999999999'>{{ _("None of the above") }}</option>
                                            </select>
                                            <div class="help-block with-errors"></div>
                                        </div>
                                    </div>
                                </div>
                                <br/>
                                <div id="procDateGroup" class="form-group">
                                    <label class="procedureDateLabel">{{ _("Date") }}:</label>
                                    <div class="flex">
                                        <div>
                                            <input class="form-control" id="procDay" name="procDay" type="text" placeholder="DD" maxlength="2" >
                                        </div>
                                        <div>
                                            <select class="form-control" name="procMonth" id="procMonth">
                                                <option value="">{{ _("Month") }}...</option>
                                                <option value="01">{{ _("January") }}</option>
                                                <option value="02">{{ _("February") }}</option>
                                                <option value="03">{{ _("March") }}</option>
                                                <option value="04">{{ _("April") }}</option>
                                                <option value="05">{{ _("May") }}</option>
                                                <option value="06">{{ _("June") }}</option>
                                                <option value="07">{{ _("July") }}</option>
                                                <option value="08">{{ _("August") }}</option>
                                                <option value="09">{{ _("September") }}</option>
                                                <option value="10">{{ _("October") }}</option>
                                                <option value="11">{{ _("November") }}</option>
                                                <option value="12">{{ _("December") }}</option>
                                            </select>
                                        </div>
                                        <div>
                                            <input class="form-control" id="procYear" name="procYear" placeholder="YYYY" type="text" maxlength="4">
                                        </div>
                                        <div>
                                            <button class='btn btn-default' id='tnthproc-submit' name='tnthproc' data-name='' data-date='' data-date-read=''  type="submit" disabled><i class='fa fa-plus'></i><em class="smaller-text">&nbsp;{{ _("Add") }}</em> <span class="smaller-text">{{_(" Option")}}</span></button>
                                        </div>
                                    </div>
                                    <div class="row">
                                         <div class="col-md-9 col-xs-10">
                                            <div id="procDateErrorContainer" class="help-block with-errors"></div>
                                         </div>
                                    </div>
                                </div>
                                <br />
                                <hr style="border-bottom: 1px solid #e5e5e5">
                                <div class="inner">
                                    <p class="text-muted"><em>{{_("Past")}}</em>&nbsp;{{ _("Management(s)") }}:</p>
                                    <div id="userProcedures"></div>
                                </div>
                            </form>
                            <br/>
                        <div>
                    </div>
                </div>
            </div>
    </div>
    <script>
        var subjectId = {{ person.id if person}};
        var currentUserId = {{ current_user.id if current_user}};
        $(document).ready(function(){
            tnthAjax.getProc({{ person.id if person}}, false);
        });
    </script>
{%- endmacro %}


{% macro profileSaveBtn() -%}
    <p id="saveMsg" class="error-message text-muted  bg-warning" style="display: none"><small>{{ _("You have updated your profile. Click the Save button to submit your changes.") }} {{ _("Or") }} <a href="">{{ _("cancel") }}</a>.</small></p>
    <p id="errorMsg" class="error-message text-muted  bg-danger" style="display: none"><small>{{ _("There is a problem with your profile. Please correct it before saving.") }}<br/>{{ _("Make sure all required fields are filled out and all entries are valid.") }}</small></p>
    <p id="serviceErrorMsg" class="error-message text-muted bg-danger" style="display: none"></p>
    <button id="updateProfile" type="submit" class="btn btn-lg btn-tnth-primary">{{ _("Save") }}</button>
    <span id="confirmMsg" class="text-muted tnth-hide small-text">&nbsp;&nbsp;<em>{{ _("Profile changes have been saved") }}</em></span>
{%- endmacro %}
