!function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=19)}([function(e,t,n){"use strict";t.a={external_study_id:"http://us.truenth.org/identity-codes/external-study-id",external_site_id:"http://us.truenth.org/identity-codes/external-site-id",practice_region:"http://us.truenth.org/identity-codes/practice-region",race:"http://hl7.org/fhir/StructureDefinition/us-core-race",race_system:"http://hl7.org/fhir/v3/Race",ethnicity:"http://hl7.org/fhir/StructureDefinition/us-core-ethnicity",ethnicity_system:"http://hl7.org/fhir/v3/Ethnicity",indigenous:"http://us.truenth.org/fhir/StructureDefinition/AU-NHHD-METeOR-id-291036",timezone:"http://hl7.org/fhir/StructureDefinition/user-timezone",language:"http://hl7.org/fhir/valueset/languages",language_system:"urn:ietf:bcp:47",shortname:"http://us.truenth.org/identity-codes/shortname",SNOMED_SYS_URL:"http://snomed.info/sct",CLINICAL_SYS_URL:"http://us.truenth.org/clinical-codes",CANCER_TREATMENT_CODE:"118877007",NONE_TREATMENT_CODE:"999"}},function(e,t,n){"use strict";n.d(t,"b",function(){return a}),n.d(t,"c",function(){return o});var r,i=((r=function(){this.requestAttempts=0}).prototype.hasValue=function(e){return"null"!==String(e)&&""!==String(e)&&"undefined"!==String(e)},r.prototype.showMain=function(){$("#mainHolder").css({visibility:"visible","-ms-filter":"progid:DXImageTransform.Microsoft.Alpha(Opacity=100)",filter:"alpha(opacity=100)","-moz-opacity":1,"-khtml-opacity":1,opacity:1})},r.prototype.hideLoader=function(e,t){e?$("#loadingIndicator").hide():setTimeout(function(){$("#loadingIndicator").fadeOut()},t||200)},r.prototype.loader=function(e){if(document.getElementById("fullSizeContainer"))return this.hideLoader(),this.showMain(),!1;if(e)$("#loadingIndicator").show();else if(!this.isDelayLoading()){var t=this;setTimeout(function(){t.showMain()},100),this.hideLoader(!0,350)}},r.prototype.isDelayLoading=function(){return"undefined"!=typeof DELAY_LOADING&&DELAY_LOADING},r.prototype.isTouchDevice=function(){return!0===("ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch)},r.prototype.getIEVersion=function(){var e=navigator.userAgent.match(/(?:MSIE |Trident\/.*; rv:)(\d+)/);return!!e&&parseInt(e[1])},r.prototype.newHttpRequest=function(e,t,n){this.requestAttempts++;var r,i=this;for(var a in n=n||function(){},window.XDomainRequest?(r=new XDomainRequest).onload=function(){n(r.responseText)}:r=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),r.onreadystatechange=function(){if(4===r.readyState){if(200===r.status)return n(r.responseText),void(i.requestAttempts=0);i.requestAttempts<3?setTimeout(function(){i.newHttpRequest(e,t,n)},3e3):(n({error:r.responseText}),i.loader(),i.requestAttempts=0)}},t=t||{},r.open("GET",e,!0),t)t.hasOwnProperty(a)&&r.setRequestHeader(a,t[a]);t.cache||(r.setRequestHeader("cache-control","no-cache"),r.setRequestHeader("expires","-1"),r.setRequestHeader("pragma","no-cache")),r.send()},r.prototype.ajaxRequest=function(e,t,n){if(n=n||function(){},!e)return n({error:i18next.t("Url is required.")}),!1;var r={url:e,type:"GET",contentType:"text/plain",timeout:5e3,cache:!1};t=t||r,t=$.extend({},r,t),this.requestAttempts++;var i=this;$.ajax(t).done(function(e){n(e),i.requestAttempts=0}).fail(function(){i.requestAttempts<=3?setTimeout(function(){i.ajaxRequest(e,t,n)},3e3):(n({error:i18next.t("Error occurred processing request")}),i.requestAttempts=0,i.loader())}).always(function(){i.loader()})},r.prototype.initWorker=function(e,t,n){var r=new Worker("/static/js/ajaxWorker.js"),i=this;r.postMessage({url:e,params:t}),r.addEventListener("message",function(e){n.call(i,e.data),r.terminate()},!1),r.addEventListener("error",function(e){console.log("Worker runtime error: Line ",e.lineno," in ",e.filename,": ",e.message),r.terminate()},!1)},r.prototype.workerAllowed=function(){return window.Worker&&!this.isTouchDevice()},r.prototype.getRequestMethod=function(){return this.getIEVersion()?this.newHttpRequest:this.ajaxRequest},r.prototype.sendRequest=function(e,t,n){if((t=t||{}).useWorker&&this.workerAllowed())return this.initWorker(e,t,n),!0;this.getRequestMethod().call(this,e,t,function(e){n.call(this,e)})},r.prototype.LRKeyEvent=function(){$(".button--LR").length>0&&$("html").on("keydown",function(e){parseInt(e.keyCode)===parseInt(187)&&$(".button--LR").toggleClass("data-show")})},r.prototype.getLoaderHTML=function(e){return'<div class="loading-message-indicator"><i class="fa fa-spinner fa-spin fa-2x"></i>'.concat(e?"&nbsp;"+e:"","</div>")},r.prototype.convertToNumericField=function(e){e&&this.isTouchDevice()&&e.each(function(){$(this).prop("type","tel")})},r.prototype.isString=function(e){return"[object String]"===Object.prototype.toString.call(e)},r.prototype.disableHeaderFooterLinks=function(){var e=$("#tnthNavWrapper a, #homeFooter a").not("a[href*='logout']").not("a.required-link").not("a.home-link");e.addClass("disabled"),e.prop("onclick",null).off("click"),e.on("click",function(e){return e.preventDefault(),!1})},r.prototype.pad=function(e){return e=parseInt(e),!isNaN(e)&&e<10?"0"+e:e},r.prototype.escapeHtml=function(e){return null===e||"undefined"!==e||0===String(e).length?e:e.replace(/[\"&'\/<>]/g,function(e){return{'"':"&quot;","&":"&amp;","'":"&#39;","/":"&#47;","<":"&lt;",">":"&gt;"}[e]})},r.prototype.containHtmlTags=function(e){return!!e&&/[<>]/.test(e)},r.prototype.getExportFileName=function(e){var t=new Date;return(e||"ExportList_")+("00"+t.getDate()).slice(-2)+("00"+(t.getMonth()+1)).slice(-2)+t.getFullYear()},r.prototype.capitalize=function(e){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})},r.prototype.restoreVis=function(){var e=document.getElementById("loadingIndicator"),t=document.getElementById("mainHolder");e&&e.setAttribute("style","display:none; visibility:hidden;"),t&&t.setAttribute("style","visibility:visible;-ms-filter:'progid:DXImageTransform.Microsoft.Alpha(Opacity=100)';filter:alpha(opacity=100); -moz-opacity:1; -khtml-opacity:1; opacity:1")},r.prototype.VueErrorHandling=function(){if("undefined"==typeof Vue)return!1;var e=this;Vue.config.errorHandler=function(t,n,r){var i,a=n;if(n.$options.errorHandler)i=n.$options.errorHandler;else for(;!i&&a.$parent;)i=(a=a.$parent).$options.errorHandler;e.restoreVis(),i?i.call(a,t,n,r):console.log(t)}},r.prototype.extend=function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},r.prototype.getUrlParameter=function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===t?"":decodeURIComponent(t[1])},r.prototype.resetBrowserBackHistory=function(e,t,n){var r="undefined"!=typeof history&&history.pushState;e=e||location.href,r&&history.pushState(t,n,e),window.addEventListener("popstate",function(){r?history.pushState(t,n,e):window.history.forward(1)})},r.prototype.handlePostLogout=function(){if("undefined"==typeof sessionStorage)return!1;sessionStorage.getItem("logout")&&(this.resetBrowserBackHistory(location.orgin,"logout"),sessionStorage.removeItem("logout"))},r.prototype.displaySystemOutageMessage=function(e){if(e=(e=e||"en-us").replace("_","-"),document.getElementById("systemMaintenanceContainer")){var t=this;this.ajaxRequest("api/settings",{contentType:"application/json; charset=utf-8"},function(n){if(!n||!n.MAINTENANCE_MESSAGE&&!n.MAINTENANCE_WINDOW)return!1;var r=document.querySelector(".message-container");if(r||((r=document.createElement("div")).classList.add("message-container"),document.getElementById("systemMaintenanceContainer").appendChild(r)),n.MAINTENANCE_MESSAGE)r.innerHTML=t.escapeHtml(n.MAINTENANCE_MESSAGE);else if(n.MAINTENANCE_WINDOW&&n.MAINTENANCE_WINDOW.length){var i,a,o=new Date(n.MAINTENANCE_WINDOW[0]),s=new Date(n.MAINTENANCE_WINDOW[1]),c=(i=new Date,a=o,i&&a?Math.floor((a.getTime()-i.getTime())/36e5%24):0);if(c<0||isNaN(c))document.getElementById("systemMaintenanceContainer").classList.add("tnth-hide");else try{var d={year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",hour12:!0,timeZoneName:"short"},l=o.toLocaleString(e,d).replace(/[,]/g," "),u=s.toLocaleString(e,d).replace(/[,]/g," "),h=["<div>"+i18next.t("Hi there.")+"</div>","<div>"+i18next.t("TrueNTH will be down for website maintenance starting <b>{startdate}</b>. This should last until <b>{enddate}</b>.".replace("{startdate}",l).replace("{enddate}",u))+"</div>","<div>"+i18next.t("Thanks for your patience while we upgrade our site.")+"</div>"].join("");r.innerHTML=t.escapeHtml(h)}catch(e){console.log("Error occurred converting system outage date/time ",e),document.getElementById("systemMaintenanceContainer").classList.add("tnth-hide")}}})}},new r);t.a=i;var a=i.getExportFileName,o=i.getUrlParameter},function(e,t,n){"use strict";n.d(t,"b",function(){return i});var r={validateDateInputFields:function(e,t,n,r){if(!e||!t||!n)return!1;e=parseInt(e),t=parseInt(t),n=parseInt(n);var i=$("#"+r);if(!isNaN(e)&&!isNaN(t)&&!isNaN(n)){var a=new Date,o=new Date(n,e-1,t);return o.getFullYear()!==n||o.getMonth()+1!==e||o.getDate()!==t?(i.html(i18next.t("Invalid date. Please try again.")).show(),!1):o.setHours(0,0,0,0)>a.setHours(0,0,0,0)?(i.html(i18next.t("Date must not be in the future. Please try again.")).show(),!1):n<1900?(i.html(i18next.t("Date must not be before 1900. Please try again.")).show(),!1):(i.html("").hide(),!0)}return!1},swap_mm_dd:function(e){var t=e.split("/");return t[1]+"/"+t[0]+"/"+t[2]},convertMonthNumeric:function(e){if(e){var t={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12}[e.toLowerCase()];return t||""}return""},convertMonthString:function(e){if(e){var t={1:"Jan",2:"Feb",3:"Mar",4:"Apr",5:"May",6:"Jun",7:"Jul",8:"Aug",9:"Sep",10:"Oct",11:"Nov",12:"Dec"}[parseInt(e)];return t||""}return""},isDate:function(e){return"[object Date]"===Object.prototype.toString.call(e)&&!isNaN(e.getTime())},displayDateString:function(e,t,n){var r="";return r+=t||"",e&&(r+=(r?" ":"")+this.convertMonthString(e)),n&&(r+=(r?" ":"")+n),r},getDateDiff:function(e,t){if(!e)return 0;var n,r=e.split(/[^0-9]/),i=new Date(r[0],r[1]-1,r[2]).getTime();if(t){var a=t.split(/[^0-9]/);n=new Date(a[0],a[1]-1,a[2]).getTime()}else n=(new Date).getTime();return Math.floor((n-i)/864e5)},isValidDefaultDateFormat:function(e,t){if(!e||e.length<10)return!1;var n=$.trim(e).split(" ");if(n.length<3)return!1;var r=parseInt(n[0])+"",i=n[1],a=n[2];if(r.length<1||i.length<3||a.length<4)return!1;if(!/(0)?[1-9]|1\d|2\d|3[01]/.test(r))return!1;if(!/jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec/i.test(i))return!1;if(!/(19|20)\d{2}/.test(a))return!1;var o=new Date(e);if(this.isDateObj(o)){if(this.isValidDate(a,this.convertMonthNumeric(i),r)){var s=new Date,c="";return o.getFullYear()<1900&&(c="Year must be after 1900"),o.setHours(0,0,0,0)>s.setHours(0,0,0,0)&&(c="The date must not be in the future."),c?($(t).text(c),!1):($(t).text(""),!0)}return!1}return!1},isDateObj:function(e){return"[object Date]"===Object.prototype.toString.call(e)&&!isNaN(e.getTime())},isValidDate:function(e,t,n){var r=this.getDateObj(e,t,n),i=this.getConvertedDate(r),a=this.getGivenDate(e,t,n);return String(a)===String(i)},getDateObj:function(e,t,n,r,i,a){return r=r||0,i=i||0,a=a||0,new Date(parseInt(e),parseInt(t)-1,parseInt(n),parseInt(r),parseInt(i),parseInt(a))},getConvertedDate:function(e){return e&&this.isDateObj(e)?""+e.getFullYear()+(e.getMonth()+1)+e.getDate():""},getGivenDate:function(e,t,n){return""+e+t+n},formatDateString:function(e,t){if(e){var n,r,i,a,o,s,c,d=/^([\+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24\:?00)([\.,]\d+(?!:))?)?(\17[0-5]\d([\.,]\d+)?)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/,l=new Date(e);if(!d&&!isNaN(l)&&!this.isDateObj(l))return"";if(d.test(e)){var u=$.trim($.trim(e).replace(/[\.TZ:\-]/gi," ")).split(" ");i=u[0],r=u[1],n=u[2],a=u[3]||"0",o=u[4]||"0",s=u[5]||"0"}else n=l.getDate(),r=l.getMonth()+1,i=l.getFullYear(),a=l.getHours(),o=l.getMinutes(),s=l.getSeconds(),c="";var h=function(e){return(e=parseInt(e))<10?"0"+e:e};switch(n=h(n),r=h(r),a=h(a),o=h(o),s=h(s),t){case"mm/dd/yyyy":c=r+"/"+n+"/"+i;break;case"mm-dd-yyyy":c=r+"-"+n+"-"+i;break;case"mm-dd-yyyy hh:mm:ss":c=r+"-"+n+"-"+i+" "+a+":"+o+":"+s;break;case"dd/mm/yyyy":c=n+"/"+r+"/"+i;break;case"dd/mm/yyyy hh:mm:ss":c=n+"/"+r+"/"+i+" "+a+":"+o+":"+s;break;case"dd-mm-yyyy":c=n+"-"+r+"-"+i;break;case"dd-mm-yyyy hh:mm:ss":c=n+"-"+r+"-"+i+" "+a+":"+o+":"+s;break;case"iso-short":case"yyyy-mm-dd":c=i+"-"+r+"-"+n;break;case"iso":case"yyyy-mm-dd hh:mm:ss":c=i+"-"+r+"-"+n+" "+a+":"+o+":"+s;break;case"system":c=i+"-"+r+"-"+n+"T"+a+":"+o+":"+s+"Z";break;case"d M y hh:mm:ss":c=(c=this.displayDateString(r,n,i))+" "+a+":"+o+":"+s;break;case"d M y":default:c=this.displayDateString(r,n,i)}return c}return""},convertToLocalTime:function(e){var t="";if(e){var n=new Date(e),r=new Date(n.getTime()+60*n.getTimezoneOffset()*1e3),i=n.getTimezoneOffset()/60,a=n.getHours();r.setHours(a-i);t=r.toLocaleString({year:"numeric",day:"numeric",month:"short",hour:"numeric",minute:"numeric",second:"numeric",hour12:!1})}return t},getDateWithTimeZone:function(e){var t=new Date(e.getTime()+60*e.getTimezoneOffset()*1e3);return this.formatDateString(t,"yyyy-mm-dd hh:mm:ss")},getTodayDateObj:function(){var e=new Date,t=e.getDate(),n=e.getMonth()+1,r=e.getFullYear(),i=e.getHours(),a=e.getMinutes(),o=e.getSeconds(),s=this.getDateWithTimeZone(this.getDateObj(r,n,t,i,a,o)),c=function(e){return(e=parseInt(e))<10?"0"+e:e};return{date:e,day:t,month:n,year:r,hour:i,minute:a,second:o,displayDay:c(t),displayMonth:c(n),displayYear:c(r),displayHour:c(i),displayMinute:c(a),displaySecond:c(o),gmtDate:s}},dateValidator:function(e,t,n,r){var i="";if(e&&t&&n){var a=parseInt(n),o=parseInt(t),s=parseInt(e),c=new Date(a,o-1,s);if(c.getFullYear()===a&&c.getMonth()+1===o&&c.getDate()===s){if(a<1900&&(i=i18next.t("Year must be after 1900")),r){var d=new Date;c.setHours(0,0,0,0)>d.setHours(0,0,0,0)&&(i=i18next.t("The date must not be in the future."))}}else i=i18next.t("Invalid Date. Please enter a valid date.")}else i=i18next.t("Missing value.");return i}};t.a=r;var i=r.validateDateInputFields},function(e,t,n){"use strict";var r=n(1),i=n(2),a=n(0),o={biopsy:{code:"111",display:"biopsy"},pca_diag:{code:"121",display:"PCa diagnosis"},pca_localized:{code:"141",display:"PCa localized diagnosis"}};t.a={beforeSend:function(){$.ajaxSetup({beforeSend:function(e,t){/^(GET|HEAD|OPTIONS|TRACE)$/i.test(t.type)||this.crossDomain||e.setRequestHeader("X-CSRFToken",$("#__CRSF_TOKEN").val())}})},sendRequest:function(e,t,n,i,a){if(!e)return!1;var o={type:t||"GET",url:e,attempts:0,max_attempts:3,contentType:"application/json; charset=utf-8",dataType:"json",sync:!1,timeout:5e3,data:null,useWorker:!1,async:!0};i=i||o,(i=$.extend({},o,i)).async=!i.sync&&i.async;var s=this,c=this.FieldLoaderHelper,d=i.targetField||null;if(a=a||function(){},i.attempts++,c.showLoader(d),i.useWorker&&window.Worker&&!r.a.isTouchDevice())return r.a.initWorker(e,i,function(t){var r;try{r=JSON.parse(t)}catch(t){return a({error:"Error occurred parsing data for "+e}),!1}r?r.error?(a({error:!0,data:r}),s.sendError(r,e,n,i),c.showError(d)):(a(r),c.showUpdate(d)):(a({error:!0,data:"no data returned"}),c.showError(d))}),!0;i.cache||(i.headers={"cache-control":"no-cache",expires:"-1",pragma:"no-cache"}),$.ajax(i).done(function(e){i.attempts=0,e?(c.showUpdate(d),a(e)):(c.showError(d),a({error:!0,data:"no data returned"}))}).fail(function(r){i.attempts<i.max_attempts?function(e,t,n,r,i,a){setTimeout(function(){e.sendRequest(t,n,r,i,a)},3e3)}(s,e,t,n,i,a):(i.attempts=0,c.showError(d),a({error:!0,data:r}),s.sendError(r,e,n,i))})},sendError:function(e,t,n,r){if(!e)return!1;var i="[Error occurred processing request]  status - "+(0===parseInt(e.status)?"request timed out/network error":e.status)+", response text - "+(e.responseText?e.responseText:"no response text returned from server");if(r)try{i+=" [data sent]: "+JSON.stringify(r)}catch(e){i+=" Error occurred transforming sent data: "+e.message}this.reportError(n||"Not available",t,i,!0)},reportError:function(e,t,n,r){var i={};t=t||window.location.href,i.subject_id=e||0,i.page_url=t,i.message="Error generated in JS - "+(n?n.replace(/["']/g,""):"no detail available"),console.log("Errors occurred....."),console.log(i),$.ajax({type:"GET",url:"/report-error",contentType:"application/json; charset=utf-8",cache:!1,async:!r,data:i}).done(function(){}).fail(function(){})},FieldLoaderHelper:{delayDuration:300,showLoader:function(e){if(!e||0===e.length)return!1;var t=$("#"+(e.attr("data-save-container-id")||e.attr("id"))+"_load");t.css("opacity",1),t.addClass("loading")},showUpdate:function(e){var t=this.delayDuration;if(!e||0===e.length)return!1;setTimeout(function(){!function(e){var n=e.attr("data-save-container-id")||e.attr("id"),r=$("#"+n+"_error"),i=$("#"+n+"_success"),a=$("#"+n+"_load");a.removeClass("loading"),r.text("").css("opacity",0),i.text(i18next.t("success")),a.animate({opacity:0},t,function(){i.animate({opacity:1},t,function(){setTimeout(function(){i.animate({opacity:0},2*t)},2*t)})})}(e)},t)},showError:function(e){e=e||$(e);var t=this.delayDuration;if(!e||0===e.length)return!1;setTimeout(function(){!function(e){var n=e.attr("data-save-container-id")||e.attr("id"),r=$("#"+n+"_error"),i=$("#"+n+"_success"),a=$("#"+n+"_load");a.removeClass("loading"),r.text(i18next.t("Unable to update. System/Server Error.")),i.text("").css("opacity",0),a.animate({opacity:0},t,function(){r.animate({opacity:1},t,function(){setTimeout(function(){r.animate({opacity:0},2*t)},2*t)})})}(e)},t)}},getCurrentUser:function(e,t){e=e||function(){},sessionStorage.currentUser?e(JSON.parse(sessionStorage.currentUser)):this.sendRequest("/api/me","GET","",t,function(t){t&&t.id&&sessionStorage.setItem("currentUser",JSON.stringify(t)),e(t)})},getStillNeededCoreData:function(e,t,n,r){if(n=n||function(){},!e)return n({error:i18next.t("User Id is required")}),!1;var i="/api/coredata/user/"+e+"/still_needed"+(r?"?entry_method="+r.replace(/\_/g," "):"");this.sendRequest(i,"GET",e,{sync:t,cache:!0},function(e){return e?e.error?(n({error:i18next.t("unable to get needed core data")}),!1):void n(e):(n({error:i18next.t("no data returned")}),!1)})},getRequiredCoreData:function(e,t,n){if(n=n||function(){},!e)return n({error:i18next.t("User Id is required")}),!1;this.sendRequest("/api/coredata/user/"+e+"/required","GET",e,{sync:t,cache:!0},function(e){e?e.error?n({error:i18next.t("unable to get required core data")}):e.required?n(e.required):n({error:i18next.t("no data returned")}):n({error:i18next.t("no data returned")})})},getOptionalCoreData:function(e,t,n){if(n=n||function(){},!e)return n({error:i18next.t("User Id is required")}),!1;var r="/api/coredata/user/"+e+"/optional",i="optionalCoreData_"+e;sessionStorage.getItem(i)?n(JSON.parse(sessionStorage.getItem(i))):this.sendRequest(r,"GET",e,t,function(e){n(e||{error:i18next.t("no data found")})})},getPortalFooter:function(e,t,n,r){if(r=r||function(){},!e)return r("<div class='error-message'>"+i18next.t("User Id is required")+"</div>"),!1;this.sendRequest("/api/portal-footer-html/","GET",e,{sync:t,cache:!0,dataType:"html"},function(e){e?e.error?r("<div class='error-message'>"+i18next.t("Unable to retrieve portal footer html")+"</div>"):(n&&$("#"+n).html(e),r(e)):r("<div class='error-message'>"+i18next.t("No data found")+"</div>")})},getOrgs:function(e,t,n){n=n||function(){},this.sendRequest("/api/organization","GET",e,t,function(e){if(sessionStorage.demoOrgsData)return n(JSON.parse(sessionStorage.demoOrgsData)),!0;if(e.error){var t=i18next.t("Server error occurred retrieving organization/clinic information.");$(".get-orgs-error").html(t),n({error:t})}else $(".get-orgs-error").html(""),sessionStorage.setItem("demoOrgsData",JSON.stringify(e)),n(e)})},getConsent:function(e,t,n){if(n=n||function(){},!e)return n({error:i18next.t("User id is required.")}),!1;this.sendRequest("/api/user/"+e+"/consent","GET",e,t,function(e){if(e){if(e.error){var t=i18next.t("Server error occurred retrieving consent information.");return n({error:t}),$(".get-consent-error").html(t),!1}return $(".get-consent-error").html(""),n(e),!0}})},setConsent:function(e,t,n,r,i){if(i=i||function(){},!e&&!t)return i({error:i18next.t("User id and parameters are required")}),!1;var a="/api/user/"+e+"/consent";if(!this.hasConsent(e,t.org,n)||t.testPatient){var o={};o.user_id=e,o.organization_id=t.org,o.agreement_url=t.agreementUrl,o.staff_editable="null"!==String(t.staff_editable)&&"undefined"!==String(t.staff_editable)&&t.staff_editable,o.include_in_reports="null"!==String(t.include_in_reports)&&"undefined"!==String(t.include_in_reports)&&t.include_in_reports,o.send_reminders="null"!==String(t.send_reminders)&&"undefined"!==String(t.send_reminders)&&t.send_reminders,t.acceptance_date&&(o.acceptance_date=t.acceptance_date),this.sendRequest(a,"POST",e,{sync:r,data:JSON.stringify(o)},function(e){if(e.error){var t=i18next.t("Server error occurred setting consent status.");i({error:t}),$(".set-consent-error").html(t)}else $(".set-consent-error").html(""),i(e)})}else i({error:!1})},deleteConsent:function(e,t){if(!e)return!1;t=t||{};var n=this.getAllValidConsent(e,t.org);if(!n)return!1;var r=t.exclude?t.exclude.split(","):[],i=$.grep(n,function(e){return!$.grep(r,function(t){return String(t)===String(e)}).length}),a=this;i.forEach(function(t){a.sendRequest("/api/user/"+e+"/consent","DELETE",e,{data:JSON.stringify({organization_id:parseInt(t)})},function(e){if(!e)return!1;e.error?$(".delete-consent-error").html(i18next.t("Server error occurred removing consent.")):$(".delete-consent-error").html("")})})},withdrawConsent:function(e,t,n,r){if(r=r||function(){},n=n||{},!e||!t)return r({error:i18next.t("User id and organization id are required.")}),!1;var a=this,o=[];this.sendRequest("/api/user/"+e+"/consent","GET",e,n,function(s){if(s&&s.consent_agreements&&s.consent_agreements.length&&(o=$.grep(s.consent_agreements,function(e){var n=i.a.getDateDiff(String(e.expires));return!(String(t)!==String(e.organization_id)||e.deleted||n>0||"suspended"!==String(e.status))})),o.length)return r({data:"success"}),!1;a.sendRequest("/api/user/"+e+"/consent/withdraw","POST",e,{sync:n.sync,data:JSON.stringify({organization_id:t})},function(e){if(e.error)return r({error:i18next.t("Error occurred setting suspended consent status.")}),!1;r(e)})})},getAllValidConsent:function(e,t){if(!e||!t)return!1;var n=[];return this.sendRequest("/api/user/"+e+"/consent","GET",e,{sync:!0},function(e){return e&&!e.error&&e.consent_agreements&&e.consent_agreements.length?n=(n=$.grep(e.consent_agreements,function(e){var n=i.a.getDateDiff(String(e.expires));return!(e.deleted||n>0||"all"!==String(t).toLowerCase()&&String(t)!==String(e.organization_id))})).map(function(e){return e.organization_id}):n}),n},hasConsent:function(e,t,n){if(!e||!t||"default"===String(n))return!1;var r=[],a="/api/user/"+e+"/consent";return this.sendRequest(a,"GET",e,{sync:!0},function(e){if(!e||e.error||e.consent_agreements&&0===e.consent_agreements.length)return!1;r=$.grep(e.consent_agreements,function(e){var n=e.expires?i.a.getDateDiff(String(e.expires)):0;return String(t)===String(e.organization_id)&&!e.deleted&&!(n>0)&&e.staff_editable&&e.send_reminders&&e.include_in_reports})}),r.length},getDemo:function(e,t,n){if(n=n||function(){},!e)return n({error:i18next.t("User id is required.")}),!1;t=t||{};var r="demoData_"+e;sessionStorage.getItem(r)?n(JSON.parse(sessionStorage.getItem(r))):this.sendRequest("/api/demographics/"+e,"GET",e,t,function(e){var t="";if(e.error)return t=i18next.t("Server error occurred retrieving demographics information."),$(".get-demo-error").html(t),n({error:t}),!1;$(".get-demo-error").html(t),sessionStorage.setItem(r,JSON.stringify(e)),n(e)})},clearDemoSessionData:function(e){sessionStorage.removeItem("demoData_"+e)},putDemo:function(e,t,n,r,i){if(i=i||function(){},!e)return i({error:i18next.t("User Id is required")}),!1;this.clearDemoSessionData(e),this.sendRequest("/api/demographics/"+e,"PUT",e,{sync:r,data:JSON.stringify(t),targetField:n},function(e){e.error?$(".put-demo-error").html(i18next.t("Server error occurred setting demographics information.")):$(".put-demo-error").html(""),i(e)})},getLocale:function(e){this.sendRequest("/api/demographics/"+e,"GET",e,null,function(e){e&&(e.error?$("#profileLocaleTimezoneContainer .get-locale-error").html(i18next.t("Server error occurred retrieving locale information.")):e.communication&&$("#profileLocaleTimezoneContainer .get-locale-error").html(""))})},hasTreatment:function(e){if(!e||!e.entry||0===e.entry.length)return!1;var t=e.entry.sort(function(e,t){return new Date(t.resource.meta.lastUpdated)-new Date(e.resource.meta.lastUpdated)}),n=!1;return t.forEach(function(e){if(n)return!0;var t=String(e.resource.code.coding[0].code),r=String(e.resource.code.coding[0].system),i=e.resource.id;(t===a.a.CANCER_TREATMENT_CODE&&r===a.a.SNOMED_SYS_URL||t===a.a.NONE_TREATMENT_CODE&&r===a.a.CLINICAL_SYS_URL)&&(n={code:t,id:i})}),n},getTreatment:function(e,t,n){if(n=n||function(){},!e)return n({error:i18next.t("User id is required")}),!1;this.sendRequest("/api/patient/"+e+"/procedure","GET",e,t,function(e){e.error&&$("#userProcedures").html("<span class='error-message'>"+i18next.t("Error retrieving data from server")+"</span>"),n(e)})},postTreatment:function(e,t,n,r){if(!e)return!1;this.deleteTreatment(e,r);var i=a.a.NONE_TREATMENT_CODE,o="None",s=a.a.CLINICAL_SYS_URL;if(t&&(i=a.a.CANCER_TREATMENT_CODE,o="Procedure on prostate",s=a.a.SNOMED_SYS_URL),!n){var c=new Date;n=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate()}var d=[{code:i,display:o,system:s}],l={resourceType:"Procedure"};l.subject={reference:"Patient/"+e},l.code={coding:d},l.performedDateTime=n||"",this.postProc(e,l,r)},deleteTreatment:function(e,t){var n=this;this.sendRequest("/api/patient/"+e+"/procedure","GET",e,{sync:!0},function(e){if(!e||e.error)return!1;var r=n.hasTreatment(e);return!!r&&(String(r.code)===String(a.a.CANCER_TREATMENT_CODE)?(n.deleteProc(r.id,t,!0),!0):void n.deleteProc(r.id,t,!0))})},getProc:function(e,t,n){n=n||function(){},this.sendRequest("/api/patient/"+e+"/procedure","GET",e,null,function(e){n(e)})},postProc:function(e,t,n,r){r=r||function(){},this.sendRequest("/api/procedure","POST",e,{data:JSON.stringify(t),targetField:n},function(e){if(!e)return r({error:i18next.t("no data returned")}),!1;if(e.error){var t=i18next.t("Server error occurred saving procedure/treatment information.");return $("#userProcuedures .get-procs-error").html(t),r({error:t}),!1}$(".get-procs-error").html(""),r(e)})},deleteProc:function(e,t,n){this.sendRequest("/api/procedure/"+e,"DELETE",null,{sync:n,targetField:t},function(e){e.error?$(".del-procs-error").html(i18next.t("Server error occurred removing procedure/treatment information.")):$(".del-procs-error").html("")})},getRoleList:function(e,t){this.sendRequest("/api/roles","GET",null,e,function(e){if(t=t||function(){},e.error){var n=i18next.t("Server error occurred retrieving roles information.");$(".get-roles-error").html(n),t({error:n})}else t(e)})},getRoles:function(e,t,n){t=t||function(){};var r="userRole_"+e;if(sessionStorage.getItem(r)){var i=JSON.parse(sessionStorage.getItem(r));t(i)}else this.sendRequest("/api/user/"+e+"/roles","GET",e,n,function(e){if(e)if(e.error){var n=i18next.t("Server error occurred retrieving user role information.");$(".get-roles-error").html(n),t({error:n})}else $(".get-roles-error").html(""),sessionStorage.setItem(r,JSON.stringify(e)),t(e)})},removeCachedRoles:function(e){sessionStorage.removeItem("userRole_"+e)},putRoles:function(e,t,n,r){if(r=r||function(){},!e)return r({error:i18next.t("User Id is required.")}),!1;this.removeCachedRoles(e),this.sendRequest("/api/user/"+e+"/roles","PUT",e,{data:JSON.stringify(t),targetField:n},function(t){if(!t||t.error){var n=i18next.t("Server error occurred setting user role information.");return $(".put-roles-error").html(n),void r({error:n})}$(".put-roles-error").html(""),sessionStorage.setItem("userRole_"+e,""),r(t)})},deleteRoles:function(e,t){if(!e)return!1;this.removeCachedRoles(e),this.sendRequest("/api/user/"+e,"GET",e,{data:JSON.stringify(t)},function(e){e&&(e.error?$(".delete-roles-error").html(i18next.t("Server error occurred deleting user role.")):$(".delete-roles-error").html(""))})},getClinical:function(e,t,n){n=n||function(){},this.sendRequest("/api/patient/"+e+"/clinical","GET",e,t,function(e){if(e)if(e.error){var t=i18next.t("Server error occurred retrieving clinical data.");$(".get-clinical-error").html(t),n({error:t})}else $(".get-clinical-error").html(""),n(e)})},getObservationId:function(e,t){if(!e)return!1;var n="",r="";return this.sendRequest("/api/patient/"+e+"/clinical","GET",e,{sync:!0},function(e){if(!e||e.error||!e.entry)return n;e.entry.forEach(function(e){n||(r=e.content.code.coding[0].code,String(r)===String(t)&&(n=e.content.id))})}),n},postClinical:function(e,t,n,r,i,s,c){if(!e)return!1;s=s||{};var d="",l="";if(o.hasOwnProperty(String(t).toLowerCase())){var u=o[t];d=u.code,l=u.display}if(!d)return!1;var h="POST",p="/api/patient/"+e+"/clinical",m=[{code:d,display:l,system:a.a.CLINICAL_SYS_URL}],f={resourceType:"Observation"};f.code={coding:m},f.issued=s.issuedDate?s.issuedDate:"",f.status=r||"",f.valueQuantity={units:"boolean",value:n},s.performer&&(f.performer=s.performer);var g=this.getObservationId(e,d);g&&(h="PUT",p=p+"/"+g),c=c||function(){},this.sendRequest(p,h,e,{data:JSON.stringify(f),targetField:i},function(e){if(!e||e.error){var t=i18next.t("Server error occurred updating clinical data.");return $(".post-clinical-error").html(t).show(),void c({error:t})}$(".post-clinical-error").html("").hide(),c(e)})},getTermsUrl:function(e,t){t=t||function(){},this.sendRequest("/api/tou","GET",null,{sync:e},function(e){e&&(e.error?($(".get-tou-error").html(i18next.t("Server error occurred retrieving tou url.")),t({error:i18next.t("Server error")})):($(".get-tou-error").html(""),e.url?($("#termsURL").attr("data-url",e.url),$("#termsCheckbox_default .terms-url").attr("href",e.url),t({url:e.url})):t({error:i18next.t("no url returned")})))})},getInstrumentsList:function(e,t){t=t||function(){},this.sendRequest("api/questionnaire_bank","GET",null,{sync:e},function(e){if(e&&!e.error)if(e.entry&&e.entry.length){var n={};e.entry.forEach(function(e){if(e.organization){var t=e.organization.reference.split("/")[2];n[t]||(n[t]=[]),e.questionnaires&&e.questionnaires.forEach(function(e){-1===$.inArray(e.questionnaire.display,n[t])&&n[t].push(e.questionnaire.display)})}}),t(n)}else t({error:i18next.t("no data returned")});else t({error:i18next.t("error retrieving instruments list")})})},getTerms:function(e,t,n,r,i){r=r||function(){},i=i||{};var a="/api/user/{userId}/tou{type}{all}".replace("{userId}",e).replace("{type}",t?"/"+t:"").replace("{all}",i.hasOwnProperty("all")?"?all=true":"");this.sendRequest(a,"GET",e,{sync:n},function(e){if(!e||e.error){var t=i18next.t("Server error occurred retrieving tou data.");return $(".get-tou-error").html(t),void r({error:t})}$(".get-tou-error").html(""),r(e)})},postTermsByUser:function(e,t,n){n=n||function(){},this.sendRequest("/api/user/"+e+"/tou/accepted","POST",e,{data:JSON.stringify(t)},function(e){if(!e||e.error)return $(".post-tou-error").html(i18next.t("Server error occurred saving terms of use information.")),void n(e);$(".post-tou-error").html(""),n(e)})},postTerms:function(e,t,n){n=n||function(){},this.sendRequest("/api/tou/accepted","POST",null,{data:JSON.stringify(e),targetField:t},function(e){if(!e||e.error){var t=i18next.t("Server error occurred saving terms of use information.");return $(".post-tou-error").html(t),void n({error:t})}$(".post-tou-error").html(""),n(e)})},accessUrl:function(e,t,n){if(n=n||function(){},!e)return n({error:i18next.t("User id is required.")}),!1;this.sendRequest("/api/user/"+e+"/access_url","GET",e,{sync:t},function(e){e?e.error?n({error:i18next.t("Error occurred retrieving access url.")}):n({url:e.access_url}):n({error:i18next.t("no data returned")})})},invite:function(e,t,n){if(n=n||function(){},!t)return n({error:i18next.t("Invite data are required.")}),!1;this.sendRequest("/invite","POST",e,{contentType:"application/x-www-form-urlencoded; charset=UTF-8",data:t,dataType:"html"},function(e){n(e||{error:i18next.t("no data returned")})})},passwordReset:function(e,t){if(t=t||function(){},!e)return t({error:i18next.t("User id is required.")}),!1;this.sendRequest("/api/user/"+e+"/password_reset","POST",e,{contentType:"application/x-www-form-urlencoded; charset=UTF-8"},function(e){e?e.error?t({error:i18next.t("Error occurred sending password reset request.")}):t(e):t({error:i18next.t("no data returned")})})},assessmentStatus:function(e,t){if(t=t||function(){},!e)return t({error:i18next.t("User id is required.")}),!1;this.sendRequest("/api/patient/"+e+"/assessment-status","GET",e,null,function(e){e?e.error?t({error:i18next.t("Error occurred retrieving assessment status.")}):t(e):t({error:i18next.t("no data returned")})})},updateAssessment:function(e,t,n){return n=n||function(){},e?t?void this.sendRequest("/api/patient/"+e+"/assessment","PUT",e,{data:JSON.stringify(t)},function(e){e?e.error?n({error:i18next.t("Error occurred retrieving assessment list.")}):n(e):n({error:i18next.t("no data returned")})}):(n({error:i18next.t("Questionnaire response data is required.")}),!1):(n({error:i18next.t("User id is required.")}),!1)},assessmentList:function(e,t,n){if(n=n||function(){},!e)return n({error:i18next.t("User id is required.")}),!1;this.sendRequest("/api/patient/"+e+"/assessment","GET",e,t,function(e){e?e.error?n({error:i18next.t("Error occurred retrieving assessment list.")}):n(e):n({error:i18next.t("no data returned")})})},assessmentReport:function(e,t,n){if(n=n||function(){},!e||!t)return n({error:i18next.t("User id and instrument Id are required.")}),!1;this.sendRequest("/api/patient/"+e+"/assessment/"+t,"GET",e,null,function(e){e?e.error?n({error:i18next.t("Error occurred retrieving assessment report.")}):n(e):n({error:i18next.t("no data returned")})})},getCurrentQB:function(e,t,n,r){if(r=r||function(){},!e)return r({error:i18next.t("User id is required.")}),!1;n=n||{},this.sendRequest("/api/user/"+e+"/questionnaire_bank","GET",e,{data:{as_of_date:t},sync:n.sync},function(e){if(!e||e.error)return r({error:i18next.t("Error occurred retrieving current questionnaire bank for user.")}),!1;r(e)})},patientReport:function(e,t,n){if(n=n||function(){},!e)return n({error:i18next.t("User id is required.")}),!1;this.sendRequest("/api/user/"+e+"/user_documents?document_type=PatientReport","GET",e,t,function(e){e?e.error?n({error:i18next.t("Error occurred retrieving patient report.")}):n(e):n({error:i18next.t("no data returned")})})},setTablePreference:function(e,t,n,r){if(r=r||function(){},n=n||{},!e||!t)return r({error:"User Id and table name is required for setting preference."}),!1;this.sendRequest("/api/user/"+e+"/table_preferences/"+t,"PUT",e,{data:n.data,sync:n.sync},function(e){if(!e||e.error)return r({error:i18next.t("Error occurred setting table preference.")}),!1;r(e)})},getTablePreference:function(e,t,n,r){if(n=n||function(){},r=r||function(){},!e)return r({error:"User Id is required for setting preference."}),!1;this.sendRequest("/api/user/"+e+"/table_preferences/"+t,"GET",e,n,function(e){e&&e.error?r({error:i18next.t("Error occurred setting table preference.")}):r(e)})},emailLog:function(e,t,n){if(n=n||function(){},!e)return n({error:i18next.t("User id is required.")}),!1;this.sendRequest("/api/user/"+e+"/messages","GET",e,t,function(e){e?e.error?n({error:i18next.t("Error occurred retrieving email audit entries.")}):n(e):n({error:i18next.t("no data returned")})})},auditLog:function(e,t,n){if(n=n||function(){},!e)return n({error:i18next.t("User id is required.")}),!1;this.sendRequest("/api/user/"+e+"/audit","GET",e,t,function(e){e?e.error?n({error:i18next.t("Error occurred retrieving audit log.")}):n(e):n({error:i18next.t("no data returned")})})},setting:function(e,t,n,r){if(r=r||function(){},!e)return r({error:i18next.t("configuration key is required.")}),!1;n=n||{},this.sendRequest("/api/settings/"+e,"GET",t,{sync:n.sync},function(e){e?e.error?r({error:i18next.t("Error occurred retrieving content for configuration key.")}):r(e):r({error:i18next.t("no data returned")})})},deactivateUser:function(e,t,n){if(n=n||function(){},!e)return n({error:i18next.t("User id is required")}),!1;this.sendRequest("/api/user/"+e,"DELETE",e,t||{},function(e){n=n||function(){},e&&!e.error?n(e):n({error:i18next.t("Error occurred deactivating user.")})})},reactivateUser:function(e,t,n){if(n=n||function(){},!e)return n({error:i18next.t("User id is required")}),!1;this.sendRequest("/api/user/"+e+"/reactivate","POST",e,t||{},function(e){e&&!e.error?n(e):n({error:i18next.t("Error occurred reactivating user.")})})},getConfigurationByKey:function(e,t,n){if(n=n||function(){},!e)return n({error:i18next.t("configuration variable name is required.")}),!1;var r="config_"+e;if(sessionStorage.getItem(r)){var i=JSON.parse(sessionStorage.getItem(r));return n(i),!0}this.sendRequest("/api/settings/"+e,"GET",null,t||{},function(e){e?(n(e),sessionStorage.setItem(r,JSON.stringify(e))):n({error:i18next.t("no data returned")})})},getConfiguration:function(e,t,n){n=n||function(){};var r="settings_"+e;if(sessionStorage.getItem(r)){var i=JSON.parse(sessionStorage.getItem(r));n(i)}else this.sendRequest("/api/settings","GET",e,t||{},function(e){e?(n(e),sessionStorage.setItem(r,JSON.stringify(e))):n({error:i18next.t("no data returned")})})},getEmailReady:function(e,t,n){if(n=n||function(){},!e)return n({error:i18next.t("User id is required.")}),!1;this.sendRequest("/api/user/"+e+"/email_ready","GET",e,t,function(e){n(e)})}}},function(e,t,n){"use strict";var r,i,a=n(0),o=n(3);t.a=(r=function(e,t,n){this.id=e,this.name=t,this.children=[],this.parentOrgId=n,this.isTopLevel=!1,this.language=null,this.extension=[]},(i=function(){this.TOP_LEVEL_ORGS=[],this.orgsList={},this.initialized=!1}).prototype.init=function(e){var t=this;if(e=e||function(){},sessionStorage.orgsData){var n=JSON.parse(sessionStorage.orgsData);t.populateOrgsList(n),e(n)}else $.ajax({type:"GET",url:"/api/organization",async:!1}).done(function(n){n&&n.entry&&(t.populateOrgsList(n.entry),sessionStorage.setItem("orgsData",JSON.stringify(n.entry)),e(n.entry))}).fail(function(t){e({error:t.responseText}),o.a.sendError(t,"/api/organization")})},i.prototype.onLoaded=function(e,t){e&&this.setUserId(e),t&&this.populateUI(),$("#userOrgs input[name='organization']").each(function(){$(this).prop("checked",!1)}),$("#clinics").attr("loaded",!0)},i.prototype.setUserId=function(e){$("#fillOrgs").attr("userId",e)},i.prototype.getUserId=function(){return $("#fillOrgs").attr("userId")},i.prototype.inArray=function(e,t){if(!e||!t||!Array.isArray(t))return!1;for(var n=!1,r=0;!n&&r<t.length;r++)n=String(t[r])===String(e);return n},i.prototype.getElementParentOrg=function(e){var t;return!!e&&((t=$(e).attr("data-parent-id"))||(t=$(e).closest(".org-container[data-parent-id]").attr("data-parent-id")),t)},i.prototype.getTopLevelOrgs=function(){var e=this.getOrgsList(),t=[];for(var n in e)e[n].isTopLevel&&t.push(n);return t},i.prototype.getOrgsList=function(){return this.orgsList},i.prototype.getOrgName=function(e){var t=this.getOrgsList();return e&&t.hasOwnProperty(e)?t[e].name:""},i.prototype.filterOrgs=function(e){if(0===(e=e||[]).length)return!1;var t=this;$("#fillOrgs input[name='organization']").each(function(){if(!t.inArray($(this).val(),e)&&($(this).hide(),t.orgsList[$(this).val()])){var n=$(this).closest("label");0===t.orgsList[$(this).val()].children.length?n.hide():n.addClass("data-display-only")}}),t.getTopLevelOrgs().forEach(function(e){var t=!0;$("#fillOrgs .org-container[data-parent-id='"+e+"']").each(function(){var e=$(this).find(".org-container");if(e.length>0){var n=!0;e.each(function(){var e=!1;$(this).find("input[name='organization']").each(function(){($(this).is(":visible")||"none"!==String($(this).css("display")))&&(e=!0,t=!1)}),e?n=!1:$(this).hide()}),n&&$(this).children("label").hide()}else{var r=$(this).find("input[name='organization']");r.length>0&&r.each(function(){($(this).is(":visible")||"none"!==String($(this).css("display")))&&(t=!1)})}}),t&&$("#fillOrgs").find("legend[orgid='"+e+"']").hide()})},i.prototype.findOrg=function(e,t){var n;return!(!e||!t)&&(e.forEach(function(e){n||parseInt(e.id)===parseInt(t)&&(n=e)}),n)},i.prototype.getOrgName=function(e){var t=this.orgsList[e];return t?t.name:""},i.prototype.populateOrgsList=function(e){if(Object.keys(this.orgsList).length>0)return this.orgsList;var t,n=e,i=this,o={};return!!e&&(e.forEach(function(e){if(e.partOf){if(t=e.partOf.reference.split("/").pop(),!o[t]){var s=i.findOrg(n,t);o[t]=new r(s.id,s.name)}o[t].children.push(new r(e.id,e.name,t)),o[e.id]?o[e.id].parentOrgId=t:o[e.id]=new r(e.id,e.name,t)}else o[e.id]||(o[e.id]=new r(e.id,e.name)),0!==parseInt(e.id)&&(o[e.id].isTopLevel=!0,i.TOP_LEVEL_ORGS.push(e.id));e.extension&&(o[e.id].extension=e.extension),e.language&&(o[e.id].language=e.language),e.identifier&&(o[e.id].identifier=e.identifier,e.identifier.forEach(function(t){t.system===a.a.shortname&&(o[e.id].shortname=t.value)}))}),e.forEach(function(e){e.partOf&&(t=e.partOf.reference.split("/").pop(),o[e.id]&&(o[e.id].parentOrgId=t))}),e.length>0&&(this.initialized=!0),this.orgsList=o,o)},i.prototype.getShortName=function(e){var t="";if(!e)return t;var n=this.getOrgsList(),r=n.hasOwnProperty(e)?n[e]:{};return r.shortname&&(t=r.shortname),t},i.prototype.populateUI=function(){if(sessionStorage.orgsHTML)return $("#fillOrgs").html(sessionStorage.orgsHTML),!0;var e=this,t=$("#fillOrgs"),n=this.orgsList,r="",i=function(e){if(!e.identifier)return"";var t="",n=!1;return e.identifier.forEach(function(e){!n&&e.system===a.a.practice_region&&e.value&&(t=e.value.split(":")[1],n=!0)}),t},o=Object.keys(n),s=[];(o=o.sort()).forEach(function(e){n[e].isTopLevel&&s.push(e)}),s=s.sort(function(e,t){var r=n[e],i=n[t];return r.name<i.name?-1:r.name>i.name?1:0});var c,d=document.createDocumentFragment();s.forEach(function(e){(c=document.createElement("div")).setAttribute("id",e+"_container");var t=n[e],a=t.shortname||t.name,o=i(t),s=t.name;t.children.length?0===$("#userOrgs legend[orgId='"+e+"']").length&&(c.classList.add("parent-org-container"),r='<legend orgId="'.concat(e,'">').concat(s,'</legend>\n                        <input class="tnth-hide" type="checkbox" name="organization" parent_org="true" data-org-name="').concat(s,'" data-short-name="').concat(a,'" id="').concat(e,'_org" state="').concat(o,'" value="').concat(e,'" /></div>')):0===$("#userOrgs label[id='org-label-"+e+"']").length&&(c.classList.add("parent-org-container","parent-singleton"),r='<label id="org-label-'.concat(e,'" class="org-label">\n                        <input class="clinic" type="checkbox" name="organization" parent_org="true" id="').concat(e,'_org" state="').concat(o,'" value="').concat(e,'"\n                        data-parent-id="').concat(e,'"  data-org-name="').concat(s,'" data-short-name="').concat(a,'" data-parent-name="').concat(s,'"/><span>').concat(s,"</span></label></div>")),c.innerHTML=r,d.appendChild(c)}),t.get(0).appendChild(d),o.forEach(function(r){if(n[r].children.length>0){var a="";n[r].children.sort(function(e,t){return e.name<t.name?-1:e.name>t.name?1:0}).forEach(function(r){var o=r.parentOrgId,s=n[o],c=!!s&&s.isTopLevel,d=i(n[o]),l=e.getTopLevelParentOrg(r.id);if($("#fillOrgs input[name='organization'][value='"+r.id+"']").length>0)return!0;var u={dataAttributes:' data-parent-id="'+l+'"  data-parent-name="'+n[l].name+'" ',containerClass:"",textClass:""};c&&(u.dataAttributes=' data-parent-id="'+o+'"  data-parent-name="'+s.name+'" '),n[r.id].children.length>0?c?(u.containerClass="sub-org-container",u.textClass="text-muted"):u.textClass="text-muter":c&&(u.textClass="text-muted singleton"),a='<div id="'.concat(r.id,'_container" ').concat(u.dataAttributes,' class="indent org-container ').concat(u.containerClass,'">\n                        <label id="org-label-').concat(r.id,'" class="org-label ').concat(u.textClass,'">\n                        <input class="clinic" type="checkbox" name="organization" id="').concat(r.id,'_org" data-org-name="').concat(r.name,'" data-short-name="').concat(r.shortname||r.name,'" state="').concat(d||"",'" value="').concat(r.id,'" ').concat(u.dataAttributes," />\n                        <span>").concat(r.name,"</span></label></div>");var h=$("#"+o+"_container");h.length>0?h.append(a):t.append(a)})}}),sessionStorage.setItem("orgsHTML",t.html()),t.text()||t.html(i18next.t("No organizations available"))},i.prototype.getSelectedOrgTopLevelParentOrg=function(){return this.getTopLevelParentOrg(this.getSelectedOrg().val())},i.prototype.getSelectedOrg=function(){return $("#userOrgs input[name='organization']:checked")},i.prototype.getUserTopLevelParentOrgs=function(e){var t=[],n=this;return!!e&&(e.parentList?e.parentList:(e.forEach(function(e){var r=n.getTopLevelParentOrg(e);r&&!n.inArray(r,t)&&t.push(r)}),e.parentList=t,t))},i.prototype.getTopLevelParentOrg=function(e){var t=this.getOrgsList()[e];return!!t&&(t.isTopLevel?e:t.parentOrgId?this.getTopLevelParentOrg(t.parentOrgId):e)},i.prototype.getChildOrgs=function(e,t){if(t=t||[],!e||!e.length)return t;var n=this.getOrgsList(),r=[];return e.forEach(function(e){var i=n[e.id];if(!i)return!0;t.push(e.id);var a=i.children?i.children:null;a&&a.length&&a.forEach(function(e){r.push(e)})}),this.getChildOrgs(r,t)},i.prototype.getHereBelowOrgs=function(e){var t=this.getOrgsList(),n=this,r=[];if(!e){var i=this.getSelectedOrg();i.length>0&&(e=[],i.each(function(){e.push($(this).val())}))}return(e=e||[]).forEach(function(e){r.push(e);var i=t[e],a=n.getChildOrgs(i&&i.children?i.children:[]);a.length&&(r=r.concat(a))}),r},i.prototype.morphPatientOrgs=function(){var e={};$("#userOrgs input[name='organization']").each(function(){$(this).closest("label").addClass("radio-label"),$(this).prop("checked")&&(e[$(this).val()]=!0),$(this).attr("type","radio"),e[$(this).val()]&&$(this).prop("checked",!0)}),$("#userOrgs .noOrg-container").hide()},i)},,function(e,t,n){"use strict";var r=n(3),i=n(2),a=n(1),o=n(0);t.a={subjectId:"",currentUserId:"",dateFields:["procDay","procMonth","procYear"],entries:[],initCounts:0,init:function(e){var t=this;this.initUserIds(e,function(){if(!t.subjectId)return t.setError(i18next.t("Subject id is required")),!1;t.getOptions(),t.getUserProcedures(),t.initFieldExtension(),t.initFieldEvents()})},initViaTemplate:function(){var e=this;$(document).ready(function(){var t=$("#profileProcSubjectId");t.length&&e.init(t.val())})},initUserIds:function(e,t){t=t||function(){};var n=this;this.setSubjectId(e),r.a.getCurrentUser(function(e){if(!e||e.error)return n.setError(i18next.t("error occurred setting current user id")),void t();n.setCurrentUserId(e.id),n.subjectId||n.setSubjectId(e.id),t()})},setSubjectId:function(e){this.subjectId=e},setCurrentUserId:function(e){this.currentUserId=e},setError:function(e){$("#procDateErrorContainer").html(e||""),e&&$("#procedure_view").html("<p class='text-muted'>"+i18next.t("no data found")+"</p>")},setTreatmentOptionsSelector:function(e){if(e){var t=[];t.push("<option value=''>"+i18next.t("Select")+"</option>"),e.forEach(function(e){t.push("<option value='{value}' data-system='{system}'>{text}</option>".replace("{value}",e.code).replace("{text}",e.text).replace("{system}",e.system))}),$("#tnthproc").append(t.join("")),sessionStorage.setItem("treatmentOptions",JSON.stringify(e))}},getOptions:function(){if($("#tnthproc").length)if(sessionStorage.treatmentOptions)this.setTreatmentOptionsSelector(JSON.parse(sessionStorage.treatmentOptions));else{var e=this,t="/patients/treatment-options";if(window.Worker)return a.a.initWorker(t,{cache:!0},function(t){var n=JSON.parse(t);e.setTreatmentOptionsSelector(n.treatment_options)}),!0;$.ajax({type:"GET",url:t,cache:!0}).done(function(t){e.setTreatmentOptionsSelector(t.treatment_options)}).fail(function(){})}},getCreatorDisplay:function(e,t){return e?String(e)===this.currentUserId?i18next.t("you"):String(e)===String(this.subjectId)?i18next.t("this patient"):i18next.t("staff member")+", <span class='creator'>"+t+"</span>, ":""},getDeleteInvocationDisplay:function(){return $("#popoverHolder .popover__link").html()},setNewEntry:function(e,t){e&&$("#eventListtnthproc").find("tr[data-id='"+t+"'] td.descriptionCell").append("&nbsp; <small class='text-success'><i class='fa fa-check-square-o'></i> <em>"+i18next.t("Added!")+"</em></small>")},setProcedureRowsView:function(){var e="";$("#userProcedures tr[data-id]").each(function(){$(this).find("td").each(function(){$(this).hasClass("list-cell")||$(this).hasClass("lastCell")||(e+="<div>"+$(this).text()+"</div>")})}),$("#procedure_view").html(e||"<p class='text-muted'>"+i18next.t("no data found")+"</p>")},setNoDataDisplay:function(){$("#userProcedures").html("<p id='noEvents'><em>"+i18next.t("You haven't entered any management option yet.")+"</em></p>").animate({opacity:1}),$("#procedure_view").html("<p class='text-muted'>"+i18next.t("no data found")+"</p>"),$("#pastTreatmentsContainer").hide(),$("#eventListLoad").fadeOut()},getUserProcedures:function(e){if(!this.subjectId)return!1;var t=this;$.ajax({type:"GET",url:"/api/patient/"+this.subjectId+"/procedure",cache:!1}).done(function(n){if(0===n.entry.length)return t.setNoDataDisplay(),!1;t.onDidGetProcedures(n.entry,e),$("#eventListLoad").fadeOut()}).fail(function(){t.setError(i18next.t("error occurred retrieving user procedures")),$("#eventListLoad").fadeOut()})},initFieldEvents:function(){var e=this;this.convertToNumericField($("#procYear, #procDay")),setTimeout(function(){$("#tnthproc-submit").eventInput()},150),$("#tnthproc").on("change",function(){$("#tnthproc-submit").attr({"data-name":$(this).val(),"data-system":$(this).find("option:selected").attr("data-system")}),e.checkSubmit("#tnthproc-submit")}),e.dateFields.forEach(function(t){$("#"+t).on("keyup change",function(){e.setDate()})}),$("body").on("click",".data-delete",function(){$(this).closest("tr").remove()})},initPopoverEvents:function(){var e=this;$("[data-toggle='popover']").popover({trigger:"click",placement:"top",html:!0,content:$("#popoverHolder .popover__content").html()}),$("body").on("click",".cancel-delete",function(){$(this).parents("div.popover").prev("a.confirm-delete").trigger("click")}),$("body").on("click",".btn-delete",function(){var t=$(this).parents("tr").attr("data-id");return $(this).parents("tr").fadeOut("slow",function(){$(this).remove(),0===$("#eventListtnthproc tr").length&&e.setNoDataDisplay()}),r.a.deleteProc(t,!1,!1,function(){e.getUserProcedures()}),!1})},onDidGetProcedures:function(e,t){this.populateProcedureRows(e,t),this.setProcedureRowsView(),this.setError(!e||e.error?i18next("Error occurred retrieving procedures"):"")},populateProcedureRows:function(e,t){e.sort(function(e,t){return new Date(t.resource.performedDateTime)-new Date(e.resource.performedDateTime)});var n=this,r=[],a="",s=[],c=0;$.each(e,function(e,t){var a=t.resource.code.coding[0].code,d=t.resource.id;if(-1!==[o.a.CANCER_TREATMENT_CODE,o.a.NONE_TREATMENT_CODE].indexOf(a))return s.push("<input type='hidden' data-id='"+d+"'  data-code='"+a+"' name='otherProcedures' >"),!0;var l=t.resource.meta.by.reference.match(/\d+/)[0],u=n.getCreatorDisplay(l,t.resource.meta.by.display||l),h=new Date(t.resource.meta.lastUpdated),p=i18next.t("(data entered by %actor on %date)").replace("%actor",u).replace("%date",h.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})),m="";String(l)===String(n.currentUserId)&&(m=n.getDeleteInvocationDisplay()),r.push(["<tr data-id='"+d+"' data-code='"+a+"'>","<td width='1%' valign='top' class='list-cell'>&#9679;</td>","<td class='col-md-10 col-xs-10 descriptionCell' valign='top'>"+i.a.formatDateString(t.resource.performedDateTime)+"&nbsp;--&nbsp;"+t.resource.code.coding[0].display+"&nbsp;<em>"+p+"</em></td>","<td class='col-md-2 col-xs-2 lastCell text-left' valign='top'>"+m+"</td>","</tr>"].join("")),c=Math.max(c,d)}),r&&(a='<table  class="table-responsive" width="100%" id="eventListtnthproc" cellspacing="4" cellpadding="6">',a+=r.join(""),a+="</table>",$("#userProcedures").html(a)),this.setNewEntry(t,c),this.initPopoverEvents(),$("#eventListtnthproc tr").length?$("#pastTreatmentsContainer").fadeIn():$("#pastTreatmentsContainer").fadeOut(),$("#userProcedures").append(s.join(""))},handleOtherProcedures:function(){var e=$("#userProcedures input[name='otherProcedures']");if(!e.length)return!1;e.each(function(){var e=$(this).attr("data-code"),t=$(this).attr("data-id");-1!==[o.a.CANCER_TREATMENT_CODE,o.a.NONE_TREATMENT_CODE].indexOf(e)&&r.a.deleteProc(t)})},setAccountCreationRowDisplay:function(e){if(e=e||{},0===$("#pastTreatmentsContainer tr[data-code='"+e.code+"'][data-performedDateTime='"+e.performedDateTime+"']").length){var t=[];t.push("<tr ");var n=[];for(var r in e)n.push("data-"+r+"='"+e[r]+"'");t.push(n.join(" ")),t.push(">"),t.push("<td>&#9679;</td><td>"+e.display+"</td><td>"+e.performedDateTime+"</td><td><a class='btn btn-default btn-xs data-delete'>"+i18next.t("REMOVE")+"</a></td>"),t.push("</tr>"),$("#pastTreatmentsContainer").append(t.join("")),setTimeout(function(){$("#pastTreatmentsContainer").show()},100)}},initFieldExtension:function(){var e=this;$.fn.extend({eventInput:function(){$(this).on("click",function(t){t.stopImmediatePropagation(),$(this).attr("disabled",!0);var n=$(this).attr("data-account-create"),i=e.subjectId,a=$(this).attr("data-name"),o=$(this).attr("data-date"),s=$(this).attr("data-system");if(!a||!o)return!1;var c=$("#tnthproc option:selected").text(),d={resourceType:"Procedure",performedDateTime:o,system:s};if(n)d.display=c,d.code=a,e.setAccountCreationRowDisplay(d);else{e.handleOtherProcedures();var l=[{code:a,display:c,system:s}];d.subject={reference:"Patient/"+i},d.code={coding:l},r.a.postProc(i,d),$("#eventListLoad").show(),setTimeout(function(){e.getUserProcedures(!0)},1800),$("#pastTreatmentsContainer").hide()}return e.reset(),!1})}})},reset:function(){$("#tnthproc").val(""),$("#procDay, #procMonth, #procYear").val(""),$("#tnthproc-submit").addClass("disabled").attr({"data-name":"","data-date":"","data-date-read":"","data-system":""})},checkSubmit:function(e){""!==String($(e).attr("data-name"))&&""!==String($(e).attr("data-date-read"))?$(e).removeClass("disabled").removeAttr("disabled"):$(e).addClass("disabled").attr("disabled",!0)},convertToNumericField:function(e){("ontouchstart"in window||void 0!==window.DocumentTouch&&document instanceof window.DocumentTouch)&&$(e).each(function(){$(this).prop("type","tel")})},isTouchScreen:function(){return"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch},checkDate:function(){var e=$("#procDay"),t=$("#procMonth"),n=$("#procYear"),r=e.val(),a=n.val(),o=$("#procDateErrorContainer");return!(!r||!/(19|20)\d{2}/.test(a)||!($(n).get(0).validity.valid&&$(t).get(0).validity.valid&&$(e).get(0).validity.valid)||(i.a.validateDateInputFields(t.val(),e.val(),n.val(),"procDateErrorContainer")?(o.text("").removeClass("error-message"),0):(o.text(i18next.t("The procedure date must be valid and in required format.")).addClass("error-message"),1)))},setDate:function(){if(this.checkDate()){var e=this.dateFields.map(function(e){return $("#"+e).val()}).join("/");$("#tnthproc-submit").attr("data-date-read",e),$("#tnthproc-submit").attr("data-date",i.a.swap_mm_dd(e))}else $("#tnthproc-submit").attr({"data-date-read":"","data-date":""});this.checkSubmit("#tnthproc-submit")}}},,,,,,,,,,,,,function(e,t,n){"use strict";n.r(t);var r=n(3),i=n(2),a=n(4),o=n(0),s=n(6),c=n(1);window.ProfileObj=new Vue({el:"#mainDiv",components:{"section-view":{props:["data","nodatatext"],template:"<div v-if='data'>{{data}}</div><div class='text-muted' v-else>{{nodatatext}}</div>"},"section-view-extension":{props:["data","nodatatext"],template:"<div v-if='data'><p v-for='item in data'>{{item.display}}</p></div><div class='text-muted' v-else>{{nodatatext}}</div>"},"email-ready-message":{props:["message"],template:"<div class='text-warning email-ready-message' v-show='message'><span class='glyphicon glyphicon-alert warning' aria-hidden='true'></span>{{message}}</div>"}},errorCaptured:function(e,t,n){return console.error("Error: ",e," Component: ",t," Message: ",n),!1},errorHandler:function(e,t){this.dataError=!0;var n=document.getElementById("profileErrorMessage");n&&(n.innerHTML="Error occurred initializing Profile  Vue instance."),console.warn("Profile Vue instance threw an error: ",t,this),console.error("Error thrown: ",e)},created:function(){var e=this;c.a.VueErrorHandling(),this.registerDependencies(),this.getOrgTool(),this.setUserSettings(),this.onBeforeSectionsLoad(),this.setCurrentUserOrgs(),this.initStartTime=new Date,this.initChecks.push({done:!1}),this.setDemoData({beforeSend:e.setSectionLoaders},function(){e.onInitChecksDone()}),this.currentUserId&&(this.initChecks.push({done:!1}),this.modules.tnthAjax.getRoles(this.currentUserId,function(t){t&&t.roles&&t.roles.forEach(function(t){e.currentUserRoles.push(t.name.toLowerCase())}),e.onInitChecksDone()},{useWorker:!0})),this.initChecks.push({done:!1}),this.setConfiguration({useWorker:!0},function(t){if(e.onInitChecksDone(),t.error||!t.hasOwnProperty("CONSENT_WITH_TOP_LEVEL_ORG"))return!1})},mounted:function(){var e=this;Vue.nextTick(function(){e.initIntervalId=setInterval(function(){e.initEndTime=new Date;var t=e.initEndTime-e.initStartTime;t/=1e3,(0===e.initChecks.length||t>=5)&&(clearInterval(e.initIntervalId),e.initSections(function(){e.onSectionsDidLoad(),e.handleOptionalCoreData()}))},30)})},data:{subjectId:"",currentUserId:"",settings:{},orgTool:null,orgsList:{},orgsData:[],initChecks:[],initIntervalId:0,currentUserRoles:[],userOrgs:[],userRoles:[],userEmailReady:!0,messages:{userEmailReadyMessage:"",userInviteEmailInfoMessage:"",userInviteEmailErrorMessage:""},mode:"profile",demo:{data:{resourceType:"Patient",email:"",name:{given:"",family:""},birthDay:"",birthMonth:"",birthYear:""}},stateDict:{AL:i18next.t("Alabama"),AK:i18next.t("Alaska"),AS:i18next.t("American Samoa"),AZ:i18next.t("Arizona"),AR:i18next.t("Arkansas"),CA:i18next.t("California"),CO:i18next.t("Colorado"),CT:i18next.t("Connecticut"),DE:i18next.t("Delaware"),DC:i18next.t("District Of Columbia"),FM:i18next.t("Federated States Of Micronesia"),FL:i18next.t("Florida"),GA:i18next.t("Georgia"),GU:i18next.t("Guam"),HI:i18next.t("Hawaii"),ID:i18next.t("Idaho"),IL:i18next.t("Illinois"),IN:i18next.t("Indiana"),IA:i18next.t("Iowa"),KS:i18next.t("Kansas"),KY:i18next.t("Kentucky"),LA:i18next.t("Louisiana"),ME:i18next.t("Maine"),MH:i18next.t("Marshall Islands"),MD:i18next.t("Maryland"),MA:i18next.t("Massachusetts"),MI:i18next.t("Michigan"),MN:i18next.t("Minnesota"),MS:i18next.t("Mississippi"),MO:i18next.t("Missouri"),MT:i18next.t("Montana"),NE:i18next.t("Nebraska"),NV:i18next.t("Nevada"),NH:i18next.t("New Hampshire"),NJ:i18next.t("New Jersey"),NM:i18next.t("New Mexico"),NY:i18next.t("New York"),NC:i18next.t("North Carolina"),ND:i18next.t("North Dakota"),MP:i18next.t("Northern Mariana Islands"),OH:i18next.t("Ohio"),OK:i18next.t("Oklahoma"),OR:i18next.t("Oregon"),PW:i18next.t("Palau"),PA:i18next.t("Pennsylvania"),PR:i18next.t("Puerto Rico"),RI:i18next.t("Rhode Island"),SC:i18next.t("South Carolina"),SD:i18next.t("South Dakota"),TN:i18next.t("Tennessee"),TX:i18next.t("Texas"),UT:i18next.t("Utah"),VT:i18next.t("Vermont"),VI:i18next.t("Virgin Islands"),VA:i18next.t("Virginia"),WA:i18next.t("Washington"),WV:i18next.t("West Virginia"),WI:i18next.t("Wisconsin"),WY:i18next.t("Wyoming")},roles:{data:[]},CONSENT_ENUM:{consented:{staff_editable:!0,include_in_reports:!0,send_reminders:!0},suspended:{staff_editable:!0,include_in_reports:!0,send_reminders:!1},purged:{staff_editable:!1,include_in_reports:!1,send_reminders:!1}},consent:{consentHeaderArray:[i18next.t("Organization"),'<span class="eproms-consent-status-header">'.concat(i18next.t("Consent Status"),'</span><span class="truenth-consent-status-header">').concat(i18next.t("Consent Status"),"</span>"),'<span class="agreement">'.concat(i18next.t("Agreement"),"</span>"),'<span class="eproms-consent-date-header">'.concat(i18next.t("Date"),'</span><span class="truenth-consent-date-header">').concat(i18next.t("Registration Date"),'</span> <span class="gmt">(').concat(i18next.t("GMT"),")</span>")],consentHistoryHeaderArray:[i18next.t("Organization"),'<span class="eproms-consent-status-header">'.concat(i18next.t("Consent Status"),'</span><span class="truenth-consent-status-header">').concat(i18next.t("Consent Status"),"</span>"),i18next.t("Consent Date"),"".concat(i18next.t("Last Updated"),"<br/><span class='smaller-text'>").concat(i18next.t("( GMT, Y-M-D )"),"</span>"),i18next.t("User")],consentLabels:{default:i18next.t("Consented"),consented:i18next.t("Consented / Enrolled"),withdrawn:"<span data-eproms='true'>".concat(i18next.t("Withdrawn - Suspend Data Collection and Report Historic Data"),"</span><span data-truenth='true'>").concat(i18next.t("Suspend Data Collection and Report Historic Data"),"</span>"),purged:i18next.t("Purged / Removed"),deleted:i18next.t("Replaced")},consentItems:[],currentItems:[],historyItems:[],touObj:[],consentDisplayRows:[],consentListErrorMessage:"",consentLoading:!1,saveLoading:!1,showInitialConsentTerms:!1},assessment:{assessmentListItems:[],assessmentListError:""},emailLog:{data:[]},patientReport:{data:[],hasP3PReport:!1},manualEntry:{loading:!1,initloading:!1,method:"",consentDate:"",completionDate:"",todayObj:{displayDay:"",displayMonth:"",displayYear:""},errorMessage:""},patientEmailForm:{loading:!1},disableFields:[],topLevelOrgs:[],fillViews:{},modules:{},bootstrapTableConfig:{search:!0,smartDisplay:!0,showToggle:!0,showColumns:!0,undefinedText:"--",pagination:!0,pageSize:5,pageList:[5,10,25,50,100],formatShowingRows:function(e,t,n){return i18next.t("Showing {pageFrom} to {pageTo} of {totalRows} records").replace("{pageFrom}",e).replace("{pageTo}",t).replace("{totalRows}",n)},formatAllRows:function(){return i18next.t("All rows")},formatSearch:function(){return i18next.t("Search")},formatNoMatches:function(){return i18next.t("No matching records found")},formatRecordsPerPage:function(e){return i18next.t("{pageNumber} records per page").replace("{pageNumber}",e)},rowStyle:function(e,t){return{css:{"background-color":t%2!=0?"#F9F9F9":"#FFF"}}}}},methods:{registerDependencies:function(){for(var e in window.portalModules||(window.portalModules={}),window.portalModules.SYSTEM_IDENTIFIER_ENUM=o.a,window.portalModules.tnthAjax=r.a,window.portalModules.tnthDates=i.a,window.portalModules.orgTool=a.a,"undefined"!=typeof i18next&&(window.portalModules.i18next=i18next),window.portalModules)({}).hasOwnProperty.call(window.portalModules,e)&&(this.modules[e]=window.portalModules[e])},notProvidedText:function(){return i18next.t("not provided")},setConfiguration:function(e,t){var n=this;t=t||function(){},this.modules.tnthAjax.getConfiguration(this.currentUserId||this.subjectId,e,function(e){if(!e||e.error)return t({error:n.modules.i18next.t("Unable to set user settings.")}),!1;n.settings=e,t(e)})},setBootstrapTableConfig:function(e){return e?$.extend({},this.bootstrapTableConfig,e):this.bootstrapTableConfig},onInitChecksDone:function(){if(0===this.initChecks.length)return!1;this.initChecks.pop()},setCurrentUserOrgs:function(e,t){if(t=t||function(){},this.currentUserId){var n=this;this.modules.tnthAjax.getDemo(this.currentUserId,e,function(e){if(!e||e.error)return t({error:n.modules.i18next.t("Unable to set current user orgs")}),!1;if(!e.careProvider)return!1;var r=n.getOrgTool();n.userOrgs=e.careProvider.map(function(e){return e.reference.split("/").pop()});var i=r.getUserTopLevelParentOrgs(n.userOrgs);n.topLevelOrgs=i.map(function(e){return r.getOrgName(e)}),t(e)})}else t({error:"Current user id is required."})},isUserEmailReady:function(){return this.userEmailReady},setUserEmailReady:function(e){if("profile"!==this.mode)return!1;var t=this;this.modules.tnthAjax.getEmailReady(this.subjectId,e,function(e){if(e.error)return!1;t.userEmailReady=e.ready,t.messages.userEmailReadyMessage=e.reason||""})},isDisableField:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return-1!==this.disableFields.indexOf(e)},handleMedidataRaveFields:function(e){if(!this.settings.MEDIDATA_RAVE_FIELDS||!this.settings.MEDIDATA_RAVE_ORG)return!1;var t=this;this.setCurrentUserOrgs(e,function(){if(-1===t.topLevelOrgs.indexOf(t.settings.MEDIDATA_RAVE_ORG))return!1;$.merge(t.disableFields,t.settings.MEDIDATA_RAVE_FIELDS)})},setDisableEditButtons:function(){if(0===this.disableFields.length)return!1;var e=this;$("#profileMainContent .profile-item-container").each(function(){var t=this.getAttribute("data-sections");if(!t)return!0;e.isDisableField(t)&&$(this).children(".profile-item-edit-btn").css("display","none")})},setDisableFields:function(e){if(!this.currentUserId||this.isAdmin()||!this.isSubjectPatient())return!1;var t=this;this.setConfiguration(e,function(){t.handleMedidataRaveFields(),t.setDisableEditButtons()})},setDemoData:function(e,t){var n=this;if(t=t||function(){},!this.subjectId)return t(),!1;this.modules.tnthAjax.clearDemoSessionData(this.subjectId),this.modules.tnthAjax.getDemo(this.subjectId,e,function(e){if(e){n.demo.data=e,setTimeout(function(){n.setUserEmailReady()},50),e.telecom&&e.telecom.forEach(function(e){"email"===e.system&&(n.demo.data.email=e.value),"phone"===e.system&&("mobile"===e.use&&(n.demo.data.cellPhone=e.value),"home"===e.use&&(n.demo.data.homePhone=e.value))}),e.name?e.name.family&&e.name.given?n.demo.data.fullName=$.trim(e.name.given+" "+e.name.family):e.name.family?n.demo.data.fullName=e.name.family:e.name.given&&(n.demo.data.fullName=e.name.given):n.demo.data.name={family:"",given:""};var r=e.birthDate?e.birthDate.split("-"):["","",""];n.demo.data.displayBirthDate=n.modules.tnthDates.displayDateString(r[1],r[2],r[0]),n.demo.data.birthDay=r[2],n.demo.data.birthMonth=r[1],n.demo.data.birthYear=r[0];var i="",a="",o="",s="";if(e.deceasedDateTime){var c=new Date(e.deceasedDateTime);i=n.pad(c.getUTCMonth()+1),a=c.getUTCDate(),o=c.getUTCFullYear(),s=(c=new Date(c.toUTCString().slice(0,-4))).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}n.demo.data.displayDeceasedDate=s,n.demo.data.deceasedDay=a,n.demo.data.deceasedMonth=i,n.demo.data.deceasedYear=o,e.identifier&&e.identifier.forEach(function(t){t.system===n.modules.SYSTEM_IDENTIFIER_ENUM.external_site_id&&(e.siteId=t.value),t.system===n.modules.SYSTEM_IDENTIFIER_ENUM.external_study_id&&(e.studyId=t.value)}),n.demo.data.language="",e.communication&&e.communication.forEach(function(e){e.language&&e.language.coding&&e.language.coding.forEach(function(e){n.demo.data.language=e,n.demo.data.languageCode=e.code,n.demo.data.languageDisplay=e.display})}),e.extension&&e.extension.forEach(function(e){e.url===n.modules.SYSTEM_IDENTIFIER_ENUM.ethnicity&&e.valueCodeableConcept.coding.forEach(function(e){n.demo.data.ethnicity=n.demo.data.ethnicity||[],n.demo.data.ethnicity.push(e),n.demo.data.ethnicityCodes=e.code}),e.url===n.modules.SYSTEM_IDENTIFIER_ENUM.race&&(e.valueCodeableConcept.coding.forEach(function(e){n.demo.data.race=n.demo.data.race||[],n.demo.data.race.push(e)}),n.demo.data.race&&(n.demo.data.raceCodes=n.demo.data.race.map(function(e){return e.code}))),n.demo.data.timezone||e.url!==n.modules.SYSTEM_IDENTIFIER_ENUM.timezone||(n.demo.data.timezone=e.timezone?e.timezone:"")}),n.demo.data.raceCodes=n.demo.data.raceCodes||[]}t(e)})},setUserSettings:function(){$("#profileForm").length>0&&(this.subjectId=document.querySelector("#profileUserId").value,this.currentUserId=document.querySelector("#profileCurrentUserId").value,this.mode="profile"),$("#aboutForm").length>0&&(this.subjectId=document.querySelector("#iq_userId").value,this.currentUserId=document.querySelector("#iq_userId").value,this.mode="initialQueries");var e=document.querySelector("#accountCreationContentContainer");e&&(this.currentUserId=document.querySelector("#currentStaffUserId").value,this.mode="patient"===e.getAttribute("data-account")?"createPatientAccount":"createUserAccount")},getOrgTool:function(e){if(e=e||function(){},!this.orgTool){var t=this;this.orgTool=new this.modules.orgTool,this.orgTool.init(function(n){n&&!n.error&&(t.orgsData=n),e(n)}),this.orgsList=this.orgTool.getOrgsList()}return this.orgTool},isConsentEditable:function(){var e=-1!==this.currentUserRoles.indexOf("staff"),t=-1!==this.currentUserRoles.indexOf("patient"),n=this.settings.hasOwnProperty("CONSENT_EDIT_PERMISSIBLE_ROLES")&&-1!==this.settings.CONSENT_EDIT_PERMISSIBLE_ROLES.indexOf("staff"),r=this.settings.hasOwnProperty("CONSENT_EDIT_PERMISSIBLE_ROLES")&&-1!==this.settings.CONSENT_EDIT_PERMISSIBLE_ROLES.indexOf("patient");return!this.isDisableField("consent_status")&&(e&&n||t&&r)},isTestEnvironment:function(){return"production"!==String(this.settings.SYSTEM_TYPE).toLowerCase()},isAdmin:function(){return-1!==this.currentUserRoles.indexOf("admin")},isSubjectPatient:function(){return!("createPatientAccount"!==this.mode&&!$("#profileMainContent").hasClass("patient-view"))||(0===this.userRoles.length&&this.initUserRoles({sync:!0}),-1!==this.userRoles.indexOf("patient"))},isStaff:function(){return-1!==this.currentUserRoles.indexOf("staff")||-1!==this.currentUserRoles.indexOf("staff_admin")},isProxy:function(){return""!==this.currenUserId&&""!==this.subjectId&&this.currentUserId!==this.subjectId},isConsentWithTopLevelOrg:function(){return this.settings.CONSENT_WITH_TOP_LEVEL_ORG},getShowInMacro:function(){return this.settings.SHOW_PROFILE_MACROS||[]},setSectionLoaders:function(){$("#profileForm .section-loader").removeClass("tnth-hide")},clearSectionLoaders:function(){$("#profileForm .section-loader").addClass("tnth-hide"),$("#profileForm .profile-item-edit-btn").addClass("active")},onBeforeSectionsLoad:function(){"profile"===this.mode&&document.querySelector("#mainDiv").classList.add("profile")},onSectionsDidLoad:function(){if(this.setDisableFields(),"profile"===this.mode){var e=this;setTimeout(function(){e.initFieldsEvent(),e.initLoginAsButtons(),e.fillViews=e.setView(),e.initEditButtons()},50),$(document).ajaxStop(function(){e.clearSectionLoaders()})}},initLoginAsButtons:function(){var e=this;$("#loginAsButton, #btnLoginAs").on("click",function(t){t.preventDefault(),t.stopPropagation(),sessionStorage.clear(),e.handleLoginAs(t)})},initEditButtons:function(){var e=this;$("#profileForm .profile-item-edit-btn").each(function(){$(this).on("click",function(t){t.preventDefault();var n=$(this).closest(".profile-item-container");n.toggleClass("edit"),$(this).val(n.hasClass("edit")?i18next.t("DONE"):i18next.t("EDIT")),n.hasClass("edit")||(e.fillSectionView(n.attr("data-sections")),e.handleOptionalCoreData())})})},initFieldsEvent:function(){var e=this;$("#profileMainContent [data-loader-container]").each(function(){var t=$(this).attr("id"),n=$(this).find("input, select");if(0===n.length)return!0;n.each(function(){if("hidden"===$(this).attr("type"))return!1;$(this).attr("data-save-container-id",t);var n=$(this).attr("data-trigger-event")||"change";$(this).attr("data-update-on-validated")&&(n="blur"),n+=" change","text"===$(this).attr("type")&&$(this).on("keypress",function(e){if(e.stopPropagation(),13===e.keyCode)return $(this).trigger(n),!1}),$(this).on(n,function(t){t.stopPropagation(),e.modules.tnthAjax.clearDemoSessionData(e.subjectId);var n=!this.validity||this.validity.valid;if(!$(this).attr("data-update-on-validated")&&n)var r=$(this),i=$(this).closest(".profile-item-container"),a=setInterval(function(){var e=$("#"+r.attr("data-error-field")),t=e.length>0&&""!==e.text();if(!t){var n=i.find(".help-block");t=n.length>0&&""!==n.text()}if(t)return clearInterval(a),!1;clearInterval(a),r.trigger("updateDemoData")},10)})})})},initSections:function(e){var t=this,n={},r=0;$("#mainDiv [data-profile-section-id]").each(function(){var e=$(this).attr("data-profile-section-id");n[e]||(setTimeout(function(){t.initSection(e)},r+=20),n[e]=!0)}),e&&setTimeout(function(){e()},r+20)},handleOptionalCoreData:function(){var e=$("#profileDetailContainer");if(e.length>0){var t=e.find(".profile-item-loader");t.show(),this.modules.tnthAjax.getOptionalCoreData(this.subjectId,{useWorker:!0,cache:!0},function(e){e.optional&&$("#profileForm .optional").each(function(){var t=$(this),n=t.attr("data-section-id"),r=t.closest(".profile-item-container"),i=r.find(".view-container tr:visible").length,a=r.find(".no-data-container"),o=r.find(".profile-item-edit-btn");n&&(-1!==e.optional.indexOf(n)?(t.show(),a.html(""),o.show()):(t.hide(),0===i&&(a.html("<p class='text-muted'>"+i18next.t("No information available")+"</p>"),o.hide())))}),t.hide()})}},fillSectionView:function(e){e&&this.fillViews[e]&&this.fillViews[e]()},setView:function(){var e=this;return{setContent:function(e,t){$.trim(t)?e.html(i18next.t(t)):e.html("<p class='text-muted'>"+i18next.t("not provided")+"</p>")},clinical:function(){if(this.setContent($("#pca_diag_view"),$("#patDiag input[name='pca_diag']:checked").closest("label").text()),this.setContent($("#pca_localized_view"),$("#patMeta input[name='pca_localized']:checked").closest("label").text()),$("#biopsyDateContainer").hasClass("has-error")||$("#biopsyDateError").text())return!1;var t=e.modules.tnthDates,n=$("#patBiopsy input[name='biopsy']:checked"),r=n.val(),i=$("#biopsy_month option:selected").val(),a=$("#biopsy_year").val(),o=$("#biopsy_day").val(),s=n.closest("label").text();"true"===String(r)&&$.trim(i+a+o)&&(s+="&nbsp;&nbsp;"+t.displayDateString(i,o,a),$("#biopsyDateContainer").show()),this.setContent($("#biopsy_view"),s)}}},initSection:function(e){switch(String(e).toLowerCase()){case"name":this.initNameSection();break;case"birthday":this.initBirthdaySection();break;case"email":this.initEmailSection();break;case"phone":this.initPhoneSection();break;case"altphone":this.initAltPhoneSection();break;case"orgsstateselector":this.initOrgsStateSelectorSection(),this.initConsentSection();break;case"orgs":this.initDefaultOrgsSection(),this.initConsentSection();break;case"consent":this.initConsentSection();break;case"communication":this.initResetPasswordSection(),this.initCommunicationSection();break;case"patientemailform":this.initPatientEmailFormSection();break;case"staffemailform":this.initStaffRegistrationEmailSection();break;case"resetpassword":this.initResetPasswordSection();break;case"deceased":this.initDeceasedSection();break;case"patientreport":this.initPatientReportSection();break;case"assessmentlist":this.initAssessmentListSection();break;case"clinicalquestions":this.initClinicalQuestionsSection();break;case"custompatientdetail":this.initCustomPatientDetailSection();break;case"procedure":this.initProcedureSection();break;case"roleslist":this.initRolesListSection();break;case"auditlog":this.initAuditLogSection()}},handleLoginAs:function(e){e&&(e.preventDefault(),e.stopPropagation());try{sessionStorage.setItem("loginAsPatient","true")}catch(e){alert(i18next.t("Unable to properly set session storage variable for login-as. ")+e.message)}location.replace("/login-as/"+this.subjectId)},postDemoData:function(e,t,n){if(n=n||function(){},!this.subjectId)return n({error:i18next.t("Subject id is required")}),!1;var r=this;Vue.nextTick(function(){if(e=e||$(e),t=t||{},e.get(0).validity&&!e.get(0).validity.valid)return n({error:i18next.t("Invalid field value.")}),!1;var i=e,a=e.closest(".profile-item-container"),o=a.find(".profile-item-edit-btn"),s=$("#"+i.attr("data-error-field"));if(s.length>0&&""!==s.text())return o.attr("disabled",!1),void n({error:i18next.t("Validation error.")});o.attr("disabled",!0),t.resourceType=t.resourceType||"Patient",r.modules.tnthAjax.putDemo(r.subjectId,t,e,!1,function(e){n(e),setTimeout(function(){r.setDemoData({cache:!1},function(){var e=a.find(".form-group").not(".data-update-on-validated");e.removeClass("has-error"),e.find(".help-block.with-errors").html(""),o.attr("disabled",!1)})},350)})})},getTelecomData:function(){var e=[],t=$("#email").val();$.trim(t)?e.push({system:"email",value:$.trim(t)}):e.push({system:"email",value:"__no_email__"});var n=$.trim($("#phone").val());n&&e.push({system:"phone",use:"mobile",value:n});var r=$.trim($("#altPhone").val());return r&&e.push({system:"phone",use:"home",value:r}),{telecom:e}},getIdentifierData:function(){var e=this,t=$("#profileStudyId"),n=$("#profileSiteId"),r=t.val(),i=n.val(),a=[];if(this.demo.data.identifier?this.demo.data.identifier.forEach(function(e){a.push(e)}):e.subjectId&&$.ajax({type:"GET",url:"/api/demographics/"+e.subjectId,async:!1}).done(function(e){e&&e.identifier&&e.identifier.forEach(function(e){a.push(e)})}).fail(function(t){e.modules.tnthAjax.reportError(e.subjectId,"api/demographics"+e.subjectId,t.responseText)}),a=$.grep(a,function(t){return t.system!==e.modules.SYSTEM_IDENTIFIER_ENUM.external_study_id&&t.system!==e.modules.SYSTEM_IDENTIFIER_ENUM.external_site_id}),r=$.trim(r)){var o={system:e.modules.SYSTEM_IDENTIFIER_ENUM.external_study_id,use:"secondary",value:r};a.push(o)}if(i=$.trim(i)){var s={system:e.modules.SYSTEM_IDENTIFIER_ENUM.external_site_id,use:"secondary",value:i};a.push(s)}return{identifier:a}},getExtensionData:function(){var e,t,n,r=this,i=$("#userEthnicity"),a=$("#userRace"),o=$("#profileTimeZone"),s=[];return i.length>0&&(e=$("#userEthnicity input:checked").map(function(){return{code:$(this).val(),system:r.modules.SYSTEM_IDENTIFIER_ENUM.ethnicity_system}}).get())&&s.push({url:r.modules.SYSTEM_IDENTIFIER_ENUM.ethnicity,valueCodeableConcept:{coding:e}}),a.length>0&&(t=$("#userRace input:checkbox:checked").map(function(){return{code:$(this).val(),system:r.modules.SYSTEM_IDENTIFIER_ENUM.race_system}}).get())&&s.push({url:r.modules.SYSTEM_IDENTIFIER_ENUM.race,valueCodeableConcept:{coding:t}}),o.length>0&&(n=$("#profileTimeZone option:selected").val())&&s.push({timezone:n,url:r.modules.SYSTEM_IDENTIFIER_ENUM.timezone}),{extension:s}},initNameSection:function(){var e=this;$("#firstname").on("updateDemoData",function(){e.postDemoData($(this),{name:{given:$.trim($(this).val())}})}),$("#lastname").on("updateDemoData",function(){e.postDemoData($(this),{name:{family:$.trim($(this).val())}})})},initBirthdaySection:function(){var e=this;["year","month","date"].forEach(function(t){var n=$("#"+t),r=$("#year"),i=$("#month"),a=$("#date");n.on("keyup focusout",function(){if(!r.get(0).validity.valid||!i.get(0).validity.valid||!a.get(0).validity.valid)return $("#birthday").val(""),!1;e.modules.tnthDates.validateDateInputFields(i.val(),a.val(),r.val(),"errorbirthday")?($("#birthday").val(r.val()+"-"+i.val()+"-"+a.val()),$("#errorbirthday").html("")):$("#birthday").val("")}),n.on("updateDemoData",function(){r.val()&&i.val()&&a.val()&&e.postDemoData($(this),{birthDate:r.val()+"-"+i.val()+"-"+a.val()})})}),this.__convertToNumericField($("#date, #year"))},initEmailSection:function(){var e=this;$("#email").attr("data-update-on-validated","true").attr("data-user-id",e.subjectId),$(".btn-send-email").blur(),$("#email").on("keyup",function(e){e.stopPropagation(),$("#erroremail").html("")}),$("#email").on("change",function(){setTimeout(function(){e.updateEmailVis()},350)}),$("#email").on("postEventUpdate",function(){e.updateEmailVis()&&e.postDemoData($(this),e.getTelecomData())})},updateEmailVis:function(){var e=$("#emailGroup").hasClass("has-error"),t=$("#email").val();return e||(this.demo.data.email=t,$("#erroremail").html(""),$("#email_view").html("<p>"+(t||i18next.t("not provided"))+"</p>")),!e},updateTelecomData:function(e){this.postDemoData($(e.target),this.getTelecomData())},initPhoneSection:function(){this.__convertToNumericField($("#phone"))},initAltPhoneSection:function(){this.__convertToNumericField($("#altPhone"))},updateExtensionData:function(e){this.postDemoData($(e.target),this.getExtensionData())},updateGenderData:function(e){this.postDemoData($(e.target),{gender:e.target.value})},updateLocaleData:function(e){var t=$(e.target),n=t.find("option:selected"),r={communication:[{language:{coding:[{code:n.val(),display:n.text(),system:"urn:ietf:bcp:47"}]}}]};this.postDemoData(t,r),this.modules.tnthDates.clearSessionLocale(),setTimeout(function(){window.location.reload(!0)},1e3)},updateIdentifierData:function(e){this.postDemoData($(e.target),this.getIdentifierData())},getAccessUrl:function(){var e="";return this.modules.tnthAjax.accessUrl(this.subjectId,!0,function(t){t.error||(e=t.url)}),e},reloadSendPatientEmailForm:function(e){if(0===$("#sendPatientEmailTabContent").length)return!1;var t=this;$("#sendPatientEmailTabContent").animate({opacity:0},function(){$(this).css("opacity",1),setTimeout(function(){var n=$("#userOrgs input[name='organization']:checked");if("noOrgs"===n.attr("id"))return!1;t.settings.hasOwnProperty("ACCEPT_TERMS_ON_NEXT_ORG")&&n.attr("data-parent-name")===t.settings.ACCEPT_TERMS_ON_NEXT_ORG?($("#profileassessmentSendEmailContainer").addClass("active"),t.assessmentStatus(e)):$("#profileassessmentSendEmailContainer").removeClass("active")},500)})},assessmentStatus:function(e){var t=this;this.modules.tnthAjax.patientReport(e,{useWorker:!0},function(e){if(e.error||!e.user_documents)return!1;t.patientReport.data=e.user_documents;var n=$.grep(e.user_documents,function(e){return/P3P/gi.test(e.filename)});t.patientReport.hasP3PReport=n&&n.length>0,t.patientReport.hasP3PReport&&($("#btnProfileSendassessmentEmail").hide(),$("#assessmentStatusContainer .email-selector-container").hide())})},getEmailContent:function(e,t,n){n=n||function(){},$("#messageLoader_"+t).show(),$("#messageLink_"+t).css("visibility","hidden"),this.modules.tnthAjax.emailLog(e,!1,function(e){if(setTimeout(function(){$("#messageLoader_"+t).hide(),$("#messageLink_"+t).css("visibility","visible")},550),!e.messages)return n(e),!1;$.grep(e.messages,function(e){return parseInt(e.id)===parseInt(t)}).forEach(function(e){$("#emailBodyModal .body-content").html(e.body),$("#emailBodyModal .body-content a").each(function(){$(this).on("click",function(e){return e.preventDefault(),!1})}),$("#emailBodyModal .body-content style").remove(),$("#emailBodyModal .body-content a.btn").addClass("btn-tnth-primary"),$("#emailBodyModal .body-content td.btn, #emailBodyModal .body-content td.btn a").addClass("btn-tnth-primary").removeAttr("width").removeAttr("style"),$("#emailBodyModal").modal("show")}),n(e)})},getEmailLog:function(e,t){if(t.error)$("#emailLogMessage").text(t.error);else{var n=this;t.messages&&t.messages.length>0?(t.messages.forEach(function(t){t.sent_at=n.modules.tnthDates.formatDateString(t.sent_at,"iso"),t.subject='<i id="messageLoader_'.concat(t.id,'" class="message-loader fa fa-spinner fa-spin tnth-hide"></i>\n                                           <a id="messageLink_').concat(t.id,'" class="item-link" data-user-id="').concat(e,'" data-item-id="').concat(t.id,'"><u>').concat(t.subject,"</u></a>")}),$("#emailLogContent").html("<table id='profileEmailLogTable'></table>"),$("#profileEmailLogTable").bootstrapTable(this.setBootstrapTableConfig({data:t.messages,classes:"table table-responsive profile-email-log",sortName:"sent_at",sortOrder:"desc",toolbar:"#emailLogTableToolBar",columns:[{field:"sent_at",title:i18next.t("Date (GMT), Y-M-D"),searchable:!0,sortable:!0},{field:"subject",title:i18next.t("Subject"),class:"message-subject",searchable:!0,sortable:!0},{field:"recipients",title:i18next.t("Email"),sortable:!0,searchable:!0,width:"20%"}]})),setTimeout(function(){$("#lbEmailLog").addClass("active"),$("#profileEmailLogTable a.item-link").on("click",function(){n.getEmailContent($(this).attr("data-user-id"),$(this).attr("data-item-id"))})},150)):$("#emailLogContent").html("<span class='text-muted'>"+i18next.t("No email log entry found.")+"</span>")}},initPatientEmailFormSection:function(){var e=this;$("#profileassessmentSendEmailContainer.active").length>0&&e.assessmentStatus(e.subjectId),$(".email-selector").off("change").on("change",function(){e.messages.userInviteEmailErrorMessage="",e.messages.userInviteEmailInfoMessage="";var t=$(this).closest(".profile-email-container").attr("data-email-type");$(".profilePatientEmail__btn-msg-wrapper").addClass("tnth-hide"),""===$(this).val()?$("#profile"+t+"EmailBtnMsgWrapper").addClass("tnth-hide"):$("#profile"+t+"EmailBtnMsgWrapper").removeClass("tnth-hide");var n=$("#btnProfileSend"+t+"Email");if(""!==String(this.value)&&""!==$("#email").val()&&""===$("#erroremail").text()){var r=i18next.t("{emailType} email will be sent to {email}");r=r.replace("{emailType}",$(this).children("option:selected").text()).replace("{email}",$("#email").val()),e.messages.userInviteEmailInfoMessage=r,n.attr("disabled",!1).removeClass("disabled")}else e.messages.userInviteEmailInfoMessage="",n.attr("disabled",!0).addClass("disabled")}),$("#email").on("change",function(){e.messages.userInviteEmailInfoMessage="",e.messages.userInviteEmailErrorMessage=""}),$(".btn-send-email").off("click").on("click",function(t){t.preventDefault(),t.stopPropagation();var n=$(this).closest(".profile-email-container").attr("data-email-type"),r=$("#profile"+n+"EmailSelect"),i=r.children("option:selected"),a=$(this);if(""===i.val())return!1;var o=i.attr("data-url"),s=$("#email").val(),c="",d="",l="",u="";if(!o)return e.messages.userInviteEmailErrorMessage=i18next.t("Url for email content is unavailable."),!1;var h=function(t,n){t=t||!1,a.attr("disabled",t).show(),e.patientEmailForm.loading=n,t?a.addClass("disabled"):a.removeClass("disabled")};h(!0,!0),a.hide(),$.ajax({type:"GET",url:o,cache:!1,async:!0}).done(function(t){return t&&t.subject&&t.body?(c=t.subject,d=t.body,"invite"===i.val()&&"registration"===n&&((l=e.getAccessUrl())?d=d.replace(/url_placeholder/g,decodeURIComponent(l)):u=i18next.t("failed request to get email invite url")),e.messages.userInviteEmailErrorMessage="",u?(e.messages.userInviteEmailErrorMessage=u,h(),!1):void e.modules.tnthAjax.invite(e.subjectId,{subject:c,recipients:s,body:d},function(t){if(t.error)return e.messages.userInviteEmailErrorMessage=i18next.t("Error occurred while sending invite email."),h(),!1;e.messages.userInviteEmailInfoMessage="<strong class='text-success'>"+i18next.t("{emailType} email sent to {emailAddress}").replace("{emailType}",i.text()).replace("{emailAddress}",s)+"</strong>",r.val(""),e.modules.tnthAjax.emailLog(e.subjectId,{useWorker:!0},function(t){setTimeout(function(){e.getEmailLog(e.subjectId,t)},100)}),h(!0)})):(e.messages.userInviteEmailErrorMessage="<div>"+i18next.t("Unable to send email. Missing content.")+"</div>",h(),!1)}).fail(function(t){e.messages.userInviteEmailErrorMessage=i18next.t("Error occurred retreving email content via API."),h(),e.modules.tnthAjax.reportError(e.subjectId,o,t.responseText)})})},initStaffRegistrationEmailSection:function(){var e=this;$("#btnProfileSendEmail").on("click",function(t){t.preventDefault();var n,r,i=$("#email").val(),a="",o="",s="",c=(n=$("#userOrgs input[name='organization']:checked"),r="",n.length>0&&n.each(function(){r||(r=$(this).attr("data-parent-name")||$(this).closest(".org-container[data-parent-id]").attr("data-parent-name"))}),r||i18next.t("your clinic"));$(this).addClass("disabled").attr("disabled",!0),$("#sendRegistrationEmailForm .loading-indicator").show(),$("#profileEmailErrorMessage").html("");var d=$(this);$.ajax({type:"GET",url:$("#staffRegistrationEmailUrl").val(),cache:!1,async:!1}).done(function(e){e&&(a=e.subject,o=e.body)}).fail(function(){}),o||(o="<p>"+i18next.t("Hello, this is an invitation to complete your registration.")+"</p>",(s=e.getAccessUrl())&&(o+="<a href='"+decodeURIComponent(s)+"'>"+i18next.t("Verify your account to complete registration")+"</a>")),a||(a=i18next.t("Registration invite from {clinicName}").replace("{clinicName}",c)),e.modules.tnthAjax.invite(e.subjectId,{subject:a,recipients:i,body:o},function(e){e.error?e.error&&$("#profileEmailErrorMessage").text(i18next.t("Error occurred while sending invite email.")):($("#profileEmailMessage").text(i18next.t("invite email sent to {email}").replace("{email}",i)),$("#btnProfileSendEmail").attr("disabled",!0)),$("#sendRegistrationEmailForm .loading-indicator").hide(),d.removeClass("disabled").attr("disabled",!1)})})},initCommunicationSection:function(){$("#communicationsContainer .tab-label").on("click",function(){$("#communicationsContainer .tab-label").removeClass("active"),$(this).addClass("active")}),$("#emailBodyModal").modal({show:!1});var e=this.subjectId,t=this;this.modules.tnthAjax.emailLog(e,{useWorker:!0},function(n){setTimeout(function(){t.getEmailLog(e,n)},100)})},initResetPasswordSection:function(){var e=this;$("#btnPasswordResetEmail").on("click",function(t){t.preventDefault(),t.stopImmediatePropagation();var n=$("#email").val();e.modules.tnthAjax.passwordReset(e.subjectId,function(e){e.error?$("#passwordResetMessage").text(i18next.t("Unable to send email.")):$("#passwordResetMessage").text(i18next.t("Password reset email sent to {email}").replace("{email}",n))})})},updateDeceasedSection:function(e){var t={},n=$("#boolDeath").is(":checked"),r=$("#consentListTable .withdrawn-label").length,i=n&&!r&&this.settings.LOCALIZED_AFFILIATE_ORG&&-1!==this.topLevelOrgs.indexOf(this.settings.LOCALIZED_AFFILIATE_ORG);if($("#deceasedInfo").html(""),$("#deathDate").val()&&(t.deceasedDateTime=$("#deathDate").val()),t.deceasedBoolean=n,i){var a=this,o=this.subjectId,s=function(e){$("#boolDeath, #deathDate, #deathDay, #deathYear, #deathMonth").attr("disabled",e)},c=function(){$("#deceasedConsentPopover").popover("hide")},d=function(){a.demo.data.deceasedDateTime||$("#deathDate, #deathDay, #deathYear, #deathMonth").val(""),"true"!==String(a.demo.data.deceasedBoolean).toLowerCase()&&$("#boolDeath").prop("checked",!1),c()};$("#deceasedConsentPopover").attr("aria-describedby")||$("#deceasedConsentPopover").popover("show"),$("#btnDeceasedConsentYes").off("click").on("click",function(n){n.stopPropagation(),s(!0),a.postDemoData(e,t,function(e){if(!e||e.error)return s(!1),!1;var t=a.getOrgTool().getSelectedOrg();t.length?a.modules.tnthAjax.withdrawConsent(o,t.val(),"",function(e){s(!1),e.error?$("#deceasedInfo").html(i18next.t("Error occurred suspending consent for subject.")):(c(),a.reloadConsentList(o))}):s(!1)})}),$("#btnDeceasedConsentNo").off("click").on("click",function(e){e.stopPropagation(),d()}),$("#profileDeceasedSection .profile-item-edit-btn").on("click",function(e){e.stopPropagation(),d()})}else this.postDemoData(e,t)},initDeceasedSection:function(){var e=this;$("#deathYear").val(""),$("#deathMonth").val(""),$("#deathDay").val(""),$("#deathDate").val(""),$("#boolDeath").prop("checked",!1),this.demo.data.deceasedDateTime&&($("#deathYear").val(this.demo.data.deceasedYear),$("#deathMonth").val(this.demo.data.deceasedMonth),$("#deathDay").val(this.demo.data.deceasedDay),$("#deathDate").val(this.demo.data.deceasedMonth+"-"+this.demo.data.deceasedDay+"-"+this.demo.data.deceasedYear),$("#boolDeath").prop("checked",!0)),"true"===String(this.demo.data.deceasedBoolean).toLowerCase()&&$("#boolDeath").prop("checked",!0),this.__convertToNumericField($("#deathDay, #deathYear")),$("#boolDeath").on("click",function(){$(this).is(":checked")||($("#deathYear").val(""),$("#deathDay").val(""),$("#deathMonth").val(""),$("#deathDate").val("")),e.updateDeceasedSection($("#boolDeathGroup"))}),["deathDay","deathMonth","deathYear"].forEach(function(t){var n=$("#"+t),r="text"===n.attr("type")?"blur":"change";n.on(r,function(){var t=$("#deathDay"),n=$("#deathMonth"),r=$("#deathYear");if(t.val()&&n.val()&&r.val()&&t.get(0).validity.valid&&n.get(0).validity.valid&&r.get(0).validity.valid){var i=e.modules.tnthDates.dateValidator(t.val(),n.val(),r.val(),!0);""===i?($("#deathDate").val(r.val()+"-"+n.val()+"-"+t.val()),$("#boolDeath").prop("checked",!0),$("#errorDeathDate").text(""),e.updateDeceasedSection($("#deceasedDateContainer"))):$("#errorDeathDate").text(i)}})})},initPatientReportSection:function(){var e=this;this.modules.tnthAjax.patientReport(e.subjectId,{useWorker:!0},function(t){if(t.error)$("#profilePatientReportTable").closest("div.profile-item-container").hide(),$("#patientReportErrorMessage").text(i18next.t("Problem retrieving reports from server.")).addClass("error-message");else if(t.user_documents&&t.user_documents.length>0){var n=[];t.user_documents.forEach(function(t){t.filename=e.escapeHtml(t.filename),t.document_type=e.escapeHtml(t.document_type),t.uploaded_at=e.modules.tnthDates.formatDateString(t.uploaded_at,"iso"),t.actions='<a title="'.concat(i18next.t("Download"),'" href="').concat("/api/user/"+String(t.user_id)+"/user_documents/"+String(t.id),'"><i class="fa fa-download"></i></a>'),n.push(t)}),e.patientReport.data=n,$("#profilePatientReportTable").bootstrapTable(e.setBootstrapTableConfig({data:n,classes:"table table-responsive profile-patient-reports",sortName:"uploaded_at",sortOrder:"desc",toolbar:"#prTableToolBar",columns:[{field:"contributor",title:i18next.t("Type"),searchable:!0,sortable:!0},{field:"filename",title:i18next.t("Report Name"),searchable:!0,sortable:!0},{field:"uploaded_at",title:i18next.t("Generated (GMT)"),sortable:!0,searchable:!0,width:"20%"},{field:"document_type",title:i18next.t("Document Type"),sortable:!0,visible:!1},{field:"actions",title:i18next.t("Download"),sortable:!1,searchable:!1,visible:!0,class:"text-center"}]}))}else $("#patientReportErrorMessage").text(i18next.t("No reports available.")).removeClass("error-message")})},initAssessmentListSection:function(){var e=this;$("#assessmentListMessage").text(i18next.t("No questionnaire data found.")),e.modules.tnthAjax.assessmentList(e.subjectId,{useWorker:!0},function(t){if(t.error)return e.assessment.assessmentListError=i18next.t("Problem retrieving session data from server."),!1;e.assessment.assessmentListError="";var n=$("#_session_user_id").val(),r=t.entry?t.entry:null;if(!r||0===r.length)return!1;r.forEach(function(t,r){var i=t.questionnaire.reference,a=String(i).split("/"),o=a.length>0?a[a.length-1]:"";if(!o)return!1;var s=String(t.authored),c="/patients/session-report/"+n+"/"+o+"/"+s;e.assessment.assessmentListItems.push({title:i18next.t("Click to view report"),link:c,display:i18next.t(t.questionnaire.display),status:i18next.t(t.status),class:r%2!=0?"class='odd'":"class='even'",date:e.modules.tnthDates.formatDateString(t.authored,"iso")})})})},handleSelectedState:function(e){var t=e.target.value;this.orgsSelector.selectedState=t},isAcceptOnNextOrg:function(e){return!!this.settings&&e===this.settings.ACCEPT_TERMS_ON_NEXT_ORG},initOrgsStateSelectorSection:function(){var e=this,t=this.getOrgTool(),n=this.subjectId,r={AL:i18next.t("Alabama"),AK:i18next.t("Alaska"),AS:i18next.t("American Samoa"),AZ:i18next.t("Arizona"),AR:i18next.t("Arkansas"),CA:i18next.t("California"),CO:i18next.t("Colorado"),CT:i18next.t("Connecticut"),DE:i18next.t("Delaware"),DC:i18next.t("District Of Columbia"),FM:i18next.t("Federated States Of Micronesia"),FL:i18next.t("Florida"),GA:i18next.t("Georgia"),GU:i18next.t("Guam"),HI:i18next.t("Hawaii"),ID:i18next.t("Idaho"),IL:i18next.t("Illinois"),IN:i18next.t("Indiana"),IA:i18next.t("Iowa"),KS:i18next.t("Kansas"),KY:i18next.t("Kentucky"),LA:i18next.t("Louisiana"),ME:i18next.t("Maine"),MH:i18next.t("Marshall Islands"),MD:i18next.t("Maryland"),MA:i18next.t("Massachusetts"),MI:i18next.t("Michigan"),MN:i18next.t("Minnesota"),MS:i18next.t("Mississippi"),MO:i18next.t("Missouri"),MT:i18next.t("Montana"),NE:i18next.t("Nebraska"),NV:i18next.t("Nevada"),NH:i18next.t("New Hampshire"),NJ:i18next.t("New Jersey"),NM:i18next.t("New Mexico"),NY:i18next.t("New York"),NC:i18next.t("North Carolina"),ND:i18next.t("North Dakota"),MP:i18next.t("Northern Mariana Islands"),OH:i18next.t("Ohio"),OK:i18next.t("Oklahoma"),OR:i18next.t("Oregon"),PW:i18next.t("Palau"),PA:i18next.t("Pennsylvania"),PR:i18next.t("Puerto Rico"),RI:i18next.t("Rhode Island"),SC:i18next.t("South Carolina"),SD:i18next.t("South Dakota"),TN:i18next.t("Tennessee"),TX:i18next.t("Texas"),UT:i18next.t("Utah"),VT:i18next.t("Vermont"),VI:i18next.t("Virgin Islands"),VA:i18next.t("Virginia"),WA:i18next.t("Washington"),WV:i18next.t("West Virginia"),WI:i18next.t("Wisconsin"),WY:i18next.t("Wyoming")};$("#stateSelector").on("change",function(){var e=$(this).find("option:selected"),t=$("#"+e.val()+"_container"),n=i18next.t("What is your main clinic for prostate cancer care");$("#userOrgsInfo").hide(),""!==e.val()?"none"===e.val()?($(".state-container, .noOrg-container").hide(),$(".clinic-prompt").text("").hide(),$("#noOrgs").prop("checked",!0).trigger("click")):t.length>0?($(".state-container").hide(),$(".clinic-prompt").text(n+" in "+e.text()+"?").show(),$(".noOrg-container").show(),$("#noOrgs").prop("checked",!1)):($(".state-container, .clinic-prompt, .noOrg-container").hide(),$("#userOrgsInfo").show()):($(".state-container, .noOrg-container").hide(),$(".clinic-prompt").text("").hide())});var i=this.orgsList,a={},o="";e.orgsData.forEach(function(t){var n="";if(!t.identifier)return!1;t.identifier.forEach(function(o){String(o.system)===String(e.modules.SYSTEM_IDENTIFIER_ENUM.practice_region)&&o.value&&(n=o.value.split(":")[1],n=o.value.split(":")[1],a.hasOwnProperty(n)?a[n].push(t.id):(a[n]=[t.id],$("#userOrgs .main-state-container").prepend("<div id='"+n+"_container' state='"+n+"' class='state-container'></div>")),0===$("#stateSelector option[value='"+n+"']").length&&$("#stateSelector").append("<option value='"+n+"'>"+r[n]+"</option>"),i[t.id].state=n)})});var s=$.grep(this.orgsData,function(e){return 0!==parseInt(e.id)&&!e.partOf});(s=s.sort(function(e,t){var n=i[e.id],r=i[t.id];return n&&r?n.children.length>0&&r.children.length>0?e.name<t.name?-1:e.name>t.name?1:0:n.children.length>0&&0===r.children.length?-1:r.children.length>0&&0===n.children.length?1:e.name<t.name?-1:e.name>t.name?1:0:0})).forEach(function(t){var n=i[t.id].state;if($("#"+n+"_container").length>0){var r=i[t.id];o=!e.isAcceptOnNextOrg(t.name)&&r.children.length>0?'<legend orgId="'.concat(t.id,'">').concat(i18next.t(t.name),'</legend><input class="tnth-hide" type="checkbox" name="organization" parent_org="true" data-org-name="').concat(t.name,'"  id="').concat(t.id,'_org" value="').concat(t.id,'" />'):'<div class="radio parent-singleton"><label><input class="clinic" type="radio" id="'.concat(t.id,'_org" value="').concat(t.id,'" state="').concat(n,'" name="organization" data-parent-name="').concat(t.name,'" data-parent-id="').concat(t.id,'">').concat(i18next.t(t.name),"</label></div>"),$("#"+n+"_container").append(o)}});var c=$.grep(this.orgsData,function(e){return 0!==parseInt(e.id)&&e.partOf});(c=c.sort(function(e,t){return e.name<t.name?1:e.name>t.name?-1:0})).forEach(function(n){var r=n.partOf.reference.split("/")[2];if(r){if(e.isAcceptOnNextOrg(t.getOrgName(r)))return!0;var i=function(e,t){if(!e)return"";var n="",r=!1;for(var i in t)r||t[i].forEach(function(t){String(t)===String(e)&&(n=i,r=!0)});return n}(r,a);o='<div class="radio"><label class="indent"><input class="clinic" type="radio" id="'.concat(n.id,'_org" value="').concat(n.id,'" state="').concat(i,'" name="organization" data-parent-name="').concat(n.name,'" data-parent-id="').concat(r,'">').concat(i18next.t(n.name),"</label></div>"),$("#"+i+"_container legend[orgId='"+r+"']").length>0?$("#"+i+"_container legend[orgId='"+r+"']").after(o):$("#"+i+"_container").append(o)}});var d=$("#stateSelector option");if(d.length>0){var l=$("#stateSelector").sortOptions();l&&l.length>0&&$("#stateSelector").empty().append(d).append('<option value="none">'.concat(i18next.t("Other"),"</option>")).prepend('<option value="" selected>'.concat(i18next.t("Select"),"</option>")).val(""),$(".state-container, .clinic-prompt").hide(),setTimeout(function(){var e=$("#userOrgs input[name='organization']:checked");e.length>0&&0!==parseInt(e.val())&&(e.closest(".state-container").show(),$(".clinic-prompt").show())},150),$("#userOrgs input[name='organization']").each(function(){0!==parseInt($(this).val())&&e.getDefaultModal(this)}),t.onLoaded(n,!1),e.handleOrgsEvent(),e.setOrgsVis()}else $("#userOrgs .selector-show").hide(),t.onLoaded(n,!0),e.handleOrgsEvent(),e.setOrgsVis(function(){t.filterOrgs(t.getHereBelowOrgs()),t.morphPatientOrgs(),$(".noOrg-container, .noOrg-container *").show()});$("#mainDiv.profile").length>0&&e.modules.tnthAjax.getConsent(n,{useWorker:!0},function(t){e.getConsentList(t)}),$("#clinics").attr("loaded",!0)},initDefaultOrgsSection:function(){var e=this.subjectId,t=this.getOrgTool(),n=this;t.onLoaded(e,!0),this.setOrgsVis(function(){"undefined"!=typeof leafOrgs&&leafOrgs&&t.filterOrgs(leafOrgs),$("#requireMorph").val()&&t.morphPatientOrgs(),n.handleOrgsEvent(),n.modules.tnthAjax.getConsent(e,{useWorker:!0},function(e){n.getConsentList(e)}),$("#clinics").attr("loaded",!0)})},setOrgsVis:function(e){e=e||function(){};var t=this.demo.data?this.demo.data:null;if(!t||!t.careProvider)return e(),!1;for(var n=0;n<t.careProvider.length;n++){var r=t.careProvider[n].reference.split("/").pop();if(0===parseInt(r))$("#userOrgs #noOrgs").prop("checked",!0),$("#stateSelector").length>0&&$("#stateSelector").find("option[value='none']").prop("selected",!0).val("none");else{var i=$("#userOrgs input.clinic[value="+r+"]");if($(".state-container").length>0){if(i.length>0){i.prop("checked",!0);var a=i.attr("state");a&&$("#stateSelector").find("option[value='"+a+"']").prop("selected",!0).val(i18next.t(a)),$("#clinics .state-selector-container").show(),$("#stateSelector").trigger("change")}$(".noOrg-container").show()}else if(i.length>0)i.prop("checked",!0);else{var o=$("#fillOrgs").find("legend[orgid='"+r+"']");o.length>0&&o.attr("data-checked","true")}}}e(t)},handleOrgsEvent:function(){var e=this,t=this.getOrgTool();$("#userOrgs input[name='organization']").each(function(){$(this).attr("data-save-container-id","userOrgs"),$(this).on("click",function(){var n=e.subjectId,r=t.getElementParentOrg(this),i=$("#userOrgs input[name='organization']").not("[id='noOrgs']");if($(this).prop("checked")&&("noOrgs"!==$(this).attr("id")?$("#noOrgs").prop("checked",!1):i.prop("checked",!1)),sessionStorage.getItem("noOrgModalViewed")&&sessionStorage.removeItem("noOrgModalViewed"),$("#userOrgs .help-block").removeClass("error-message").text(""),"noOrgs"!==$(this).attr("id")&&$("#fillOrgs").attr("patient_view"))if(e.modules.tnthAjax.hasConsent(n,r))e.updateOrgs($("#clinics"),!0);else{var a=e.getConsentModal(r);a&&a.length>0?setTimeout(function(){a.modal("show")},50):(e.updateOrgs($("#clinics"),!0),setTimeout(function(){e.setDefaultConsent(n,r)},500))}else{e.updateOrgs($("#clinics"),!0);var o=$(this);setTimeout(function(){e.handleConsent(o)},500),e.reloadConsentList(n)}e.handlePcaLocalized(),$("#locale").length>0&&e.modules.tnthAjax.getLocale(n),$("#profileassessmentSendEmailContainer").length>0&&setTimeout(function(){e.reloadSendPatientEmailForm(e.subjectId)},150)})})},getNoOrgDisplay:function(){return"<p class='text-muted'>"+this.modules.i18next.t("No affiliated clinic")+"</p>"},getOrgsDisplay:function(){if(!this.demo.data.careProvider||0===this.demo.data.careProvider.length)return this.getNoOrgDisplay();var e=this;return this.demo.data.careProvider.map(function(t){return"api/organization/0"===String(t.reference)?e.getNoOrgDisplay():t.reference.match(/^api\/organization/gi)?"<p>"+t.display+"</p>":""}).join("")},updateOrgs:function(e,t){var n={resourceType:"Patient"},r=$("#preselectClinic").val(),i=this.subjectId;if(r){var a=$("#userOrgs input[name='organization'][value='"+r+"']").attr("data-parent-id")||r;this.modules.tnthAjax.hasConsent(i,a)&&(n.careProvider=[{reference:"api/organization/"+r}])}else{var o=$("#userOrgs input[name='organization']:checked").map(function(){return{reference:"api/organization/"+$(this).val()}}).get();o&&o.length>0&&(n.careProvider=o),$("#fillOrgs legend[data-checked]").each(function(){var e=$(this).attr("orgid");e&&(n.careProvider=n.careProvider||[],n.careProvider.push({reference:"api/organization/"+e}))})}0!==$("#aboutForm").length||n.careProvider||(n.careProvider=[{reference:"api/organization/0"}]),this.modules.tnthAjax.putDemo(i,n,e,t,this.setDemoData)},getConsentModal:function(e){var t=this.getOrgTool();if(!(e=e||t.getElementParentOrg(t.getSelectedOrg())))return!1;var n=$("#"+e+"_consentModal");if(n.length>0)return n;var r=this.getDefaultModal(t.getSelectedOrg());return!!(r&&r.length>0)&&r},getDefaultAgreementUrl:function(e){var t=$("#stock_consent_url").val(),n="",r=$("#"+e+"_org");if(t&&r.length>0){var i=r.attr("data-parent-name")||r.attr("data-org-name");n=t.replace("placeholder",encodeURIComponent(i))}return n},setDefaultConsent:function(e,t){if(!e)return!1;var n=this.getDefaultAgreementUrl(t),r=this;if(!n)return $($("#consentContainer .error-message").get(0)).text(i18next.t("Unable to set default consent agreement")),!1;var i=r.modules.tnthAjax.consentParams;i.org=t,i.agreementUrl=n,r.modules.tnthAjax.setConsent(e,i,"default"),setTimeout(function(){r.removeObsoleteConsent()},100),r.reloadConsentList(e),$($("#consentContainer .error-message").get(0)).text("")},removeObsoleteConsent:function(){var e=this.subjectId,t=[],n=this.getOrgTool();$("#userOrgs input[name='organization']").each(function(){if($(this).is(":checked")){t.push($(this).val());var e=n.getElementParentOrg(this);e&&t.push(e)}}),this.modules.tnthAjax.deleteConsent(e,{org:"all",exclude:t.join(",")})},handleConsent:function(e){var t=this,n=this.getOrgTool(),r=this.subjectId,i=this.isConsentWithTopLevelOrg(),a=t.modules.tnthAjax;$(e).each(function(){var e=n.getElementParentOrg(this),o=$(this).val();if($(this).prop("checked"))if("noOrgs"!==$(this).attr("id")){var s=$("#"+e+"_agreement_url").val();if(""!==String(s)){var c=t.CONSENT_ENUM.consented;c.org=i?e:o,c.agreementUrl=s,setTimeout(function(){a.setConsent(r,c,"all",!0,function(){t.removeObsoleteConsent()})},350)}else t.setDefaultConsent(r,e)}else setTimeout(function(){a.deleteConsent(r,{org:"all"})},350);else if(i){var d=$("#userOrgs input[data-parent-id='"+e+"']");$("#fillOrgs").attr("patient_view")&&(d=$("#userOrgs div.org-container[data-parent-id='"+e+"']").find("input[name='organization']")),!d.is(":checked")&&setTimeout(function(){a.deleteConsent(r,{org:e})},350)}else setTimeout(function(){a.deleteConsent(r,{org:o})},350)})},getDefaultModal:function(e){if(!e)return!1;var t=this.getOrgTool(),n=t.getElementParentOrg(e),r=n+"_defaultConsentModal",i=$("#"+r);if(i.length>0)return i;var a=t.getOrgsList(),o=a.hasOwnProperty(n)?a[n]:null,s=o&&o.shortname?o.shortname:$(e).attr("data-parent-name")||$(e).closest("label").text(),c=i18next.t("Consent to share information"),d=i18next.t("I consent to sharing information with <span class='consent-clinic-name'>{orgName}</span>.".replace("{orgName}",s)),l=$("#defaultConsentModal").clone(!0),u=l.html();return u=u.replace(/\{orgId\}/g,n).replace(/\{close\}/g,i18next.t("Close")).replace(/\{yes\}/g,i18next.t("Yes")).replace(/\{no\}/g,i18next.t("No")).replace(/\{title\}/g,c).replace(/\{consentText\}/g,d),l.html(u),l.attr("id",r),$("#defaultConsentContainer").append(l),i},initConsentSection:function(){var e=this,t=this.getOrgTool(),n=$("#consentContainer .modal, #defaultConsentContainer .modal"),r=n.find("button.btn-consent-close, button[data-dismiss]");$("#consentHistoryModal").modal({show:!1}),n.each(function(){var e=$(this).find(".agreement-url").val();/stock\-org\-consent/.test(e)&&$(this).find(".terms-wrapper").hide()}),n.find("input[name='toConsent']").off("click").on("click",function(t){t.stopPropagation(),r.attr("disabled",!0);var i=$(this).attr("data-org"),a=e.subjectId,o=function(t,i){i?$("#"+t+"_consentAgreementMessage").html(i):($("#"+t+"_consentAgreementMessage").html(""),setTimeout(function(){n.modal("hide"),e.removeObsoleteConsent()},250),setTimeout(function(){e.reloadConsentList(a)},500)),$("#"+t+"_loader.loading-message-indicator").hide(),r.attr("disabled",!1)};if($("#"+i+"_loader.loading-message-indicator").show(),"yes"===$(this).val()){var s=e.CONSENT_ENUM.consented;s.org=i,s.agreementUrl=$("#"+i+"_agreement_url").val()||e.getDefaultAgreementUrl(i),setTimeout(function(){e.modules.tnthAjax.setConsent(a,s,"",!1,function(e){o(i,e.error)})},50)}else e.modules.tnthAjax.deleteConsent(a,{org:i}),o(i)}),r.off("click").on("click",function(e){e.preventDefault(),e.stopPropagation(),setTimeout(function(){location.reload()},10)}),n.each(function(){$(this).on("hidden.bs.modal",function(){$(this).find("input[name='toConsent']:checked").length>0&&($("#userOrgs input[name='organization']").each(function(){$(this).removeAttr("data-require-validate")}),e.updateOrgs($("#clinics"),!0))}),$(this).on("show.bs.modal",function(){var e=$("#userOrgs input[name='organization']:checked"),n=e.attr("data-short-name")||e.attr("data-org-name");n||(n=t.getShortName(e.val())),n&&$(this).find(".consent-clinic-name").text(i18next.t(n)),$("#consentContainer input[name='toConsent']").each(function(){$(this).prop("checked",!1)});var r=$(this);$(this).find("button.btn-consent-close, button[data-dismiss]").attr("disabled",!1).show(),$(this).find(".content-loading-message-indicator").fadeOut(50,function(){r.find(".main-content").removeClass("tnth-hide")})})})},handlePcaLocalized:function(){return!(!this.subjectId||!this.isSubjectPatient())&&(this.orgTool.getSelectedOrgTopLevelParentOrg(),!!this.settings.LOCALIZED_AFFILIATE_ORG&&void this.modules.tnthAjax.postClinical(this.subjectId,"pca_localized",this.isLocalizedAffiliatedOrg()))},isLocalizedAffiliatedOrg:function(){var e=this.orgTool.getSelectedOrgTopLevelParentOrg();return!!e&&this.orgTool.getOrgName(e)===this.settings.LOCALIZED_AFFILIATE_ORG},updateClinicalSection:function(e){if(!e)return!1;for(var t=e.sort(function(e,t){return t.resource.id-e.resource.id}),n=0;n<t.length;n++){var r=t[n],i=String(r.resource.code.coding[0].display),a=r.resource.valueQuantity.value,o=r.resource.valueQuantity.units,s=1===parseInt(a)&&!o,c=0===parseInt(a)&&!o,d=r.resource.status;"PCa diagnosis"===i?i="pca_diag":"PCa localized diagnosis"===i&&(i="pca_localized");var l=$('div[data-topic="'+i+'"]');l.length>0&&l.fadeIn();var u=$('input:radio[name="'+i+'"]');if(u.length>0&&!u.is(":checked")){if("unknown"===String(d)?u.filter('[data-status="unknown"]').prop("checked",!0):u.filter("[value="+a+"]").not("[data-status='unknown']").prop("checked",!0),s?u.filter("[value=true]").prop("checked",!0):c&&u.filter("[value=false]").prop("checked",!0),"biopsy"===i)if("true"===String(a)||s){if(r.resource.issued){var h=this.modules.tnthDates.formatDateString(r.resource.issued,"iso-short"),p=h.split("-");$("#biopsyDate").val(h),$("#biopsy_year").val(p[0]),$("#biopsy_month").val(p[1]),$("#biopsy_day").val(p[2]),$("#biopsyDateContainer").show()}}else $("#biopsyDate").val(""),$("#biopsyDateContainer").hide();("true"===String(a)||s)&&u.parents(".pat-q").next().fadeIn(150)}}},updateTreatment:function(e){var t=this.modules.tnthAjax.hasTreatment(e);if(t){var n=String(t)===String(this.modules.SYSTEM_IDENTIFIER_ENUM.CANCER_TREATMENT_CODE);$("#tx_yes").prop("checked",n),$("#tx_no").prop("checked",!n)}},onBeforeInitClinicalQuestionsSection:function(){if("profile"!==this.mode)return!1;this.isProxy()||$("#clinicalQuestionsContainer .profile-item-edit-btn").removeClass("tnth-hide"),$("#patientQ").show(),$("#patTx").remove(),$("#patientQ hr").hide(),$(".pat-q input:radio").off("click").on("click",function(){var e=$(this),t=e.attr("name"),n=e.val();"true"===String(n)||"pca_localized"===String(t)?e.parents(".pat-q").nextAll().fadeIn():e.parents(".pat-q").nextAll().fadeOut()});var e=$("#pca_diag_yes");e.is(":checked")?e.parents(".pat-q").nextAll().fadeIn():e.parents(".pat-q").nextAll().fadeOut(),this.fillSectionView("clinical")},initClinicalQuestionsSection:function(){if(!this.subjectId)return!1;var e=this;e.modules.tnthAjax.getTreatment(e.subjectId,{useWorker:!0},function(t){e.updateTreatment(t),e.modules.tnthAjax.getClinical(e.subjectId,{useWorker:!0,data:{patch_dstu2:!0}},function(t){e.updateClinicalSection(t.entry),$("#patientQ").attr("loaded","true"),e.onBeforeInitClinicalQuestionsSection(),$("#patientQ [name='biopsy']").on("click",function(){var t=String($(this).val()),n=$("#biopsyDate").val(),r=$(this),i=e.subjectId,a=r.attr("name")||r.attr("data-name"),o=$("#patientQ"),s=["pca_diag","pca_localized","tx"];"true"===t?($("#biopsyDateContainer").show(),$("#biopsyDate").attr("skipped","false"),s.forEach(function(e){$("#patientQ input[name='"+e+"']").attr("skipped","false")}),n?setTimeout(function(){e.modules.tnthAjax.postClinical(i,a,t,"",o,{issuedDate:n})},50):$("#biopsy_day").focus()):($("#biopsyDate").attr("skipped","true"),$("#biopsyDate, #biopsy_day, #biopsy_month, #biopsy_year").val(""),$("#biopsyDateError").text(""),$("#biopsyDateContainer").hide(),s.forEach(function(e){var t=$("#patientQ input[name='"+e+"']");t.prop("checked",!1),t.attr("skipped","true")}),setTimeout(function(){e.modules.tnthAjax.postClinical(i,a,"false",r.attr("data-status"),o),e.modules.tnthAjax.postClinical(i,"pca_diag","false","",o),e.modules.tnthAjax.postClinical(i,"pca_localized","false","",o),e.modules.tnthAjax.deleteTreatment(i)},50))}),e.__convertToNumericField($("#biopsy_day, #biopsy_year")),$("#biopsy_day, #biopsy_month, #biopsy_year").on("change",function(){var t=$("#biopsy_day"),n=$("#biopsy_month"),r=$("#biopsy_year");if(!r.get(0).validity.valid||!n.get(0).validity.valid||!t.get(0).validity.valid)return!1;e.modules.tnthDates.validateDateInputFields(n.val(),t.val(),r.val(),"biopsyDateError")?($("#biopsyDate").val(r.val()+"-"+n.val()+"-"+t.val()),$("#biopsyDateError").text("").hide(),$("#biopsy_yes").trigger("click")):$("#biopsyDate").val("")}),$("#patientQ input[name='tx']").on("click",function(){e.modules.tnthAjax.postTreatment(e.subjectId,"true"===String($(this).val()),"",$("#patientQ"))}),$("#patientQ input[name='pca_localized']").on("click",function(){var t=$(this);setTimeout(function(){e.modules.tnthAjax.postClinical(e.subjectId,t.attr("name"),t.val(),t.attr("data-status"),$("#patientQ"))},50)}),$("#patientQ input[name='pca_diag']").on("click",function(){var t=String($(this).val()),n=e.subjectId,r=$(this),i=$("#patientQ");setTimeout(function(){e.modules.tnthAjax.postClinical(n,r.attr("name"),t,r.attr("data-status"),i)},50),"true"!==t&&(["pca_localized","tx"].forEach(function(e){var t=$("#patientQ input[name='"+e+"']");t.prop("checked",!1),t.attr("skipped","true")}),setTimeout(function(){e.modules.tnthAjax.postClinical(n,"pca_localized","false","",i),e.modules.tnthAjax.deleteTreatment(n)},50))})})})},initProcedureSection:function(){s.a.initViaTemplate()},manualEntryModalVis:function(e){this.manualEntry.loading=!!e},continueToAssessment:function(e,t,n){if(!n)return this.manualEntry.errorMessage=i18next.t("The user does not have a valid assessment link."),!1;var r=!1,i=this.subjectId;this.modules.tnthAjax.getStillNeededCoreData(i,!0,function(e){r=e&&e.still_needed&&e.still_needed.length},e),/\?/.test(n)?n+="&entry_method="+e:n+="?entry_method="+e,"paper"===e&&(n+="&authored="+t);var a=n;r&&(a="/website-consent-script/"+$("#manualEntrySubjectId").val()+"?entry_method="+e+"&subject_id="+$("#manualEntrySubjectId").val()+"&redirect_url="+encodeURIComponent(n)),this.manualEntryModalVis(!0),window.location=a,setTimeout(function(e){(e=e||function(){})&&e()},1e3,this.manualEntryModalVis)},initCustomPatientDetailSection:function(){var e=this.subjectId,t=this;$(window).on("beforeunload",function(){-1!==navigator.userAgent.indexOf("Safari")&&-1===navigator.userAgent.indexOf("Chrome")&&(t.manualEntry.loading=!1,$("#manualEntryModal").modal("hide"))}),$("#manualEntryModal").on("show.bs.modal",function(){t.manualEntry.initloading=!0}),$("#manualEntryModal").on("shown.bs.modal",function(){t.manualEntry.errorMessage="",t.manualEntry.method="",t.manualEntry.todayObj=t.modules.tnthDates.getTodayDateObj(),t.manualEntry.completionDate=t.manualEntry.todayObj.gmtDate,t.modules.tnthAjax.getConsent(e,{sync:!0},function(e){var n;if(!e||!e.consent_agreements||0===e.consent_agreements.length)return!1;n=e.consent_agreements.sort(function(e,t){return new Date(t.acceptance_date)-new Date(e.acceptance_date)});var r=$.grep(n,function(e){return!e.deleted&&"consented"===String(e.status)});r.length>0&&(t.manualEntry.consentDate=r[0].acceptance_date)}),setTimeout(function(){t.manualEntry.initloading=!1},10)}),$("input[name='entryMethod']").on("click",function(){t.manualEntry.errorMessage="",t.manualEntry.method=$(this).val(),"interview_assisted"===$(this).val()&&(t.manualEntry.todayObj=t.modules.tnthDates.getTodayDateObj(),t.manualEntry.completionDate=t.manualEntry.todayObj.gmtDate)}),t.__convertToNumericField($("#qCompletionDay, #qCompletionYear")),["qCompletionDay","qCompletionMonth","qCompletionYear"].forEach(function(e){var n=$("#"+e),r=t.modules.tnthDates;n.on("change",function(){var e=$("#qCompletionDay"),n=$("#qCompletionMonth"),i=$("#qCompletionYear"),a=r.getTodayDateObj(),o=(a.displayDay,a.displayMonth,a.displayYear,""!==e.val()&&""!==n.val()&&""!==i.val()&&e.get(0).validity.valid&&n.get(0).validity.valid&&i.get(0).validity.valid);if(o||$("#meSubmit").attr("disabled",!0),o){var s=r.dateValidator(e.val(),n.val(),i.val()),c=$("#manualEntryConsentDate").val();if(s||!c)return t.manualEntry.errorMessage=i18next.t("All date fields are required"),!1;var d=r.getDateObj(i.val(),n.val(),e.val(),12,0,0);t.manualEntry.completionDate=t.modules.tnthDates.getDateWithTimeZone(d);var l=new Date(t.manualEntry.completionDate),u=new Date(t.manualEntry.consentDate),h=new Date(t.manualEntry.todayObj.gmtDate),p=l.setHours(0,0,0,0),m=u.setHours(0,0,0,0),f=h.setHours(0,0,0,0);p<m&&(s=i18next.t("Completion date cannot be before consent date.")),m>=f?p>m&&(s=i18next.t("Completion date cannot be in the future.")):p>f&&(s=i18next.t("Completion date cannot be in the future.")),t.manualEntry.errorMessage=s}})}),$(document).delegate("#meSubmit","click",function(){var n=String(t.manualEntry.method),r=t.modules.tnthDates.formatDateString(t.manualEntry.completionDate,"system"),i="/api/present-needed?subject_id="+$("#manualEntrySubjectId").val();return""!==n&&("paper"!==n?(t.continueToAssessment(n,r,i),!1):(t.manualEntryModalVis(!0),void t.modules.tnthAjax.getCurrentQB(e,r,null,function(e){if(e.error)return t.manualEntry.errorMessage=i18next.t("Server error occurred checking questionnaire window"),t.manualEntryModalVis(),!1;e.questionnaire_bank&&Object.keys(e.questionnaire_bank).length>0?(t.manualEntry.errorMessage="",t.continueToAssessment(n,r,i)):(t.manualEntry.errorMessage=i18next.t("Invalid completion date. Date of completion is outside the days allowed."),t.manualEntryModalVis())})))}),t.modules.tnthAjax.assessmentStatus(e,function(e){e.error||"COMPLETED"!==e.assessment_status.toUpperCase()||0!==parseInt(e.outstanding_indefinite_work)||($("#assessmentLink").attr("disabled",!0),$("#enterManualInfoContainer").text(i18next.t("All available questionnaires have been completed.")))})},updateRolesData:function(e){var t=$("#rolesGroup input:checkbox:checked").map(function(){return{name:$(this).val()}}).get();this.modules.tnthAjax.putRoles(this.subjectId,{roles:t},$(e.target))},initUserRoles:function(e){if(!this.subjectId)return!1;var t=this;this.modules.tnthAjax.getRoles(this.subjectId,function(e){e.roles&&(t.userRoles=e.roles.map(function(e){return e.name}))},e)},initRolesListSection:function(){var e=this;this.modules.tnthAjax.getRoleList({useWorker:!0},function(t){if(!t.roles)return!1;e.roles.data=t.roles}),e.initUserRoles()},initAuditLogSection:function(){var e=this;this.modules.tnthAjax.auditLog(this.subjectId,{useWorker:!0},function(t){if(t.error)return $("#profileAuditLogErrorMessage").text(i18next.t("Problem retrieving audit log from server.")),!1;if(!t.audits||0===t.audits.length)return $("#profileAuditLogErrorMessage").text(i18next.t("No audit log item found.")),!1;var n=$(window).width(),r=[],i=n<650?20:n<800?40:80;t.audits.forEach(function(t){t.by=t.by.reference||"-";var n=/\d+/g.exec(String(t.by));n&&(t.by=n[0]),t.lastUpdated=e.modules.tnthDates.formatDateString(t.lastUpdated,"iso"),t.comment=t.comment?e.escapeHtml(t.comment):"";var a=String(t.comment);t.comment=a.length>i?a.substring(0,i+1)+"<span class='second hide'>"+a.substr(i+1)+"</span><br/><sub onclick='{showText}' class='pointer text-muted'>"+i18next.t("More...")+"</sub>":t.comment,t.comment=t.comment.replace("{showText}",'(function (obj) {if (obj) {var f = $(obj).parent().find(".second"); f.toggleClass("hide"); $(obj).text($(obj).text() === i18next.t("More...") ? i18next.t("Less..."): i18next.t("More...")); }  })(this) '),r.push(t)}),$("#profileAuditLogTable").bootstrapTable(e.setBootstrapTableConfig({data:r,classes:"table table-responsive profile-audit-log",sortName:"lastUpdated",sortOrder:"desc",toolbar:"#auditTableToolBar",columns:[{field:"by",title:i18next.t("User"),width:"5%",sortable:!0,searchable:!0},{field:"comment",title:i18next.t("Comment"),searchable:!0,sortable:!0},{field:"lastUpdated",title:i18next.t("Date/Time <span class='gmt'>{gmt}</span>").replace("{gmt}","(GMT), Y-M-D"),sortable:!0,searchable:!0,width:"20%"},{field:"version",title:i18next.t("Version"),sortable:!0,visible:!1}]}))})},getConsentHeaderRow:function(e){var t="";return(e||this.consent.consentHeaderArray).forEach(function(e){"n/a"!==String(e)&&(t+="<TH class='consentlist-header'>"+e+"</TH>")}),t},getConsentEditDisplayIconHTML:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return'&nbsp;&nbsp;<a data-toggle="modal" data-target="#'.concat(t,'" data-orgId="').concat(e.organization_id,'" data-agreementUrl="').concat(e.agreement_url,'" data-userId="').concat(this.subjectId,'" data-status="').concat(this.getConsentStatusHTMLObj(e).statusText,'" data-signed-date="').concat(this.modules.tnthDates.formatDateString(e.acceptance_date,"system"),'"><span class="glyphicon glyphicon-pencil edit-icon" aria-hidden="true"></span></a>')},getLREditIconHTML:function(e){var t=this.getOrgTool().getTopLevelParentOrg(e.organization_id),n=$("#"+t+"_editor_url");if(!n.val())return"";var r="true"===String(n.attr("data-show"));return'<div class="button--LR" data-show="'.concat(r,'"><a href="').concat(n.val(),'" target="_blank">').concat(i18next.t("Edit in Liferay"),"</a></div>")},isConsentStatusEditable:function(e){return this.isConsentEditable()&&"active"===String(this.getConsentStatus(e))},isConsentDateEditable:function(e){return this.isTestEnvironment()&&!this.isSubjectPatient()||this.isConsentStatusEditable(e)&&this.isSubjectPatient()&&this.isStaff()},getConsentRow:function(e){if(!e)return!1;var t=this,n=t.getConsentStatusHTMLObj(e).statusHTML,r=[{content:t.getConsentOrgDisplayName(e)},{content:n+(t.isConsentStatusEditable(e)?t.getConsentEditDisplayIconHTML(e,"profileConsentListModal"):""),_class:"indent"},{content:function(e){var n='<span class="agreement">&nbsp;&nbsp;<a href="'.concat(decodeURIComponent(e.agreement_url),'" target="_blank"><em>').concat(i18next.t("View"),"</em></a></span>"),r=n+t.getLREditIconHTML(e);return t.isDefaultConsent(e)&&(r=i18next.t("Sharing information with clinics")+n),r}(e)},{content:t.modules.tnthDates.formatDateString(e.acceptance_date)+(t.isConsentDateEditable(e)?t.getConsentEditDisplayIconHTML(e,"consentDateModal"):"")}];this.consent.consentDisplayRows.push(r)},getConsentHistoryRow:function(e){var t=this.getConsentStatusHTMLObj(e).statusHTML,n="<tr ".concat(e.deleted?"class='history'":"",">");return[{content:"".concat(this.getConsentOrgDisplayName(e),'<div class="smaller-text text-muted">').concat(this.orgTool.getOrgName(e.organization_id),"</div>")},{content:t},{content:this.modules.tnthDates.formatDateString(e.acceptance_date)},{content:'<span class="text-danger">'.concat(this.getRecordedDisplayDate(e)||'<span class="text-muted">--</span>',"</span>")},{content:e.recorded&&e.recorded.by&&e.recorded.by.display?e.recorded.by.display:"<span class='text-muted'>--</span>"}].forEach(function(e){n+='<td class="consentlist-cell">'.concat(e.content,"</td>")}),n+="</tr>"},getConsentOrgDisplayName:function(e){if(!e)return"";var t=e.organization_id,n=this.getOrgTool(),r=n.orgsList[t],i=r?r.name:e.organization_id;if(!this.isConsentWithTopLevelOrg()){var a=n.getTopLevelParentOrg(t),o=n.orgsList[a];o&&o.name&&(i=o.name)}return i},getConsentStatus:function(e){return(e=e||{}).deleted||"deleted"===String(e.status)?"deleted":e.expired&&this.modules.tnthDates.getDateDiff(String(e.expires))>0?"expired":"active"},getRecordedDisplayDate:function(e){if(!e)return"";var t=e.recorded?e.recorded.lastUpdated:"";return this.modules.tnthDates.formatDateString(t,"yyyy-mm-dd hh:mm:ss")},isDefaultConsent:function(e){return e&&/stock\-org\-consent/.test(e.agreement_url)},getConsentStatusHTMLObj:function(e){var t=this.getConsentStatus(e),n="",r="",i=e.staff_editable,a=e.send_reminders,o=e.include_in_reports,s=this.consent.consentLabels,c={default:"<span class='text-success small-text'>".concat(s.default,"</span>"),consented:"<span class='text-success small-text'>".concat(s.consented,"</span>"),withdrawn:"<span class='text-warning small-text withdrawn-label'>".concat(s.withdrawn,"</span>"),deleted:"<span class='text-danger small-text'>".concat(s.deleted,"</span>"),purged:"<span class='text-danger small-text'>".concat(s.purged,"</span>"),expired:"<span class='text-warning'>&#10007; <br><span>(".concat(i18next.t("expired"),"</span>")};switch(t){case"deleted":n=i&&a&&o?c.consented:i&&o&&!a||!i&&o&&!a?c.withdrawn:i||o||a?c.consented:c.purged,"deleted"===String(e.status)&&(n+='<span class="text-danger"> (</span>'.concat(c.deleted,'<span class="text-danger">)</span>'));break;case"expired":n=c.expired;break;case"active":switch(e.status){case"consented":n=this.isDefaultConsent(e)?c.default:c.consented,r="consented";break;case"suspended":n=c.withdrawn,r="suspended";break;case"deleted":n=c.purged,r="purged";break;default:n=c.consented,r="consented"}}return{statusText:r||t,statusHTML:n}},getTerms:function(){if(this.consent.touObj.length>0)return this.consent.touObj;var e=this,t=this.getOrgTool().getOrgsList(),n=e.modules.i18next,r=function(e){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})};e.modules.tnthAjax.getTerms(this.subjectId,"",!0,function(i){i&&i.tous&&i.tous.forEach(function(i){var a=$.trim(i.type).toLowerCase(),o=t[i.organization_id];-1!==["subject website consent","website terms of use"].indexOf(String(a))&&(i.name=o&&o.name?n.t(o.name):"--",i.truenth_name=n.t("TrueNTH USA"),i.accepted=e.modules.tnthDates.formatDateString(i.accepted),i.display_type=r($.trim(i.type.toLowerCase().replace("subject",""))),i.eproms_agreement_text=String(n.t("Agreed to {documentType}")).replace("{documentType}",r(i.display_type)),i.truenth_agreement_text=n.t("Agreed to terms"),i.eproms_url_text=n.t(i.display_type),i.truenth_url_text=String(n.t("{projectName} Terms of Use")).replace("{projectName}","TrueNTH USA"),i.view=n.t("View"),i.type=a,e.consent.touObj.push(i))})}),e.consent.showInitialConsentTerms=e.consent.touObj.length>0},initConsentItemEvent:function(){var e=this;$("#profileConsentListModal").on("show.bs.modal",function(t){var n=$(t.relatedTarget),r=$(t.relatedTarget).attr("data-orgId"),i=n.attr("data-agreementUrl"),a=n.attr("data-userId"),o=n.attr("data-status");$(this).find("input[class='radio_consent_input']").each(function(){$(this).attr({"data-agreementUrl":i,"data-userId":a,"data-orgId":r}),String($(this).val())===String(o)&&$(this).prop("checked",!0)}),e.isAdmin()&&$(this).find(".admin-radio").show()}),$("#profileConsentListModal input[class='radio_consent_input']").each(function(){$(this).off("click").on("click",function(){var t=e.CONSENT_ENUM[$(this).val()];if(e.consent.saveLoading=!0,t&&(t.org=$(this).attr("data-orgId"),t.agreementUrl=$(this).attr("data-agreementUrl")),"purged"===String($(this).val()))e.modules.tnthAjax.deleteConsent($(this).attr("data-userId"),{org:$(this).attr("data-orgId")}),e.consent.saveLoading=!1,e.reloadConsentList($(this).attr("data-userId"));else if("suspended"===String($(this).val())){var n=$("#profileConsentListModal"),r=$(this);e.modules.tnthAjax.withdrawConsent($(this).attr("data-userId"),$(this).attr("data-orgId"),null,function(t){n.removeClass("fade").modal("hide"),e.consent.saveLoading=!1,e.reloadConsentList(r.attr("data-userId"))})}else r=$(this),e.modules.tnthAjax.setConsent($(this).attr("data-userId"),t,$(this).val(),!1,function(t){$("#profileConsentListModal").removeClass("fade").modal("hide"),e.consent.saveLoading=!1,e.reloadConsentList(r.attr("data-userId"))})})})},initConsentDateEvents:function(){var e=new Date,t=this;$("#consentDateModal").on("shown.bs.modal",function(e){$(this).find(".consent-date").focus(),$(this).addClass("active");var n=$(e.relatedTarget),r=n.attr("data-orgId"),i=n.attr("data-agreementUrl"),a=n.attr("data-userId"),o=n.attr("data-status");$(this).find(".data-current-consent-date").text(t.modules.tnthDates.formatDateString(n.attr("data-signed-date"),"d M y hh:mm:ss")),$(this).find("input.form-control").each(function(){$(this).attr({"data-agreementUrl":i,"data-userId":a,"data-orgId":r,"data-status":o}),$(this).attr("data-default-value")?$(this).val($(this).attr("data-default-value")):$(this).val("")}),$("#consentDateModal [data-dismiss]").on("click",function(){$(this).modal("hide")}),$("#consentDateContainer").show(),$("#consentDateLoader").hide(),$("#consentDateModalError").html("")}),$("#consentDateModal").on("hidden.bs.modal",function(){$(this).removeClass("active")}),$("#consentDateModal .consent-date").datepicker({format:"d M yyyy",forceParse:!1,endDate:e,autoclose:!0}),$("#consentDateModal .consent-hour, #consentDateModal .consent-minute, #consentDateModal .consent-second").each(function(){t.__convertToNumericField($(this))}),$("#consentDateModal .consent-date, #consentDateModal .consent-hour, #consentDateModal .consent-minute, #consentDateModal .consent-second").each(function(){$(this).on("change",function(){var e=$("#consentDateModal_date"),n=$("#consentDateModal_hour").val(),r=$("#consentDateModal_minute").val(),i=$("#consentDateModal_second").val(),a="",o=t.modules.tnthDates.isValidDefaultDateFormat(e.val());e.val()&&!o&&(a+=(a?"<br/>":"")+i18next.t("Date must in the valid format."),e.datepicker("hide")),n&&!/^([1-9]|0[0-9]|1\d|2[0-3])$/.test(n)&&(a+=(a?"<br/>":"")+i18next.t("Hour must be in valid format, range 0 to 23.")),r&&!/^(0[0-9]|[1-9]|[1-5]\d)$/.test(r)&&(a+=(a?"<br/>":"")+i18next.t("Minute must be in valid format, range 0 to 59.")),i&&!/^(0[0-9]|[1-9]|[1-5]\d)$/.test(i)&&(a+=(a?"<br/>":"")+i18next.t("Second must be in valid format, range 0 to 59.")),$("#consentDateModalError").html(a)})}),$("#consentDateModal .btn-submit").on("click",function(){var e=$("#consentDateModal_date"),n=t.CONSENT_ENUM[e.attr("data-status")];if(!e.val())return $("#consentDateModalError").text(i18next.t("You must enter a date/time")),!1;var r=$("#consentDateModal_hour").val()||"00",i=$("#consentDateModal_minute").val()||"00",a=$("#consentDateModal_second").val()||"00",o=new Date(e.val()),s=o.getFullYear()+"-"+(o.getMonth()+1)+"-"+o.getDate()+"T"+t.pad(r)+":"+t.pad(i)+":"+t.pad(a);n.org=e.attr("data-orgId"),n.agreementUrl=e.attr("data-agreementUrl"),n.acceptance_date=s,n.testPatient=!0,setTimeout(void $("#consentDateContainer").hide(),200),setTimeout(void $("#consentDateLoader").show(),450),$("#consentDateModal button[data-dismiss]").attr("disabled",!0),setTimeout(t.modules.tnthAjax.setConsent(e.attr("data-userId"),n,e.attr("data-status"),!0,function(n){if(!n||n.error)return $("#consentDateModalError").text(i18next.t("Error processing data.  Make sure the date is in the correct format.")),setTimeout(function(){$("#consentDateContainer").show(),$("#consentDateModal button[data-dismiss]").attr("disabled",!1),$("#consentDateLoader").hide()},450),!1;$("#consentDateModal button[data-dismiss]").attr("disabled",!1),$("#consentDateModal").removeClass("fade").modal("hide"),t.reloadConsentList(e.attr("data-userId"))}),100)})},showConsentHistory:function(){return!this.consent.consentLoading&&this.isConsentEditable()&&this.hasConsentHistory()},hasConsentHistory:function(){return this.consent.historyItems.length>0},hasCurrentConsent:function(){return this.consent.currentItems.length>0},getConsentHistory:function(e){e||(e={});var t=this,n="";n="<div id='consentHistoryWrapper'><table id='consentHistoryTable' class='table-bordered table-condensed table-responsive' style='width: 100%; max-width:100%'>",n+=this.getConsentHeaderRow(this.consent.consentHistoryHeaderArray),this.consent.historyItems.sort(function(e,t){return new Date(t.deleted.lastUpdated)-new Date(e.deleted.lastUpdated)}),this.consent.currentItems.concat(this.consent.historyItems).forEach(function(e,r){n+=t.getConsentHistoryRow(e,r)}),n+="</table></div>",$("#consentHistoryModal .modal-body").html(n),$("#consentHistoryModal").modal("show")},reloadConsentList:function(e){var t=this;$("#consentListTable").animate({opacity:0},function(){t.consent.consentLoading=!0,setTimeout(function(){t.modules.tnthAjax.getConsent(e||t.subjectId,{sync:!0},function(e){t.getConsentList(e)})},1500)})},getConsentList:function(e){if(!e)return!1;if(e.error)return this.consent.consentListErrorMessage=i18next.t("Error occurred retrieving consent list content."),this.consent.consentLoading=!1,!1;this.getTerms();var t=this,n=[];if(e.consent_agreements&&e.consent_agreements.length>0&&(n=e.consent_agreements),this.consent.consentItems=n,this.consent.consentDisplayRows=[],0===this.consent.consentItems.length)return clearInterval(t.consentListReadyIntervalId),$("#consentListTable").animate({opacity:1}),this.consent.consentLoading=!1,!1;var r={};this.consent.currentItems=$.grep(this.consent.consentItems,function(e){return"active"===t.getConsentStatus(e)}),this.consent.historyItems=$.grep(this.consent.consentItems,function(e){return"active"!==t.getConsentStatus(e)}),this.consent.currentItems.forEach(function(e,n){r[e.organization_id]||/null/.test(e.agreement_url)||(t.getConsentRow(e,n),r[e.organization_id]=!0)}),clearInterval(this.consentListReadyIntervalId),this.consentListReadyIntervalId=setInterval(function(){$("#consentListTable .consentlist-cell").length>0&&($("#consentListTable .button--LR[show='true']").addClass("show"),$("#consentListTable tbody tr").each(function(e){$(this).addClass(e%2!=0?"even":"odd")}),t.isConsentWithTopLevelOrg()||$("#consentListTable .agreement").each(function(){$(this).parent().hide()}),t.isConsentEditable()&&(t.initConsentItemEvent(),t.initConsentDateEvents()),$("#consentListTable").animate({opacity:1},1500),clearInterval(t.consentListReadyIntervalId)),t.showConsentHistory()&&($("#viewConsentHistoryButton").on("click",function(e){e.preventDefault(),e.stopImmediatePropagation(),t.getConsentHistory()}),setTimeout(function(){$("#viewConsentHistoryButton").removeClass("tnth-hide")},550))},50),this.consent.consentLoading=!1},pad:function(e){return(e=parseInt(e))<10?"0"+e:e},__convertToNumericField:function(e){e&&("ontouchstart"in window||void 0!==window.DocumentTouch&&document instanceof window.DocumentTouch)&&e.each(function(){$(this).prop("type","tel")})},escapeHtml:function(e){return null===e||"undefined"!==e||0===String(e).length?e:e.replace(/[\"&'\/<>]/g,function(e){return{'"':"&quot;","&":"&amp;","'":"&#39;","/":"&#47;","<":"&lt;",">":"&gt;"}[e]})}}})}]);
//# sourceMappingURL=../../maps/profile.bundle.js.map